<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚀 Importador Inteligente v2.0 - Auto-Correção de Formato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.4s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .pulse-success { animation: pulseSuccess 2s infinite; }
        @keyframes pulseSuccess { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 50% { box-shadow: 0 0 20px 10px rgba(16, 185, 129, 0); } }
        .code-block { 
            font-family: 'Courier New', monospace; 
            background: #1e293b; 
            color: #e2e8f0; 
            border-radius: 8px; 
            padding: 16px; 
            overflow-x: auto;
            max-height: 400px;
        }
        .keyword { color: #c792ea; }
        .string { color: #c3e88d; }
        .number { color: #f78c6c; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 min-h-screen">
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Header Super Moderno -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-2xl p-8 mb-8 text-white">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <i class="fas fa-robot text-5xl animate-bounce"></i>
                        <div>
                            <h1 class="text-4xl font-black">Importador Inteligente v2.0</h1>
                            <p class="text-indigo-200 text-lg">🎯 Auto-Correção + Conversão de Formato + Código Pronto</p>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="bg-white/20 backdrop-blur-sm rounded-lg px-4 py-2">
                        <div class="text-sm opacity-90">Black Friday 2025</div>
                        <div class="text-2xl font-bold">Yoobe</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Novo: Status do Processo -->
        <div id="statusProcess" class="bg-white rounded-xl shadow-lg p-6 mb-8 fade-in" style="display: none;">
            <div class="flex items-center gap-4">
                <div class="animate-spin text-4xl text-indigo-600">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-800" id="statusTitle">Processando...</h3>
                    <p class="text-gray-600" id="statusMessage">Aguarde enquanto convertemos o formato</p>
                    <div class="mt-2 bg-gray-200 rounded-full h-2 overflow-hidden">
                        <div id="progressBar" class="bg-indigo-600 h-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Upload Modernizada -->
        <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                <i class="fas fa-upload text-indigo-600 text-4xl"></i>
                <span>Passo 1: Carregar JSON (Qualquer Formato)</span>
            </h2>
            
            <div class="border-4 border-dashed border-indigo-300 rounded-2xl p-16 text-center hover:border-indigo-600 hover:bg-indigo-50 transition-all cursor-pointer" id="dropZone">
                <input type="file" id="fileInput" accept=".json" class="hidden">
                <i class="fas fa-cloud-upload-alt text-8xl text-indigo-400 mb-6"></i>
                <h3 class="text-2xl font-bold text-gray-700 mb-3">Arraste seu JSON aqui</h3>
                <p class="text-gray-500 mb-6 text-lg">Aceita QUALQUER formato - o sistema converte automaticamente! ✨</p>
                <button onclick="document.getElementById('fileInput').click()" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg">
                    <i class="fas fa-folder-open mr-2"></i>
                    Escolher Arquivo JSON
                </button>
                <div class="mt-6 flex gap-2 justify-center text-sm text-gray-500">
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full">✅ Formato Complexo</span>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full">✅ Formato Simples</span>
                    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full">✅ Template Original</span>
                </div>
            </div>
        </div>

        <!-- Preview dos Produtos Convertidos -->
        <div id="previewSection" style="display: none;">
            
            <!-- Resumo da Conversão -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-2xl shadow-2xl p-8 mb-8 text-white pulse-success">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-black mb-2 flex items-center gap-3">
                            <i class="fas fa-check-circle text-5xl"></i>
                            Conversão Concluída com Sucesso!
                        </h2>
                        <p class="text-lg text-green-100">Formato detectado e corrigido automaticamente</p>
                    </div>
                    <div class="text-right">
                        <div class="text-6xl font-black" id="totalProdutosConvertidos">0</div>
                        <div class="text-xl">produtos prontos</div>
                    </div>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                    <div class="text-sm text-gray-600 font-semibold">TOTAL PRODUTOS</div>
                    <div class="text-4xl font-black text-gray-800" id="statTotal">0</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                    <div class="text-sm text-green-700 font-semibold">✅ COMPETITIVOS</div>
                    <div class="text-4xl font-black text-green-600" id="statCompetitivos">0</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                    <div class="text-sm text-purple-700 font-semibold">💰 INVESTIMENTO</div>
                    <div class="text-3xl font-black text-purple-600" id="statInvestimento">R$ 0</div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-indigo-500">
                    <div class="text-sm text-indigo-700 font-semibold">💎 LUCRO ESTIMADO</div>
                    <div class="text-3xl font-black text-indigo-600" id="statLucro">R$ 0</div>
                </div>
            </div>

            <!-- Preview dos Produtos -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-eye text-indigo-600 text-4xl"></i>
                    <span>Passo 2: Preview dos Produtos</span>
                </h2>
                <div id="produtosList" class="space-y-4 max-h-96 overflow-y-auto"></div>
            </div>

            <!-- Código Gerado -->
            <div class="bg-white rounded-2xl shadow-2xl p-8 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                        <i class="fas fa-code text-indigo-600 text-4xl"></i>
                        <span>Passo 3: Código JavaScript Pronto</span>
                    </h2>
                    <button onclick="copiarCodigo()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white px-6 py-3 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg">
                        <i class="fas fa-copy mr-2"></i>
                        Copiar Código
                    </button>
                </div>
                
                <div class="bg-gray-800 rounded-xl p-6 mb-4">
                    <div class="flex items-center gap-3 mb-4 text-gray-300">
                        <i class="fas fa-info-circle"></i>
                        <p class="text-sm">Cole este código <strong>DENTRO</strong> do array <code class="bg-gray-700 px-2 py-1 rounded">produtosBF</code> no arquivo <code class="bg-gray-700 px-2 py-1 rounded">produtos-v6.1.js</code></p>
                    </div>
                </div>

                <pre id="codigoGerado" class="code-block">// Aguardando conversão...</pre>
                
                <div class="mt-6 bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                    <h3 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                        <i class="fas fa-lightbulb"></i>
                        Como usar:
                    </h3>
                    <ol class="list-decimal list-inside text-blue-800 space-y-2">
                        <li>Clique em <strong>"Copiar Código"</strong> acima</li>
                        <li>Abra o arquivo <code class="bg-blue-100 px-2 py-1 rounded">produtos-v6.1.js</code></li>
                        <li>Encontre o array <code class="bg-blue-100 px-2 py-1 rounded">const produtosBF = [...]</code></li>
                        <li>Cole o código <strong>DENTRO</strong> do array, antes do <code class="bg-blue-100 px-2 py-1 rounded">]</code> final</li>
                        <li>Salve o arquivo e recarregue a página!</li>
                    </ol>
                </div>
            </div>

            <!-- Botão de Download -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl shadow-2xl p-8 text-white text-center">
                <h3 class="text-2xl font-bold mb-4">Ou baixe o arquivo pronto:</h3>
                <button onclick="baixarArquivoJS()" class="bg-white text-indigo-600 px-8 py-4 rounded-xl font-bold text-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-2xl">
                    <i class="fas fa-download mr-2"></i>
                    Baixar produtos-novos-yoobe.js
                </button>
            </div>

        </div>

    </div>

    <script>
        let produtosConvertidos = [];
        let codigoJSFinal = '';

        // ============================================
        // CONVERSOR AUTOMÁTICO DE FORMATO
        // ============================================
        function converterProduto(produtoOriginal) {
            // Detecta qual formato é o JSON de entrada
            
            // CASO 1: Formato complexo (com melhor_oferta, estrategia_yoobe, etc)
            if (produtoOriginal.melhor_oferta && produtoOriginal.estrategia_yoobe) {
                const custoBase = produtoOriginal.estrategia_yoobe?.custo_compra || produtoOriginal.melhor_oferta?.preco_compra || 0;
                const precoVenda = produtoOriginal.estrategia_yoobe?.preco_venda_yoobe || 0;
                const margem = produtoOriginal.estrategia_yoobe?.margem_lucro_percentual || (precoVenda > 0 && custoBase > 0 ? Math.round(((precoVenda - custoBase) / custoBase) * 100) : 25);
                const estoque = produtoOriginal.status_importacao?.estoque_inicial || 0;
                
                return {
                    id: produtoOriginal.sku.toLowerCase(),
                    sku: produtoOriginal.sku,
                    nome: produtoOriginal.nome,
                    descricao: produtoOriginal.modelo || produtoOriginal.marca || produtoOriginal.nome.substring(0, 50),
                    categoria: produtoOriginal.categoria,
                    subcategoria: produtoOriginal.subcategoria,
                    quantidade: estoque,
                    custoBase: custoBase,
                    precoMercado: produtoOriginal.melhor_oferta?.preco_compra || custoBase,
                    margem: margem,
                    preco: precoVenda,
                    precoVenda: precoVenda,
                    precoConcorrente: produtoOriginal.comparacao_prio?.preco_prio || 0,
                    estoque: estoque,
                    fornecedor: produtoOriginal.melhor_oferta?.marketplace || 'amazon',
                    linkCompra: produtoOriginal.melhor_oferta?.link || '',
                    imagem: Array.isArray(produtoOriginal.imagens) ? produtoOriginal.imagens[0] : produtoOriginal.imagens || 'https://via.placeholder.com/400',
                    especificacoes: produtoOriginal.especificacoes || {},
                    tags: produtoOriginal.tags || [],
                    badge: produtoOriginal.badge || undefined
                };
            }
            
            // CASO 2: Formato simples (já na estrutura correta)
            else if (produtoOriginal.id && produtoOriginal.preco) {
                return produtoOriginal; // Já está no formato correto
            }
            
            // CASO 3: Formato intermediário (tem alguns campos mas não todos)
            else {
                const custoBase = produtoOriginal.custoBase || produtoOriginal.precoMercado || 0;
                const precoVenda = produtoOriginal.precoVenda || produtoOriginal.preco || 0;
                const margem = produtoOriginal.margem || (precoVenda > 0 && custoBase > 0 ? Math.round(((precoVenda - custoBase) / custoBase) * 100) : 25);
                const estoque = produtoOriginal.estoque || produtoOriginal.quantidade || 0;
                
                return {
                    id: (produtoOriginal.id || produtoOriginal.sku || 'produto-' + Date.now()).toLowerCase(),
                    sku: produtoOriginal.sku || produtoOriginal.id || 'SKU-' + Date.now(),
                    nome: produtoOriginal.nome || 'Produto sem nome',
                    descricao: produtoOriginal.descricao || produtoOriginal.nome || '',
                    categoria: produtoOriginal.categoria || 'Geral',
                    subcategoria: produtoOriginal.subcategoria || 'Diversos',
                    quantidade: estoque,
                    custoBase: custoBase,
                    precoMercado: produtoOriginal.precoMercado || custoBase,
                    margem: margem,
                    preco: precoVenda,
                    precoVenda: precoVenda,
                    precoConcorrente: produtoOriginal.precoConcorrente || 0,
                    estoque: estoque,
                    fornecedor: produtoOriginal.fornecedor || 'amazon',
                    linkCompra: produtoOriginal.linkCompra || produtoOriginal.link || '',
                    imagem: produtoOriginal.imagem || 'https://via.placeholder.com/400',
                    especificacoes: produtoOriginal.especificacoes || {},
                    tags: produtoOriginal.tags || [],
                    badge: produtoOriginal.badge || undefined
                };
            }
        }

        // ============================================
        // GERAR CÓDIGO JAVASCRIPT
        // ============================================
        function gerarCodigoJS(produtos) {
            let codigo = '// ============================================\n';
            codigo += `// PRODUTOS IMPORTADOS - ${new Date().toLocaleString('pt-BR')}\n`;
            codigo += `// Total: ${produtos.length} produtos\n`;
            codigo += '// ============================================\n\n';
            
            produtos.forEach((p, index) => {
                codigo += `{\n`;
                codigo += `    id: "${p.id}",\n`;
                codigo += `    sku: "${p.sku}",\n`;
                codigo += `    nome: "${p.nome}",\n`;
                codigo += `    descricao: "${p.descricao}",\n`;
                codigo += `    categoria: "${p.categoria}",\n`;
                codigo += `    subcategoria: "${p.subcategoria}",\n`;
                codigo += `    quantidade: ${p.quantidade},\n`;
                codigo += `    custoBase: ${p.custoBase},\n`;
                codigo += `    precoMercado: ${p.precoMercado},\n`;
                codigo += `    margem: ${p.margem},\n`;
                codigo += `    preco: ${p.preco},\n`;
                codigo += `    precoVenda: ${p.precoVenda},\n`;
                codigo += `    precoConcorrente: ${p.precoConcorrente},\n`;
                codigo += `    estoque: ${p.estoque},\n`;
                if (p.badge) {
                    codigo += `    badge: "${p.badge}",\n`;
                }
                codigo += `    fornecedor: "${p.fornecedor}",\n`;
                codigo += `    linkCompra: "${p.linkCompra}",\n`;
                codigo += `    imagem: "${p.imagem}",\n`;
                codigo += `    especificacoes: ${JSON.stringify(p.especificacoes, null, 8)},\n`;
                codigo += `    tags: ${JSON.stringify(p.tags)}\n`;
                codigo += `}${index < produtos.length - 1 ? ',' : ''}\n\n`;
            });
            
            return codigo;
        }

        // ============================================
        // PROCESSAR ARQUIVO
        // ============================================
        function processarArquivo(file) {
            document.getElementById('statusProcess').style.display = 'block';
            document.getElementById('progressBar').style.width = '20%';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    document.getElementById('progressBar').style.width = '40%';
                    const jsonData = JSON.parse(e.target.result);
                    
                    document.getElementById('progressBar').style.width = '60%';
                    const produtos = jsonData.produtos || jsonData;
                    
                    if (!Array.isArray(produtos)) {
                        throw new Error('O JSON deve conter um array "produtos"');
                    }
                    
                    document.getElementById('progressBar').style.width = '80%';
                    // Converter todos os produtos
                    produtosConvertidos = produtos.map(converterProduto);
                    
                    document.getElementById('progressBar').style.width = '100%';
                    
                    setTimeout(() => {
                        document.getElementById('statusProcess').style.display = 'none';
                        mostrarPreview();
                    }, 500);
                    
                } catch (error) {
                    alert('❌ Erro ao processar JSON: ' + error.message);
                    document.getElementById('statusProcess').style.display = 'none';
                }
            };
            reader.readAsText(file);
        }

        // ============================================
        // MOSTRAR PREVIEW
        // ============================================
        function mostrarPreview() {
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
            
            // Estatísticas
            const total = produtosConvertidos.length;
            const competitivos = produtosConvertidos.filter(p => p.precoVenda < p.precoConcorrente).length;
            const investimento = produtosConvertidos.reduce((sum, p) => sum + p.custoBase, 0);
            const receita = produtosConvertidos.reduce((sum, p) => sum + p.precoVenda, 0);
            const lucro = receita - investimento;
            
            document.getElementById('totalProdutosConvertidos').textContent = total;
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCompetitivos').textContent = competitivos;
            document.getElementById('statInvestimento').textContent = 'R$ ' + investimento.toFixed(2);
            document.getElementById('statLucro').textContent = 'R$ ' + lucro.toFixed(2);
            
            // Lista de produtos
            const lista = document.getElementById('produtosList');
            lista.innerHTML = produtosConvertidos.slice(0, 10).map(p => `
                <div class="border-l-4 ${p.precoVenda < p.precoConcorrente ? 'border-green-500 bg-green-50' : 'border-gray-300 bg-gray-50'} rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800">${p.nome}</h3>
                            <p class="text-sm text-gray-600">${p.sku} | ${p.categoria} > ${p.subcategoria}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold ${p.precoVenda < p.precoConcorrente ? 'text-green-600' : 'text-gray-600'}">
                                R$ ${p.precoVenda.toFixed(2)}
                            </div>
                            ${p.precoConcorrente > 0 ? `<div class="text-sm text-gray-500">PRIO: R$ ${p.precoConcorrente.toFixed(2)}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            if (produtosConvertidos.length > 10) {
                lista.innerHTML += `<div class="text-center text-gray-500 italic">... e mais ${produtosConvertidos.length - 10} produtos</div>`;
            }
            
            // Gerar código
            codigoJSFinal = gerarCodigoJS(produtosConvertidos);
            document.getElementById('codigoGerado').textContent = codigoJSFinal;
        }

        // ============================================
        // COPIAR CÓDIGO
        // ============================================
        function copiarCodigo() {
            navigator.clipboard.writeText(codigoJSFinal).then(() => {
                alert('✅ Código copiado! Cole no arquivo produtos-v6.1.js dentro do array produtosBF');
            });
        }

        // ============================================
        // BAIXAR ARQUIVO
        // ============================================
        function baixarArquivoJS() {
            const blob = new Blob([codigoJSFinal], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `produtos-novos-yoobe-${Date.now()}.js`;
            a.click();
        }

        // ============================================
        // EVENTOS
        // ============================================
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                processarArquivo(e.target.files[0]);
            }
        });

        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('click', () => document.getElementById('fileInput').click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-indigo-600', 'bg-indigo-50');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-indigo-600', 'bg-indigo-50');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-indigo-600', 'bg-indigo-50');
            if (e.dataTransfer.files.length > 0) {
                processarArquivo(e.dataTransfer.files[0]);
            }
        });
    </script>

</body>
</html>
