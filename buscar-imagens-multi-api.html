<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Imagens Reais - Multi API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-purple-600 via-purple-700 to-indigo-800 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-3xl shadow-2xl p-8 mb-6">
            <div class="text-center mb-6">
                <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-indigo-600 mb-3">
                    <i class="fas fa-images mr-3"></i>
                    Buscar Imagens Reais dos Produtos
                </h1>
                <p class="text-xl text-gray-600">
                    Sistema Multi-API para extra√ß√£o de imagens de produtos da Amazon, Mercado Livre e outros
                </p>
            </div>

            <!-- Info Panel -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-bold text-blue-900 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    Como Funciona - 3 M√©todos Dispon√≠veis
                </h3>
                
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-white rounded-lg p-4">
                        <div class="text-2xl mb-2">ü§ñ</div>
                        <h4 class="font-bold text-blue-900 mb-2">M√©todo 1: Auto (API)</h4>
                        <p class="text-sm text-gray-700">Usa servi√ßos de scraping (jsonlink.io, microlink.io) para extrair og:image automaticamente</p>
                        <div class="mt-2 text-xs text-green-600 font-semibold">‚úì Mais r√°pido</div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4">
                        <div class="text-2xl mb-2">üîó</div>
                        <h4 class="font-bold text-blue-900 mb-2">M√©todo 2: URL Direta</h4>
                        <p class="text-sm text-gray-700">Constr√≥i URL de imagem Amazon automaticamente a partir do ASIN do produto</p>
                        <div class="mt-2 text-xs text-blue-600 font-semibold">‚úì Para Amazon</div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-4">
                        <div class="text-2xl mb-2">‚úèÔ∏è</div>
                        <h4 class="font-bold text-blue-900 mb-2">M√©todo 3: Manual</h4>
                        <p class="text-sm text-gray-700">Abra o link, copie a URL da imagem e cole manualmente</p>
                        <div class="mt-2 text-xs text-orange-600 font-semibold">‚úì Sempre funciona</div>
                    </div>
                </div>

                <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-3">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Importante:</strong> APIs gratuitas t√™m limite de requisi√ß√µes. Para processar muitos produtos, use em lotes ou insira manualmente.
                    </p>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white text-center shadow-lg">
                    <div class="text-3xl font-bold" id="total-produtos">0</div>
                    <div class="text-sm opacity-90">Total</div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white text-center shadow-lg">
                    <div class="text-3xl font-bold" id="com-imagem">0</div>
                    <div class="text-sm opacity-90">Com Imagem</div>
                </div>
                <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl p-4 text-white text-center shadow-lg">
                    <div class="text-3xl font-bold" id="sem-imagem">0</div>
                    <div class="text-sm opacity-90">Pendentes</div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white text-center shadow-lg">
                    <div class="text-3xl font-bold" id="processadas">0</div>
                    <div class="text-sm opacity-90">Processadas</div>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 text-white text-center shadow-lg">
                    <div class="text-3xl font-bold" id="taxa-sucesso">0%</div>
                    <div class="text-sm opacity-90">Taxa Sucesso</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="grid md:grid-cols-3 gap-4">
                <button onclick="carregarProdutos()" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all transform hover:scale-105">
                    <i class="fas fa-download mr-2"></i>
                    Carregar Produtos
                </button>
                <button onclick="buscarTodasAutomatico()" id="btn-buscar" disabled class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-magic mr-2"></i>
                    Buscar Todas (Auto)
                </button>
                <button onclick="exportarJSON()" id="btn-exportar" disabled class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-file-download mr-2"></i>
                    Exportar JSON
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden bg-white rounded-2xl shadow-xl p-8 text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-4 border-purple-600 mb-4"></div>
            <p class="text-gray-600 text-lg font-medium">Carregando produtos...</p>
        </div>

        <!-- Progress Bar (para busca em lote) -->
        <div id="progress-container" class="hidden bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-700 font-semibold">Processando produtos...</span>
                <span class="text-gray-600" id="progress-text">0 / 0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-gradient-to-r from-purple-600 to-indigo-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <!-- Products Grid -->
        <div id="products-grid" class="space-y-4">
            <!-- Products will be rendered here -->
        </div>
    </div>

    <script src="produtos-v6.1.js"></script>
    <script>
        let produtosCarregados = [];
        let processadas = 0;

        // Verificar se √© placeholder
        function isPlaceholder(url) {
            if (!url) return true;
            const placeholders = ['placeholder', 'via.placeholder', 'placehold.it', 'lorempixel'];
            return placeholders.some(p => url.includes(p));
        }

        // Extrair ASIN da URL Amazon
        function extrairASIN(url) {
            const patterns = [
                /\/dp\/([A-Z0-9]{10})/,
                /\/gp\/product\/([A-Z0-9]{10})/,
                /\/exec\/obidos\/ASIN\/([A-Z0-9]{10})/
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // Gerar URL de imagem Amazon
        function gerarImagemAmazon(asin) {
            // URL de imagem de alta qualidade da Amazon
            return `https://images-na.ssl-images-amazon.com/images/I/${asin}._AC_SL1500_.jpg`;
        }

        // Atualizar estat√≠sticas
        function atualizarEstatisticas() {
            const total = produtosCarregados.length;
            const semImagem = produtosCarregados.filter(p => isPlaceholder(p.imagem)).length;
            const comImagem = total - semImagem;
            const taxaSucesso = total > 0 ? Math.round((comImagem / total) * 100) : 0;
            
            document.getElementById('total-produtos').textContent = total;
            document.getElementById('sem-imagem').textContent = semImagem;
            document.getElementById('com-imagem').textContent = comImagem;
            document.getElementById('processadas').textContent = processadas;
            document.getElementById('taxa-sucesso').textContent = taxaSucesso + '%';
        }

        // Carregar produtos
        function carregarProdutos() {
            document.getElementById('loading').classList.remove('hidden');
            
            setTimeout(() => {
                let todosProdutos = [];
                
                if (typeof produtosPlanilha !== 'undefined') {
                    todosProdutos = todosProdutos.concat(produtosPlanilha);
                }
                
                if (typeof produtosSugeridos !== 'undefined') {
                    todosProdutos = todosProdutos.concat(produtosSugeridos);
                }
                
                produtosCarregados = todosProdutos;
                
                atualizarEstatisticas();
                renderizarProdutos();
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('btn-buscar').disabled = false;
                document.getElementById('btn-exportar').disabled = false;
            }, 500);
        }

        // Renderizar produtos
        function renderizarProdutos() {
            const grid = document.getElementById('products-grid');
            
            grid.innerHTML = produtosCarregados.map((produto, index) => {
                const temImagem = !isPlaceholder(produto.imagem);
                const imagemSrc = temImagem ? produto.imagem : 'https://via.placeholder.com/200x200/6366f1/ffffff?text=Sem+Imagem';
                const isAmazon = produto.linkCompra.includes('amazon.com');
                
                return `
                    <div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all p-6">
                        <div class="flex flex-col md:flex-row gap-6">
                            <!-- Image -->
                            <div class="flex-shrink-0">
                                <img src="${imagemSrc}" 
                                     alt="${produto.nome}" 
                                     class="w-48 h-48 object-contain bg-gray-50 rounded-xl p-4"
                                     onerror="this.src='https://via.placeholder.com/200x200/ef4444/ffffff?text=Erro'">
                            </div>
                            
                            <!-- Info -->
                            <div class="flex-1">
                                <div class="mb-3">
                                    ${temImagem ? 
                                        '<span class="bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full"><i class="fas fa-check-circle mr-1"></i>Com Imagem</span>' : 
                                        '<span class="bg-yellow-100 text-yellow-800 text-sm font-semibold px-3 py-1 rounded-full"><i class="fas fa-clock mr-1"></i>Pendente</span>'
                                    }
                                    ${isAmazon ? 
                                        '<span class="ml-2 bg-orange-100 text-orange-800 text-sm font-semibold px-3 py-1 rounded-full"><i class="fab fa-amazon mr-1"></i>Amazon</span>' : 
                                        ''
                                    }
                                </div>
                                
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${produto.nome}</h3>
                                
                                <a href="${produto.linkCompra}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm break-all mb-4 inline-block">
                                    <i class="fas fa-external-link-alt mr-1"></i>${produto.linkCompra}
                                </a>
                                
                                <!-- Action Buttons -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-4">
                                    <button onclick="buscarImagemAPI(${index})" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                        <i class="fas fa-robot mr-1"></i>API
                                    </button>
                                    
                                    ${isAmazon ? `
                                        <button onclick="tentarAmazon(${index})" class="bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                            <i class="fab fa-amazon mr-1"></i>ASIN
                                        </button>
                                    ` : ''}
                                    
                                    <button onclick="inserirManual(${index})" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                        <i class="fas fa-edit mr-1"></i>Manual
                                    </button>
                                    
                                    ${temImagem ? `
                                        <button onclick="copiarURL(${index})" class="bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                            <i class="fas fa-copy mr-1"></i>Copiar
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Buscar imagem via API
        async function buscarImagemAPI(index) {
            const produto = produtosCarregados[index];
            const url = produto.linkCompra;
            
            const apis = [
                {
                    nome: 'JSONLink',
                    url: `https://jsonlink.io/api/extract?url=${encodeURIComponent(url)}`
                },
                {
                    nome: 'Microlink',
                    url: `https://api.microlink.io?url=${encodeURIComponent(url)}`
                }
            ];
            
            for (let api of apis) {
                try {
                    console.log(`Tentando ${api.nome}...`);
                    const response = await fetch(api.url);
                    const data = await response.json();
                    
                    let imagemUrl = null;
                    
                    // JSONLink
                    if (data.images && data.images.length > 0) {
                        imagemUrl = data.images[0];
                    } else if (data.image) {
                        imagemUrl = data.image;
                    }
                    
                    // Microlink
                    if (!imagemUrl && data.data && data.data.image && data.data.image.url) {
                        imagemUrl = data.data.image.url;
                    }
                    
                    if (imagemUrl) {
                        produtosCarregados[index].imagem = imagemUrl;
                        processadas++;
                        atualizarEstatisticas();
                        renderizarProdutos();
                        alert(`‚úÖ Imagem encontrada via ${api.nome}!`);
                        return;
                    }
                } catch (error) {
                    console.error(`Erro com ${api.nome}:`, error);
                }
            }
            
            alert('‚ùå Nenhuma API conseguiu extrair a imagem.\n\nTente:\n1. Bot√£o "ASIN" (se for Amazon)\n2. Bot√£o "Manual"');
        }

        // Tentar extrair imagem Amazon via ASIN
        function tentarAmazon(index) {
            const produto = produtosCarregados[index];
            const asin = extrairASIN(produto.linkCompra);
            
            if (asin) {
                const imagemUrl = gerarImagemAmazon(asin);
                produtosCarregados[index].imagem = imagemUrl;
                processadas++;
                atualizarEstatisticas();
                renderizarProdutos();
                alert(`‚úÖ URL de imagem Amazon gerada!\nASIN: ${asin}`);
            } else {
                alert('‚ùå N√£o foi poss√≠vel extrair o ASIN da URL.\n\nUse o m√©todo Manual.');
            }
        }

        // Inserir URL manual
        function inserirManual(index) {
            const produto = produtosCarregados[index];
            
            const instrucoes = `üìù INSTRU√á√ïES PASSO A PASSO:

1. O link do produto ser√° aberto em nova aba
2. Na p√°gina do produto, localize a imagem principal
3. Clique com BOT√ÉO DIREITO na imagem
4. Selecione "Copiar endere√ßo da imagem" ou "Copiar link da imagem"
5. Cole o link na pr√≥xima caixa

Produto: ${produto.nome}

Pressione OK para abrir o link...`;
            
            if (confirm(instrucoes)) {
                window.open(produto.linkCompra, '_blank');
                
                setTimeout(() => {
                    const url = prompt('Cole a URL da imagem aqui:');
                    
                    if (url && url.trim()) {
                        produtosCarregados[index].imagem = url.trim();
                        processadas++;
                        atualizarEstatisticas();
                        renderizarProdutos();
                        alert('‚úÖ Imagem atualizada com sucesso!');
                    }
                }, 1500);
            }
        }

        // Copiar URL
        function copiarURL(index) {
            const url = produtosCarregados[index].imagem;
            navigator.clipboard.writeText(url).then(() => {
                alert('‚úÖ URL copiada para a √°rea de transfer√™ncia!');
            });
        }

        // Buscar todas automaticamente
        async function buscarTodasAutomatico() {
            const semImagem = produtosCarregados.filter(p => isPlaceholder(p.imagem));
            
            if (semImagem.length === 0) {
                alert('‚úÖ Todos os produtos j√° t√™m imagem!');
                return;
            }
            
            if (!confirm(`üöÄ Buscar imagens para ${semImagem.length} produtos?\n\n‚ö†Ô∏è IMPORTANTE:\n- Processo demorado (2-3 seg por produto)\n- APIs gratuitas t√™m limites\n- Alguns produtos podem falhar\n- Voc√™ pode cancelar a qualquer momento\n\nTempo estimado: ~${Math.ceil(semImagem.length * 2.5 / 60)} minutos\n\nContinuar?`)) {
                return;
            }
            
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.classList.remove('hidden');
            
            let sucessos = 0;
            let falhas = 0;
            let processed = 0;
            const total = semImagem.length;
            
            for (let i = 0; i < produtosCarregados.length; i++) {
                if (!isPlaceholder(produtosCarregados[i].imagem)) continue;
                
                processed++;
                progressText.textContent = `${processed} / ${total}`;
                progressBar.style.width = `${(processed / total) * 100}%`;
                
                const produto = produtosCarregados[i];
                let imagemEncontrada = false;
                
                // Tentar APIs
                const apis = [
                    `https://jsonlink.io/api/extract?url=${encodeURIComponent(produto.linkCompra)}`,
                    `https://api.microlink.io?url=${encodeURIComponent(produto.linkCompra)}`
                ];
                
                for (let apiUrl of apis) {
                    try {
                        const response = await fetch(apiUrl);
                        const data = await response.json();
                        
                        let imagemUrl = null;
                        if (data.images && data.images.length > 0) {
                            imagemUrl = data.images[0];
                        } else if (data.image) {
                            imagemUrl = data.image;
                        } else if (data.data && data.data.image && data.data.image.url) {
                            imagemUrl = data.data.image.url;
                        }
                        
                        if (imagemUrl) {
                            produtosCarregados[i].imagem = imagemUrl;
                            sucessos++;
                            processadas++;
                            imagemEncontrada = true;
                            break;
                        }
                    } catch (error) {
                        console.error('Erro:', error);
                    }
                }
                
                // Se n√£o encontrou e for Amazon, tentar ASIN
                if (!imagemEncontrada && produto.linkCompra.includes('amazon.com')) {
                    const asin = extrairASIN(produto.linkCompra);
                    if (asin) {
                        produtosCarregados[i].imagem = gerarImagemAmazon(asin);
                        sucessos++;
                        processadas++;
                        imagemEncontrada = true;
                    }
                }
                
                if (!imagemEncontrada) {
                    falhas++;
                }
                
                // Delay entre requisi√ß√µes
                await new Promise(resolve => setTimeout(resolve, 2500));
                
                // Atualizar interface a cada 3 produtos
                if (processed % 3 === 0) {
                    atualizarEstatisticas();
                    renderizarProdutos();
                }
            }
            
            progressContainer.classList.add('hidden');
            atualizarEstatisticas();
            renderizarProdutos();
            
            alert(`üéâ Busca conclu√≠da!\n\n‚úÖ Sucessos: ${sucessos}\n‚ùå Falhas: ${falhas}\nüìä Taxa de sucesso: ${Math.round((sucessos/total)*100)}%\n\nProdutos com falha podem ser atualizados manualmente.`);
        }

        // Exportar JSON
        function exportarJSON() {
            const dataAtual = new Date().toISOString().split('T')[0];
            const json = JSON.stringify(produtosCarregados, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `produtos-com-imagens-${dataAtual}.json`;
            a.click();
            
            alert(`‚úÖ JSON exportado com sucesso!\n\nArquivo: produtos-com-imagens-${dataAtual}.json\n\nProdutos com imagem: ${produtosCarregados.filter(p => !isPlaceholder(p.imagem)).length}/${produtosCarregados.length}`);
        }
    </script>
</body>
</html>
