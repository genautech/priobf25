<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atualiza√ß√£o Autom√°tica de Imagens - Cat√°logo BF25</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .status-box {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
        }
        
        .status-box h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-icon {
            font-size: 1.5em;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }
        
        .status-text {
            flex: 1;
            font-size: 1.1em;
        }
        
        .status-value {
            font-weight: bold;
            font-size: 1.2em;
            color: #667eea;
        }
        
        #console-output {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .success-message.active {
            display: block;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .product-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .product-card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
            margin-bottom: 10px;
        }
        
        .product-card.updated {
            border-color: #28a745;
            background: #f0fff4;
        }
        
        .product-card.placeholder {
            border-color: #ffc107;
            background: #fffbf0;
        }
        
        .product-name {
            font-size: 0.9em;
            color: #333;
            margin-top: 10px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Atualiza√ß√£o Autom√°tica de Imagens</h1>
            <p>Sistema Inteligente de Matching de Produtos - Black Friday 2025</p>
        </div>
        
        <div class="content">
            <div class="status-box">
                <h2>üìä Status da Atualiza√ß√£o</h2>
                <div class="status-item">
                    <div class="status-icon">üñºÔ∏è</div>
                    <div class="status-text">Imagens Carregadas do Cat√°logo:</div>
                    <div class="status-value" id="total-images">-</div>
                </div>
                <div class="status-item">
                    <div class="status-icon">‚úÖ</div>
                    <div class="status-text">Imagens Atualizadas:</div>
                    <div class="status-value" id="updated-images">0</div>
                </div>
                <div class="status-item">
                    <div class="status-icon">üîó</div>
                    <div class="status-text">Links Adicionados:</div>
                    <div class="status-value" id="added-links">0</div>
                </div>
                <div class="status-item">
                    <div class="status-icon">‚ö†Ô∏è</div>
                    <div class="status-text">Placeholders Restantes:</div>
                    <div class="status-value" id="remaining-placeholders">0</div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="iniciarAtualizacao()">
                    üöÄ Iniciar Atualiza√ß√£o Autom√°tica
                </button>
                <button class="btn btn-secondary" onclick="limparConsole()">
                    üóëÔ∏è Limpar Console
                </button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processando produtos e atualizando imagens...</p>
            </div>
            
            <div class="success-message" id="success-message">
                <h3>‚úÖ Atualiza√ß√£o Conclu√≠da com Sucesso!</h3>
                <p>Os produtos foram processados e as imagens compat√≠veis foram inseridas automaticamente.</p>
            </div>
            
            <div id="console-output">üñ•Ô∏è Console de Execu√ß√£o - Aguardando in√≠cio...\n</div>
            
            <div id="products-preview" class="product-grid"></div>
        </div>
    </div>

    <!-- Carregar produtos -->
    <script src="produtos-v6.1.js"></script>
    
    <script>
        // Interceptar console.log para exibir no HTML
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.textContent += message + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
        
        function limparConsole() {
            consoleOutput.textContent = 'üñ•Ô∏è Console limpo - Pronto para nova execu√ß√£o...\n';
        }
        
        // ============================================
        // SISTEMA DE ATUALIZA√á√ÉO DE IMAGENS
        // ============================================
        let imagensCatalogo = {};
        let stats = {
            totalImagens: 0,
            imagensAtualizadas: 0,
            linksAdicionados: 0,
            placeholdersRestantes: 0
        };
        
        // Carregar imagens do cat√°logo
        async function carregarImagensCatalogo() {
            try {
                const response = await fetch('catalog_images.json');
                const data = await response.json();
                
                if (data.data && data.data.products) {
                    data.data.products.forEach(product => {
                        if (product.product_name && product.image_url) {
                            imagensCatalogo[product.product_name] = product.image_url;
                        }
                    });
                    stats.totalImagens = Object.keys(imagensCatalogo).length;
                    document.getElementById('total-images').textContent = stats.totalImagens;
                    console.log(`‚úÖ ${stats.totalImagens} imagens carregadas do cat√°logo JSON`);
                    return true;
                }
            } catch (err) {
                console.error('‚ùå Erro ao carregar imagens:', err);
                return false;
            }
        }
        
        // Normalizar nome do produto
        function normalizarNome(nome) {
            return nome
                .toLowerCase()
                .replace(/[√°√†√£√¢√§]/g, 'a')
                .replace(/[√©√®√™√´]/g, 'e')
                .replace(/[√≠√¨√Æ√Ø]/g, 'i')
                .replace(/[√≥√≤√µ√¥√∂]/g, 'o')
                .replace(/[√∫√π√ª√º]/g, 'u')
                .replace(/√ß/g, 'c')
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Verificar se √© placeholder
        function isPlaceholder(urlImagem) {
            if (!urlImagem) return true;
            const placeholders = [
                'via.placeholder.com',
                'placeholder.com',
                'placehold',
                'example.com',
                '/placeholder',
                'data:image'
            ];
            return placeholders.some(ph => urlImagem.includes(ph));
        }
        
        // Encontrar imagem compat√≠vel
        function encontrarImagemCompativel(nomeProduto) {
            // 1. Match exato
            if (imagensCatalogo[nomeProduto]) {
                return imagensCatalogo[nomeProduto];
            }
            
            // 2. Match normalizado
            const nomeNormalizado = normalizarNome(nomeProduto);
            for (const [nomeCatalogo, urlImagem] of Object.entries(imagensCatalogo)) {
                if (normalizarNome(nomeCatalogo) === nomeNormalizado) {
                    return urlImagem;
                }
            }
            
            // 3. Match parcial (‚â•50% similaridade)
            const palavrasProduto = nomeNormalizado.split(' ').filter(p => p.length > 2);
            let melhorMatch = null;
            let melhorScore = 0;
            
            for (const [nomeCatalogo, urlImagem] of Object.entries(imagensCatalogo)) {
                const palavrasCatalogo = normalizarNome(nomeCatalogo).split(' ').filter(p => p.length > 2);
                let matches = 0;
                
                palavrasProduto.forEach(palavra => {
                    if (palavrasCatalogo.some(pc => pc.includes(palavra) || palavra.includes(pc))) {
                        matches++;
                    }
                });
                
                const score = matches / Math.max(palavrasProduto.length, palavrasCatalogo.length);
                if (score > melhorScore && score >= 0.5) {
                    melhorScore = score;
                    melhorMatch = urlImagem;
                }
            }
            
            return melhorMatch;
        }
        
        // Gerar link da Amazon
        function gerarLinkAmazon(nomeProduto) {
            const nomeParaURL = nomeProduto
                .replace(/\s+/g, '+')
                .replace(/[√°√†√£√¢√§]/gi, 'a')
                .replace(/[√©√®√™√´]/gi, 'e')
                .replace(/[√≠√¨√Æ√Ø]/gi, 'i')
                .replace(/[√≥√≤√µ√¥√∂]/gi, 'o')
                .replace(/[√∫√π√ª√º]/gi, 'u')
                .replace(/√ß/gi, 'c')
                .replace(/[^a-zA-Z0-9+]/g, '');
            
            return `https://www.amazon.com.br/s?k=${nomeParaURL}`;
        }
        
        // Processar produtos
        function processarProdutos(produtos, nomeLista) {
            console.log(`\nüì¶ Processando ${nomeLista}...`);
            console.log(`Total de produtos: ${produtos.length}\n`);
            
            const produtosProcessados = produtos.map(p => {
                const produto = { ...p };
                
                // Adicionar link de compra
                if (!produto.linkCompra) {
                    produto.linkCompra = gerarLinkAmazon(produto.nome);
                    stats.linksAdicionados++;
                }
                
                // Substituir imagem se for placeholder
                if (isPlaceholder(produto.imagem)) {
                    const imagemCompativel = encontrarImagemCompativel(produto.nome);
                    if (imagemCompativel) {
                        produto.imagem = imagemCompativel;
                        stats.imagensAtualizadas++;
                        console.log(`‚úÖ ${produto.nome}`);
                    } else {
                        stats.placeholdersRestantes++;
                        console.log(`‚ö†Ô∏è  Sem match: ${produto.nome}`);
                    }
                } else {
                    console.log(`‚ÑπÔ∏è  J√° tem imagem: ${produto.nome}`);
                }
                
                return produto;
            });
            
            return produtosProcessados;
        }
        
        // Exibir preview dos produtos
        function exibirPreview(produtos) {
            const container = document.getElementById('products-preview');
            container.innerHTML = '<h2 style="grid-column: 1/-1; color: #667eea; margin-top: 30px;">üé® Preview dos Produtos Atualizados</h2>';
            
            produtos.slice(0, 20).forEach(p => {
                const isUpdated = !isPlaceholder(p.imagem);
                const card = document.createElement('div');
                card.className = `product-card ${isUpdated ? 'updated' : 'placeholder'}`;
                card.innerHTML = `
                    <img src="${p.imagem}" alt="${p.nome}" onerror="this.src='https://via.placeholder.com/150?text=Sem+Imagem'">
                    <div class="product-name">${p.nome.substring(0, 50)}${p.nome.length > 50 ? '...' : ''}</div>
                `;
                container.appendChild(card);
            });
        }
        
        // Fun√ß√£o principal de atualiza√ß√£o
        async function iniciarAtualizacao() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('success-message').classList.remove('active');
            
            console.log('\nüöÄ INICIANDO ATUALIZA√á√ÉO AUTOM√ÅTICA DE IMAGENS\n');
            console.log('‚ïê'.repeat(50));
            
            // Resetar stats
            stats = {
                totalImagens: 0,
                imagensAtualizadas: 0,
                linksAdicionados: 0,
                placeholdersRestantes: 0
            };
            
            // Carregar imagens do cat√°logo
            const sucesso = await carregarImagensCatalogo();
            if (!sucesso) {
                document.getElementById('loading').classList.remove('active');
                alert('‚ùå Erro ao carregar o cat√°logo de imagens!');
                return;
            }
            
            // Simular delay para melhor UX
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Processar produtos
            let todosProdutos = [];
            
            if (typeof produtosPlanilha !== 'undefined') {
                const novaPlanilha = processarProdutos(produtosPlanilha, 'produtosPlanilha');
                todosProdutos = todosProdutos.concat(novaPlanilha);
            }
            
            if (typeof produtosSugeridos !== 'undefined') {
                const novosSugeridos = processarProdutos(produtosSugeridos, 'produtosSugeridos');
                todosProdutos = todosProdutos.concat(novosSugeridos);
            }
            
            // Atualizar estat√≠sticas na interface
            document.getElementById('updated-images').textContent = stats.imagensAtualizadas;
            document.getElementById('added-links').textContent = stats.linksAdicionados;
            document.getElementById('remaining-placeholders').textContent = stats.placeholdersRestantes;
            
            // Exibir preview
            exibirPreview(todosProdutos);
            
            // Mostrar resumo
            console.log('\n' + '‚ïê'.repeat(50));
            console.log('üìä RESUMO DA ATUALIZA√á√ÉO');
            console.log('‚ïê'.repeat(50));
            console.log(`‚úÖ Imagens atualizadas: ${stats.imagensAtualizadas}`);
            console.log(`üîó Links adicionados: ${stats.linksAdicionados}`);
            console.log(`‚ö†Ô∏è  Placeholders restantes: ${stats.placeholdersRestantes}`);
            console.log(`üìÅ Total de imagens no cat√°logo: ${stats.totalImagens}`);
            console.log('‚ïê'.repeat(50) + '\n');
            
            document.getElementById('loading').classList.remove('active');
            document.getElementById('success-message').classList.add('active');
            
            console.log('‚úÖ ATUALIZA√á√ÉO CONCLU√çDA COM SUCESSO!\n');
        }
    </script>
</body>
</html>
