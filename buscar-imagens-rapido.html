<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Imagens - Modo R√°pido</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-purple-600 via-purple-700 to-indigo-800 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-3xl shadow-2xl p-8 mb-6">
            <h1 class="text-4xl font-bold text-purple-800 mb-3">
                ‚ö° Buscar Imagens - Modo R√ÅPIDO
            </h1>
            <p class="text-xl text-gray-600 mb-4">
                Sistema otimizado: ASIN autom√°tico para Amazon + Manual para outros
            </p>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                <p class="text-blue-800 font-semibold">üöÄ Processo Otimizado:</p>
                <ul class="text-blue-700 mt-2 space-y-1">
                    <li>‚úÖ <strong>Amazon:</strong> Extra√ß√£o ASIN instant√¢nea (~90% sucesso)</li>
                    <li>‚úÖ <strong>Outros:</strong> Processo manual guiado (100% sucesso)</li>
                    <li>‚ö° <strong>Sem espera:</strong> Sem chamadas API lentas</li>
                </ul>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-xl p-4 shadow-lg text-center">
                <div class="text-3xl font-bold text-purple-700" id="total">0</div>
                <div class="text-sm text-gray-600">Total</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-lg text-center">
                <div class="text-3xl font-bold text-green-700" id="completos">0</div>
                <div class="text-sm text-gray-600">Completos</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-lg text-center">
                <div class="text-3xl font-bold text-yellow-700" id="pendentes">0</div>
                <div class="text-sm text-gray-600">Pendentes</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-lg text-center">
                <div class="text-3xl font-bold text-orange-700" id="amazon">0</div>
                <div class="text-sm text-gray-600">Amazon</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-lg text-center">
                <div class="text-3xl font-bold text-blue-700" id="progresso">0%</div>
                <div class="text-sm text-gray-600">Progresso</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="grid md:grid-cols-3 gap-4">
                <button onclick="carregarProdutos()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all">
                    üì¶ Carregar Produtos
                </button>
                <button onclick="processarAmazonAutomatico()" id="btn-amazon" disabled class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-xl transition-all disabled:opacity-50">
                    ‚ö° Processar Amazon (R√ÅPIDO)
                </button>
                <button onclick="exportarJSON()" id="btn-exportar" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-all disabled:opacity-50">
                    üíæ Exportar JSON
                </button>
            </div>
            
            <div class="mt-4 bg-green-50 rounded-lg p-4">
                <p class="text-green-800 text-sm">
                    <strong>üí° Dica:</strong> Primeiro processe Amazon automaticamente (instant√¢neo), 
                    depois complete manualmente os restantes (bot√£o verde em cada produto).
                </p>
            </div>
        </div>

        <!-- Progress -->
        <div id="progress-box" class="hidden bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="flex justify-between mb-2">
                <span class="font-semibold text-gray-700">Processando Amazon...</span>
                <span id="progress-text" class="text-gray-600">0 / 0</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-gradient-to-r from-orange-500 to-orange-600 h-4 rounded-full transition-all" style="width: 0%"></div>
            </div>
        </div>

        <!-- Products -->
        <div id="products" class="space-y-4"></div>
    </div>

    <script src="produtos-v6.1.js"></script>
    <script>
        let produtos = [];

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function isPlaceholder(url) {
            if (!url) return true;
            return url.includes('placeholder') || url.includes('placehold');
        }

        function extrairASIN(url) {
            const patterns = [
                /\/dp\/([A-Z0-9]{10})/,
                /\/gp\/product\/([A-Z0-9]{10})/,
                /\/ASIN\/([A-Z0-9]{10})/
            ];
            
            for (let pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        function gerarImagemAmazon(asin) {
            return `https://m.media-amazon.com/images/I/${asin}._AC_SL1500_.jpg`;
        }

        function atualizarStats() {
            const total = produtos.length;
            const completos = produtos.filter(p => !isPlaceholder(p.imagem)).length;
            const pendentes = total - completos;
            const amazon = produtos.filter(p => p.linkCompra.includes('amazon.com')).length;
            const prog = total > 0 ? Math.round((completos / total) * 100) : 0;

            document.getElementById('total').textContent = total;
            document.getElementById('completos').textContent = completos;
            document.getElementById('pendentes').textContent = pendentes;
            document.getElementById('amazon').textContent = amazon;
            document.getElementById('progresso').textContent = prog + '%';
        }

        function carregarProdutos() {
            try {
                let todos = [];
                
                if (typeof produtosPlanilha !== 'undefined') {
                    todos = todos.concat(produtosPlanilha);
                }
                
                if (typeof produtosSugeridos !== 'undefined') {
                    todos = todos.concat(produtosSugeridos);
                }
                
                if (todos.length === 0) {
                    alert('‚ùå Erro: produtos-v6.1.js n√£o foi carregado!\n\nVerifique se o arquivo est√° na mesma pasta.');
                    return;
                }
                
                produtos = todos;
                
                console.log(`‚úÖ ${produtos.length} produtos carregados`);
                
                atualizarStats();
                renderizar();
                
                document.getElementById('btn-amazon').disabled = false;
                document.getElementById('btn-exportar').disabled = false;
                
                alert(`‚úÖ ${produtos.length} produtos carregados!\n\nPr√≥ximo passo:\n1. Clique "Processar Amazon" (instant√¢neo)\n2. Complete manualmente os restantes`);
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                alert('‚ùå Erro ao carregar produtos!\n\nAbra o Console (F12) para ver detalhes.');
            }
        }

        function renderizar() {
            const container = document.getElementById('products');
            
            try {
                container.innerHTML = produtos.map((p, i) => {
                    const temImagem = !isPlaceholder(p.imagem);
                    const isAmazon = p.linkCompra.includes('amazon.com');
                    const img = temImagem ? escapeHtml(p.imagem) : 'https://via.placeholder.com/200x200/6366f1/ffffff?text=Sem+Imagem';
                    const nomeSeguro = escapeHtml(p.nome);
                    const linkSeguro = escapeHtml(p.linkCompra);
                    
                    return `
                        <div class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all">
                            <div class="flex flex-col md:flex-row gap-6">
                                <div class="flex-shrink-0">
                                    <img src="${img}" 
                                         alt="${nomeSeguro}" 
                                         class="w-48 h-48 object-contain bg-gray-50 rounded-xl p-4"
                                         onerror="this.src='https://via.placeholder.com/200x200/ef4444/ffffff?text=Erro'">
                                </div>
                                
                                <div class="flex-1">
                                    <div class="mb-3 flex flex-wrap gap-2">
                                        ${temImagem ? 
                                            '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">‚úì Com Imagem</span>' :
                                            '<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-semibold">‚è≥ Pendente</span>'
                                        }
                                        ${isAmazon ? 
                                            '<span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-semibold">üõí Amazon</span>' :
                                            '<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">üåê Outro Site</span>'
                                        }
                                    </div>
                                    
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">${nomeSeguro}</h3>
                                    
                                    <a href="${linkSeguro}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm break-all mb-4 inline-block">
                                        üîó ${linkSeguro.substring(0, 80)}${linkSeguro.length > 80 ? '...' : ''}
                                    </a>
                                    
                                    <div class="flex gap-2 mt-4">
                                        ${!temImagem && isAmazon ? `
                                            <button onclick="processarAmazon(${i})" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg">
                                                ‚ö° ASIN R√°pido
                                            </button>
                                        ` : ''}
                                        
                                        ${!temImagem ? `
                                            <button onclick="inserirManual(${i})" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg">
                                                ‚úèÔ∏è Inserir Manual
                                            </button>
                                        ` : ''}
                                        
                                        ${temImagem ? `
                                            <button onclick="copiar(${i})" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-medium py-2 px-4 rounded-lg">
                                                üìã Copiar URL
                                            </button>
                                            <button onclick="trocar(${i})" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg">
                                                üîÑ Trocar
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao renderizar produtos:', error);
                container.innerHTML = '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">Erro ao renderizar produtos. Veja o console (F12) para detalhes.</div>';
            }
        }

        function processarAmazon(index) {
            const p = produtos[index];
            const asin = extrairASIN(p.linkCompra);
            
            if (asin) {
                produtos[index].imagem = gerarImagemAmazon(asin);
                atualizarStats();
                renderizar();
                alert(`‚úÖ Imagem Amazon gerada!\nASIN: ${asin}`);
            } else {
                alert('‚ùå N√£o foi poss√≠vel extrair ASIN.\nUse o bot√£o "Inserir Manual".');
            }
        }

        async function processarAmazonAutomatico() {
            const amazonPendentes = produtos.filter((p, i) => 
                p.linkCompra.includes('amazon.com') && isPlaceholder(p.imagem)
            );
            
            if (amazonPendentes.length === 0) {
                alert('‚úÖ Todos os produtos Amazon j√° t√™m imagem!');
                return;
            }
            
            if (!confirm(`‚ö° Processar ${amazonPendentes.length} produtos Amazon automaticamente?\n\n‚úÖ Processo instant√¢neo\n‚úÖ ~90% de taxa de sucesso`)) {
                return;
            }
            
            const progressBox = document.getElementById('progress-box');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            progressBox.classList.remove('hidden');
            
            let sucessos = 0;
            let processados = 0;
            
            for (let i = 0; i < produtos.length; i++) {
                if (!produtos[i].linkCompra.includes('amazon.com')) continue;
                if (!isPlaceholder(produtos[i].imagem)) continue;
                
                const asin = extrairASIN(produtos[i].linkCompra);
                if (asin) {
                    produtos[i].imagem = gerarImagemAmazon(asin);
                    sucessos++;
                }
                
                processados++;
                progressText.textContent = `${processados} / ${amazonPendentes.length}`;
                progressBar.style.width = `${(processados / amazonPendentes.length) * 100}%`;
            }
            
            progressBox.classList.add('hidden');
            atualizarStats();
            renderizar();
            
            alert(`‚úÖ Processo conclu√≠do!\n\n‚úì Sucessos: ${sucessos}\n‚úó Falhas: ${processados - sucessos}\n\nProdutos com falha podem ser inseridos manualmente.`);
        }

        function inserirManual(index) {
            const p = produtos[index];
            
            window.open(p.linkCompra, '_blank');
            
            setTimeout(() => {
                const instrucoes = `üìù INSTRU√á√ïES:

1. Na p√°gina que abriu:
   - Localize a imagem do produto
   - Clique com BOT√ÉO DIREITO na imagem
   - Selecione "Copiar endere√ßo da imagem"

2. Cole a URL aqui quando solicitado

Produto: ${p.nome}`;
                
                alert(instrucoes);
                
                const url = prompt('Cole a URL da imagem:');
                
                if (url && url.trim()) {
                    produtos[index].imagem = url.trim();
                    atualizarStats();
                    renderizar();
                    alert('‚úÖ Imagem atualizada!');
                }
            }, 1000);
        }

        function trocar(index) {
            inserirManual(index);
        }

        function copiar(index) {
            navigator.clipboard.writeText(produtos[index].imagem).then(() => {
                alert('‚úÖ URL copiada!');
            });
        }

        function exportarJSON() {
            const data = new Date().toISOString().split('T')[0];
            const json = JSON.stringify(produtos, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `produtos-imagens-${data}.json`;
            a.click();
            
            const completos = produtos.filter(p => !isPlaceholder(p.imagem)).length;
            alert(`‚úÖ JSON exportado!\n\nArquivo: produtos-imagens-${data}.json\nCompletos: ${completos}/${produtos.length} (${Math.round(completos/produtos.length*100)}%)`);
        }
    </script>
</body>
</html>
