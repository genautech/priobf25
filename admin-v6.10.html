<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Admin Black Friday PRIO v6.10 - Estat√≠sticas + CSV Otimizado + Ferramentas Essenciais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <!-- üì¶ Dados e CRUD -->
    <script src="produtos-v6.1.js"></script>
    <script src="produto-crud-sync.js"></script>
    <script src="produto-persistencia-local.js"></script>
    
    <!-- üöÄ Sincroniza√ß√£o AUTOM√ÅTICA via Cloudflare Worker -->
    <script src="github-sync-worker.js"></script>
    <script src="auto-sync-worker.js"></script>
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .badge-novo {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-inactive {
            background: white;
            color: #4a5568;
        }
        .tab-inactive:hover {
            background: #f7fafc;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f97316;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .product-card {
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 2rem;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="glass-card rounded-2xl shadow-2xl p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                        <i class="fas fa-shopping-cart mr-2"></i>Admin Black Friday PRIO
                    </h1>
                    <p class="text-gray-600 mt-2">Sistema v6.10 - CRUD Completo + Sincroniza√ß√£o Autom√°tica + Estat√≠sticas Avan√ßadas</p>
                    <p class="text-sm text-green-600 font-semibold mt-1">
                        <i class="fas fa-check-circle mr-1"></i>Novo v6.10: Estat√≠sticas em Sugest√µes + CSV Otimizado + Ferramentas Essenciais
                    </p>
                </div>
                <div class="mt-4 md:mt-0 text-center md:text-right">
                    <div class="text-sm text-gray-500">Or√ßamento Total</div>
                    <div id="totalBudget" class="text-3xl font-bold text-purple-600">R$ 0</div>
                    <div class="text-sm text-gray-500 mt-1"><span id="totalProducts">0</span> produtos</div>
                    
                    <!-- NOVO: √öltimo Commit -->
                    <div class="mt-2 text-xs text-gray-400">
                        <i class="fas fa-code-branch mr-1"></i>
                        <span id="lastCommitInfo">Verificando √∫ltimo commit...</span>
                    </div>
                    
                    <!-- NOVO: Auto-Sync Toggle v6.5 -->
                    <div class="mt-3 flex items-center justify-center md:justify-end gap-2">
                        <div id="auto-sync-toggle" 
                             class="relative inline-block w-14 h-7 bg-gray-400 rounded-full cursor-pointer transition-colors duration-300"
                             onclick="toggleAutoSync()">
                            <span class="absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition-transform duration-300"></span>
                        </div>
                        <div class="text-left">
                            <div class="flex items-center gap-2">
                                <i id="auto-sync-icon" class="fas fa-sync-alt" style="color: #9ca3af;"></i>
                                <span id="auto-sync-badge" class="text-sm font-semibold text-gray-600">OFF</span>
                            </div>
                            <p class="text-xs text-gray-500">Auto-Sync</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="glass-card rounded-2xl shadow-2xl mb-6 p-2">
            <div class="flex flex-wrap gap-2">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button onclick="switchTab('sugestoes')" id="tab-sugestoes" class="tab-inactive flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-lightbulb mr-2"></i>Sugest√µes & Inova√ß√µes
                </button>
                <button onclick="switchTab('catalogo')" id="tab-catalogo" class="tab-inactive flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-book mr-2"></i>Cat√°logo Cliente
                </button>
                <button onclick="switchTab('analise')" id="tab-analise" class="tab-inactive flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-chart-pie mr-2"></i>An√°lise Avan√ßada
                </button>
                <button onclick="switchTab('comparativo')" id="tab-comparativo" class="tab-inactive flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-balance-scale mr-2"></i>Comparativo Pre√ßos
                </button>
                <button onclick="switchTab('cupons')" id="tab-cupons" class="tab-inactive flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-ticket-alt mr-2"></i>Cupons Desconto
                </button>
                <button onclick="switchTab('ferramentas')" id="tab-ferramentas" class="tab-inactive flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-tools mr-2"></i>Ferramentas
                </button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="content-dashboard" class="tab-content">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="stat-card rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">Total Produtos</p>
                            <p id="stat-total" class="text-3xl font-bold mt-2">122</p>
                        </div>
                        <i class="fas fa-boxes text-4xl text-white text-opacity-50"></i>
                    </div>
                </div>
                <div class="stat-card rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">Planilha</p>
                            <p id="stat-planilha" class="text-3xl font-bold mt-2">12</p>
                        </div>
                        <i class="fas fa-file-excel text-4xl text-white text-opacity-50"></i>
                    </div>
                </div>
                <div class="stat-card rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">Sugest√µes</p>
                            <p id="stat-sugestoes" class="text-3xl font-bold mt-2">110</p>
                        </div>
                        <i class="fas fa-lightbulb text-4xl text-white text-opacity-50"></i>
                    </div>
                </div>
                <div class="stat-card rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">Categorias</p>
                            <p id="stat-categorias" class="text-3xl font-bold mt-2">10</p>
                        </div>
                        <i class="fas fa-tags text-4xl text-white text-opacity-50"></i>
                    </div>
                </div>
            </div>

            <!-- NOVO: Hist√≥rico de Atualiza√ß√µes -->
            <div class="glass-card rounded-xl shadow-lg mb-6 overflow-hidden">
                <div class="flex justify-between items-center p-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white cursor-pointer" 
                     onclick="toggleUpdateHistory()">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-history"></i>
                        <h3 class="text-lg font-bold">Hist√≥rico de Atualiza√ß√µes</h3>
                        <span id="updateHistoryCount" class="bg-white bg-opacity-20 px-2 py-1 rounded-full text-xs">0</span>
                    </div>
                    <i id="updateHistoryToggleIcon" class="fas fa-chevron-down transition-transform"></i>
                </div>
                <div id="updateHistoryContent" class="hidden p-4">
                    <div class="text-sm text-gray-500 mb-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        √öltimas modifica√ß√µes nos produtos (√∫til para coordena√ß√£o entre computadores)
                    </div>
                    <div id="updateHistoryList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Update history will be loaded here -->
                    </div>
                    <div class="mt-3 pt-3 border-t flex justify-between items-center">
                        <div class="flex gap-2">
                            <button onclick="resyncUpdateHistory()" 
                                    class="text-xs text-blue-500 hover:text-blue-700 font-semibold"
                                    title="Re-sincronizar hist√≥rico com produtos atuais">
                                <i class="fas fa-sync-alt mr-1"></i>Re-sincronizar
                            </button>
                            <button onclick="clearUpdateHistory()" 
                                    class="text-xs text-red-500 hover:text-red-700 font-semibold">
                                <i class="fas fa-trash mr-1"></i>Limpar
                            </button>
                        </div>
                        <span class="text-xs text-gray-400">Hor√°rio: Curitiba/PR (UTC-3)</span>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Produtos por Categoria</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Distribui√ß√£o de Pre√ßos</h3>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Products Table Dashboard -->
            <div class="glass-card rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Todos os Produtos</h3>
                    <div class="flex gap-2 mt-4 md:mt-0">
                        <input type="text" id="searchDashboard" placeholder="üîç Buscar produto..." 
                               class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        <select id="filterCategory" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">Todas Categorias</option>
                        </select>
                    </div>
                </div>
                <div id="dashboardProductsList" class="overflow-x-auto">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Sugest√µes & Inova√ß√µes Tab -->
        <div id="content-sugestoes" class="tab-content hidden">
            <div class="glass-card rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Sugest√µes & Inova√ß√µes 2025
                        </h2>
                        <p class="text-gray-600 mt-2">Produtos selecionados nas melhores categorias de eletr√¥nicos</p>
                    </div>
                    <button onclick="openCrudModal('create')" 
                            class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-lg hover:shadow-xl transition">
                        <i class="fas fa-plus mr-2"></i>Adicionar Produto
                    </button>
                </div>
                
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-semibold">Total de Produtos</p>
                                <p id="stat-sugestoes-total" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <i class="fas fa-boxes text-4xl text-white text-opacity-30"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-semibold">Produtos Novos</p>
                                <p id="stat-sugestoes-novos" class="text-3xl font-bold mt-1">0</p>
                            </div>
                            <i class="fas fa-star text-4xl text-white text-opacity-30"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-semibold">Investimento Total</p>
                                <p id="stat-sugestoes-investimento" class="text-2xl font-bold mt-1">R$ 0</p>
                            </div>
                            <i class="fas fa-dollar-sign text-4xl text-white text-opacity-30"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm font-semibold">Lucro Projetado</p>
                                <p id="stat-sugestoes-lucro" class="text-2xl font-bold mt-1">R$ 0</p>
                            </div>
                            <i class="fas fa-chart-line text-4xl text-white text-opacity-30"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="text" id="searchSugestoes" placeholder="üîç Buscar produto..." 
                           class="flex-1 min-w-[200px] px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                    <select id="filterSubcategory" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">Todas Subcategorias</option>
                    </select>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="filterNovos" class="w-5 h-5 text-purple-600 rounded">
                        <span class="font-semibold">üî• Apenas Novos</span>
                    </label>
                </div>
            </div>

            <!-- Products Grid -->
            <div id="sugestoesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Cat√°logo Cliente Tab -->
        <div id="content-catalogo" class="tab-content hidden">
            <div class="glass-card rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-book text-blue-500 mr-2"></i>Cat√°logo para Cliente
                </h2>
                <p class="text-gray-600 mb-4">Visualiza√ß√£o do cat√°logo conforme o cliente ver√° - Produtos da planilha + sugest√µes selecionadas</p>
                
                <!-- Catalog Filters -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="text" id="searchCatalogo" placeholder="üîç Buscar produto..." 
                           class="flex-1 min-w-[200px] px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <select id="filterCatalogoCategory" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas Categorias</option>
                    </select>
                    <select id="sortCatalogo" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="nome">Nome A-Z</option>
                        <option value="preco-asc">Menor Pre√ßo</option>
                        <option value="preco-desc">Maior Pre√ßo</option>
                        <option value="margem-desc">Maior Margem</option>
                    </select>
                </div>
            </div>

            <!-- Catalog Grid -->
            <div id="catalogoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- An√°lise Avan√ßada Tab -->
        <div id="content-analise" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Top Products -->
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-trophy text-yellow-500 mr-2"></i>Top 10 Produtos por Margem
                    </h3>
                    <div id="topMargemList" class="space-y-3">
                        <!-- Will be populated -->
                    </div>
                </div>

                <!-- Stock Analysis -->
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-boxes text-green-500 mr-2"></i>An√°lise de Estoque
                    </h3>
                    <div id="stockAnalysis">
                        <!-- Will be populated -->
                    </div>
                </div>
            </div>

            <!-- Margem Analysis Chart -->
            <div class="glass-card rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Distribui√ß√£o de Margens</h3>
                <div class="chart-container">
                    <canvas id="margemChart"></canvas>
                </div>
            </div>

            <!-- Category Performance -->
            <div class="glass-card rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Performance por Subcategoria</h3>
                <div id="categoryPerformance" class="overflow-x-auto">
                    <!-- Will be populated -->
                </div>
            </div>
        </div>

        <!-- Comparativo de Pre√ßos Tab -->
        <div id="content-comparativo" class="tab-content hidden">
            <div class="glass-card rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-balance-scale text-purple-600 mr-2"></i>
                    An√°lise Comparativa: Yoobe vs Fornecedor Concorrente
                </h3>
                <p class="text-gray-600 mb-6">
                    Compara√ß√£o de pre√ßos entre Yoobe e fornecedor concorrente (Prio). 
                    <span class="text-green-600 font-semibold">Verde</span> = Vantagem Yoobe, 
                    <span class="text-yellow-600 font-semibold">Amarelo</span> = Mesmo pre√ßo, 
                    <span class="text-red-600 font-semibold">Vermelho</span> = Desvantagem Yoobe
                </p>
                
                <!-- Filtros -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Filtrar por Status</label>
                        <select id="filterStatus" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                onchange="filterComparativo()">
                            <option value="todos">Todos</option>
                            <option value="vantagem">Vantagem Yoobe</option>
                            <option value="igual">Pre√ßo Igual</option>
                            <option value="desvantagem">Desvantagem</option>
                            <option value="exclusivo">Exclusivo Yoobe</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Categoria</label>
                        <select id="filterCategoriaComp" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                onchange="filterComparativo()">
                            <option value="todos">Todas</option>
                            <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                            <option value="Casa e Cozinha">Casa e Cozinha</option>
                            <option value="Geral">Geral</option>
                            <option value="Esporte">Esporte</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Buscar</label>
                        <input type="text" id="searchComp" placeholder="Digite o nome do produto..."
                               class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                               oninput="filterComparativo()">
                    </div>
                </div>

                <!-- Estat√≠sticas R√°pidas -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-100 p-4 rounded-lg">
                        <div class="text-sm font-semibold text-green-800">Vantagem Yoobe</div>
                        <div id="stat-vantagem" class="text-2xl font-bold text-green-600">0</div>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg">
                        <div class="text-sm font-semibold text-yellow-800">Pre√ßo Igual</div>
                        <div id="stat-igual" class="text-2xl font-bold text-yellow-600">0</div>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg">
                        <div class="text-sm font-semibold text-red-800">Desvantagem</div>
                        <div id="stat-desvantagem" class="text-2xl font-bold text-red-600">0</div>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <div class="text-sm font-semibold text-blue-800">Exclusivo Yoobe</div>
                        <div id="stat-exclusivo" class="text-2xl font-bold text-blue-600">0</div>
                    </div>
                </div>

                <!-- Bot√£o Exportar CSV -->
                <div class="mb-6">
                    <button onclick="exportarCSV()" 
                            class="w-full bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all">
                        <i class="fas fa-download mr-2"></i>
                        Exportar Cat√°logo Completo (CSV)
                    </button>
                    <div id="csvStatus" class="hidden mt-3 p-3 rounded-lg"></div>
                </div>

                <!-- Tabela Comparativa -->
                <div id="comparativoTable" class="overflow-x-auto">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Cupons de Desconto Tab -->
        <div id="content-cupons" class="tab-content hidden">
            <div class="glass-card rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-ticket-alt text-orange-600 mr-2"></i>
                            Cupons de Desconto Dispon√≠veis
                        </h3>
                        <p class="text-gray-600 mt-2">
                            Lista de cupons dispon√≠veis para uso nas compras dos produtos
                        </p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="buscarNovosCupons()" id="btnBuscarCupons"
                                class="px-6 py-3 bg-gradient-to-r from-orange-500 to-yellow-500 text-white font-bold rounded-lg hover:from-orange-600 hover:to-yellow-600 transition-all shadow-lg hover:shadow-xl">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Buscar Novos Cupons
                        </button>
                        <div class="text-right">
                            <div class="text-sm text-gray-500">Total de Cupons</div>
                            <div id="totalCupons" class="text-3xl font-bold text-orange-600">12</div>
                        </div>
                    </div>
                </div>
                
                <!-- Status de Busca -->
                <div id="statusBusca" class="hidden mb-4 p-4 rounded-lg">
                    <div class="flex items-center gap-3">
                        <div class="loader"></div>
                        <span id="statusTexto" class="font-semibold"></span>
                    </div>
                </div>

                <!-- Grid de Cupons -->
                <div id="cuponsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Ferramentas Tab -->
        <div id="content-ferramentas" class="tab-content hidden">
            <div class="glass-card rounded-xl shadow-lg p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-tools text-purple-600 mr-2"></i>
                    Ferramentas de Gest√£o de Cat√°logo v6.10
                </h3>
                <p class="text-gray-600 mb-6">
                    <strong>6 ferramentas essenciais</strong> otimizadas para gerenciar seu cat√°logo de forma eficiente.
                    <span class="inline-block ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded">
                        ‚ú® OTIMIZADO: Ferramentas redundantes removidas
                    </span>
                </p>
                
                <!-- Destaque da Ferramenta Principal -->
                <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-300 rounded-xl p-4 mb-8">
                    <div class="flex items-center gap-3">
                        <div class="bg-emerald-600 text-white p-2 rounded-lg">
                            <i class="fas fa-sync-alt text-xl"></i>
                        </div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-gray-800">DESTAQUE v6.9:</span>
                                <span class="px-2 py-1 bg-emerald-600 text-white text-xs font-bold rounded-full">NOVO</span>
                            </div>
                            <div class="text-sm text-gray-700 mt-1">
                                <strong>Re-sincroniza√ß√£o de Pre√ßos</strong> - Atualize pre√ßos de m√∫ltiplos produtos em lote com acesso direto aos links dos fornecedores!
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Grid de Ferramentas -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- 1. Exportar Template de Produtos -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border-2 border-blue-200 hover:shadow-xl transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-blue-600 text-white p-3 rounded-lg">
                                <i class="fas fa-file-export text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-blue-600 text-white text-xs font-bold rounded-full">EXPORTAR</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Exportar Template</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Exportar produtos atuais em formato JSON para edi√ß√£o e reimporta√ß√£o
                        </p>
                        <button onclick="exportarTemplate()" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-download mr-2"></i>Exportar Template
                        </button>
                    </div>

                    <!-- 2. Importar/Atualizar Cat√°logo -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border-2 border-green-200 hover:shadow-xl transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-green-600 text-white p-3 rounded-lg">
                                <i class="fas fa-file-import text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-green-600 text-white text-xs font-bold rounded-full">IMPORTAR</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Importar Cat√°logo</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Importar produtos de arquivo JSON e atualizar o cat√°logo
                        </p>
                        <button onclick="abrirImportador()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-upload mr-2"></i>Importar Produtos
                        </button>
                    </div>

                    <!-- 3. Sistema de Importa√ß√£o Avan√ßado (NOVO v2.0) -->
                    <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl p-6 border-2 border-indigo-200 hover:shadow-xl transition-all relative">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-indigo-600 text-white p-3 rounded-lg">
                                <i class="fas fa-magic text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full animate-pulse">NOVO v2.0</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Importador Inteligente</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Sistema avan√ßado de importa√ß√£o com convers√£o autom√°tica e preview
                        </p>
                        <button onclick="abrirImportadorAvancado()" 
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-magic mr-2"></i>Importador Avan√ßado
                        </button>
                    </div>

                    <!-- 4. Atualizar Imagens (NOVO) -->
                    <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl p-6 border-2 border-pink-200 hover:shadow-xl transition-all relative">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-pink-600 text-white p-3 rounded-lg">
                                <i class="fas fa-images text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full animate-pulse">NOVO</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">üñºÔ∏è Atualizar Imagens</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Atualizar imagens dos produtos via Google Drive com sincroniza√ß√£o autom√°tica
                        </p>
                        <div class="bg-white rounded-lg p-2 mb-3 text-xs">
                            <div class="flex items-start mb-1">
                                <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                                <span class="text-gray-700">Suporta Google Drive, Imgur e URLs diretas</span>
                            </div>
                            <div class="flex items-start mb-1">
                                <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                                <span class="text-gray-700">Preview em tempo real</span>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                                <span class="text-gray-700">Sincroniza automaticamente com Git</span>
                            </div>
                        </div>
                        <a href="ferramenta-atualizar-imagens.html" target="_blank" 
                           class="w-full block bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2 px-4 rounded-lg transition-all text-center"
                           onclick="return verificarAcessoFerramenta(event, 'ferramenta-atualizar-imagens.html')">
                            <i class="fas fa-external-link-alt mr-2"></i>Abrir Atualizador de Imagens
                        </a>
                    </div>

                    <!-- 5. Corrigir Links de Compra -->
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border-2 border-orange-200 hover:shadow-xl transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-orange-600 text-white p-3 rounded-lg">
                                <i class="fas fa-link text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-orange-600 text-white text-xs font-bold rounded-full">CORRIGIR</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Corrigir Links</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Gerar links de compra autom√°ticos para produtos sem link
                        </p>
                        <button onclick="corrigirLinks()" 
                                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-magic mr-2"></i>Gerar Links
                        </button>
                    </div>

                    <!-- 5. Re-sincronizar Pre√ßos (NOVO v6.9) -->
                    <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-6 border-2 border-emerald-200 hover:shadow-xl transition-all relative">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-emerald-600 text-white p-3 rounded-lg">
                                <i class="fas fa-sync-alt text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full animate-pulse">NOVO v6.9</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Re-sincronizar Pre√ßos</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Atualizar pre√ßos de m√∫ltiplos produtos baseado nos links cadastrados
                        </p>
                        <button onclick="abrirResincronizadorPrecos()" 
                                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-dollar-sign mr-2"></i>Re-sincronizar Pre√ßos
                        </button>
                    </div>

                    <!-- 6E. Gerar CSV Cat√°logo -->
                    <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-6 border-2 border-amber-200 hover:shadow-xl transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-amber-600 text-white p-3 rounded-lg">
                                <i class="fas fa-file-csv text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-amber-600 text-white text-xs font-bold rounded-full">EXTERNO</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Gerador CSV Externo</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Gerar arquivo CSV com ferramenta externa
                        </p>
                        <a href="gerar-csv-catalogo.html" target="_blank" 
                           class="w-full block bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 px-4 rounded-lg transition-all text-center"
                           onclick="return verificarAcessoFerramenta(event, 'gerar-csv-catalogo.html')">
                            <i class="fas fa-external-link-alt mr-2"></i>Abrir Gerador
                        </a>
                    </div>

                    <!-- 7. Exportar CSV Completo -->
                    <div class="bg-gradient-to-br from-teal-50 to-teal-100 rounded-xl p-6 border-2 border-teal-200 hover:shadow-xl transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-teal-600 text-white p-3 rounded-lg">
                                <i class="fas fa-file-csv text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-teal-600 text-white text-xs font-bold rounded-full">CSV</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Exportar CSV</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Exportar cat√°logo completo com an√°lise de pre√ßos Prio
                        </p>
                        <button onclick="exportarCSV()" 
                                class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-table mr-2"></i>Exportar CSV
                        </button>
                    </div>

                    <!-- 7B. NOVO v6.3.1: Salvar Produtos no Arquivo -->
                    <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-6 border-2 border-red-300 hover:shadow-xl transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-red-600 text-white p-3 rounded-lg">
                                <i class="fas fa-save text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full animate-pulse">NOVO v6.3.1</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">üíæ Salvar no Arquivo</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Salvar todos os produtos atualizados no arquivo produtos-v6.1.js
                        </p>
                        <div class="bg-white rounded-lg p-3 mb-3 text-xs">
                            <div class="flex items-start mb-1">
                                <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                                <span class="text-gray-700">Pre√ßos ficam permanentes</span>
                            </div>
                            <div class="flex items-start mb-1">
                                <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                                <span class="text-gray-700">Funciona ap√≥s deploy</span>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-check text-green-600 mr-2 mt-0.5"></i>
                                <span class="text-gray-700">Sincroniza admin e cat√°logo</span>
                            </div>
                        </div>
                        <button onclick="abrirModalSalvarProdutos()" 
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-save mr-2"></i>Salvar Produtos
                        </button>
                    </div>

                    <!-- 8. NOVO v6.3: Adicionar Produto Manual -->
                    <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-6 border-2 border-emerald-300 hover:shadow-xl transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-emerald-600 text-white p-3 rounded-lg">
                                <i class="fas fa-plus-circle text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full animate-pulse">NOVO v6.3</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Adicionar Produto</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Adicionar novo produto manualmente com formul√°rio completo
                        </p>
                        <button onclick="openCrudModal('create')" 
                                class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-plus mr-2"></i>Novo Produto
                        </button>
                    </div>

                    <!-- 9. NOVO v6.3: Importar Excel/CSV -->
                    <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 rounded-xl p-6 border-2 border-cyan-300 hover:shadow-xl transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-cyan-600 text-white p-3 rounded-lg">
                                <i class="fas fa-file-excel text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full animate-pulse">NOVO v6.3</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Importar Excel/CSV</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Importar m√∫ltiplos produtos de planilha Excel ou CSV
                        </p>
                        <button onclick="abrirImportadorExcel()" 
                                class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-file-upload mr-2"></i>Importar Planilha
                        </button>
                    </div>

                    <!-- 10. NOVO v6.3: Baixar Template -->
                    <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-6 border-2 border-amber-300 hover:shadow-xl transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="bg-amber-600 text-white p-3 rounded-lg">
                                <i class="fas fa-download text-2xl"></i>
                            </div>
                            <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded-full animate-pulse">NOVO v6.3</span>
                        </div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Baixar Template</h4>
                        <p class="text-sm text-gray-600 mb-4">
                            Baixar planilha modelo para importa√ß√£o de produtos
                        </p>
                        <a href="TEMPLATE-IMPORTACAO-PRODUTOS.csv" download 
                           class="block w-full bg-amber-600 hover:bg-amber-700 text-white font-semibold py-2 px-4 rounded-lg transition-all text-center">
                            <i class="fas fa-file-download mr-2"></i>Download Template
                        </a>
                    </div>
                </div>

                <!-- Sistema de Persist√™ncia Autom√°tica -->
                <div class="mt-8 p-6 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-300 rounded-xl">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-save text-green-600 mr-2"></i>
                        Sistema de Salvamento Autom√°tico
                    </h3>
                    
                    <p class="text-gray-700 mb-6">
                        ‚ö†Ô∏è <strong>Importante:</strong> Por padr√£o, produtos ficam apenas na mem√≥ria. Configure o salvamento autom√°tico para persistir suas altera√ß√µes!
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <!-- Op√ß√£o 1: LocalStorage -->
                        <div class="bg-white p-4 rounded-lg border-2" id="option-localStorage">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-gray-800">
                                    <i class="fas fa-database text-blue-600 mr-2"></i>LocalStorage
                                </h4>
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-bold rounded">RECOMENDADO</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">
                                Salva automaticamente no navegador. R√°pido e sem configura√ß√£o.
                            </p>
                            <div class="text-xs text-gray-500 mb-3">
                                ‚úÖ Autom√°tico<br>
                                ‚úÖ Persiste entre sess√µes<br>
                                ‚ö†Ô∏è Limite ~5MB
                            </div>
                            <button onclick="ativarPersistencia('localStorage')" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded transition-all">
                                <i class="fas fa-check mr-2"></i>Ativar
                            </button>
                        </div>

                        <!-- Op√ß√£o 2: Download -->
                        <div class="bg-white p-4 rounded-lg border-2" id="option-download">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-gray-800">
                                    <i class="fas fa-download text-purple-600 mr-2"></i>Download
                                </h4>
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-bold rounded">MANUAL</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">
                                Baixa arquivo JS ap√≥s cada altera√ß√£o. Voc√™ substitui manualmente.
                            </p>
                            <div class="text-xs text-gray-500 mb-3">
                                ‚úÖ Sem limite<br>
                                ‚úÖ Backup f√≠sico<br>
                                ‚ö†Ô∏è Requer substituir arquivo
                            </div>
                            <button onclick="ativarPersistencia('download')" 
                                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded transition-all">
                                <i class="fas fa-check mr-2"></i>Ativar
                            </button>
                        </div>

                        <!-- Op√ß√£o 3: GitHub -->
                        <div class="bg-white p-4 rounded-lg border-2" id="option-github">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-gray-800">
                                    <i class="fab fa-github text-gray-800 mr-2"></i>GitHub API
                                </h4>
                                <span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs font-bold rounded">AVAN√áADO</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">
                                Salva direto no reposit√≥rio. Requer token de acesso.
                            </p>
                            <div class="text-xs text-gray-500 mb-3">
                                ‚úÖ Totalmente autom√°tico<br>
                                ‚úÖ Versionamento Git<br>
                                ‚ö†Ô∏è Requer configura√ß√£o
                            </div>
                            <button onclick="abrirConfigGitHub()" 
                                    class="w-full bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded transition-all">
                                <i class="fas fa-cog mr-2"></i>Configurar
                            </button>
                        </div>
                    </div>

                    <!-- Status Atual -->
                    <div id="statusPersistencia" class="p-4 bg-white rounded-lg border-2 border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-sm text-gray-600">Status:</span>
                                <span id="statusPersistenciaTexto" class="ml-2 font-bold text-red-600">
                                    <i class="fas fa-times-circle mr-1"></i>Desativado
                                </span>
                            </div>
                            <button onclick="verificarEspacoStorage()" 
                                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded transition-all">
                                <i class="fas fa-info-circle mr-1"></i>Ver Info
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status Global das Ferramentas -->
                <div id="ferramentasStatus" class="hidden mt-6 p-4 rounded-lg"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Product Details -->
    <div id="productModal" class="modal">
        <div class="modal-content w-full">
            <div id="modalProductContent" class="p-8">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Modal for Margin Editor -->
    <div id="margemModal" class="modal">
        <div class="modal-content max-w-2xl mx-4">
            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-percentage text-purple-600 mr-2"></i>
                        Editor de Margem
                    </h2>
                    <button onclick="closeMargemModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="margemEditorContent">
                    <!-- Content will be inserted by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for CRUD (Create/Update/Delete Product) -->
    <div id="crudModal" class="modal">
        <div class="modal-content max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <h2 id="crudModalTitle" class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-box text-blue-600 mr-2"></i>
                        Adicionar Produto
                    </h2>
                    <button onclick="closeCrudModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="crudForm" class="space-y-6">
                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-2"></i>Informa√ß√µes B√°sicas
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">SKU *</label>
                                <input type="text" id="crud_sku" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: ECH-DOT5">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Nome do Produto *</label>
                                <input type="text" id="crud_nome" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: Echo Dot 5¬™ Gera√ß√£o">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Categoria *</label>
                                <select id="crud_categoria" required
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Selecione...</option>
                                    <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                                    <option value="Inform√°tica">Inform√°tica</option>
                                    <option value="Casa e Cozinha">Casa e Cozinha</option>
                                    <option value="Esporte e Lazer">Esporte e Lazer</option>
                                    <option value="Moda e Acess√≥rios">Moda e Acess√≥rios</option>
                                    <option value="√Åudio">√Åudio</option>
                                    <option value="Games">Games</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Subcategoria *</label>
                                <input type="text" id="crud_subcategoria" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: Smart Home">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Fornecedor *</label>
                                <input type="text" id="crud_fornecedor" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: Amazon.com.br">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Quantidade *</label>
                                <input type="number" id="crud_quantidade" required min="0"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: 10">
                            </div>
                        </div>
                    </div>

                    <!-- Precifica√ß√£o -->
                    <div class="bg-green-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-dollar-sign mr-2"></i>Precifica√ß√£o
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Custo Base (R$) *</label>
                                <input type="number" id="crud_custoBase" required min="0" step="0.01"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                       placeholder="Ex: 420.00"
                                       oninput="calcularPrecoVenda()"
                                       title="Campo edit√°vel - Digite o custo de aquisi√ß√£o do produto">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Pre√ßo Mercado (R$) *</label>
                                <input type="number" id="crud_precoMercado" required min="0" step="0.01"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                       placeholder="Ex: 599.00"
                                       title="Campo edit√°vel - Digite o pre√ßo de refer√™ncia do mercado">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Margem (%) *</label>
                                <input type="number" id="crud_margem" required min="0" max="100" step="0.1"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                       placeholder="Ex: 30"
                                       oninput="calcularPrecoVenda()">
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-white rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-800">Pre√ßo de Venda Calculado:</span>
                                <span id="crud_precoVendaDisplay" class="text-2xl font-bold text-green-600">R$ 0,00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Imagem e Descri√ß√£o -->
                    <div class="bg-purple-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-image mr-2"></i>Imagem e Descri√ß√£o
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">URL da Imagem *</label>
                                <input type="url" id="crud_imagem" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       placeholder="https://m.media-amazon.com/images/I/..."
                                       oninput="previewImage()">
                                <p class="text-xs text-gray-500 mt-1">Cole a URL completa da imagem do produto (preferencialmente Amazon CDN)</p>
                            </div>
                            <div id="imagePreview" class="hidden">
                                <img id="previewImg" src="" alt="Preview" class="w-32 h-32 object-contain border-2 border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Descri√ß√£o *</label>
                                <textarea id="crud_descricao" required rows="3"
                                          class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                          placeholder="Descreva o produto com seus principais recursos..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Especifica√ß√µes (Opcional) -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-list mr-2"></i>Especifica√ß√µes T√©cnicas (Opcional)
                        </h3>
                        <div id="especificacoesContainer" class="space-y-2">
                            <!-- Campos din√¢micos ser√£o adicionados aqui -->
                        </div>
                        <button type="button" onclick="addEspecificacao()" 
                                class="mt-3 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-plus mr-2"></i>Adicionar Especifica√ß√£o
                        </button>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="flex gap-4 pt-4 border-t-2">
                        <button type="submit" 
                                class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-lg hover:shadow-xl transition">
                            <i class="fas fa-save mr-2"></i><span id="crudSubmitText">Salvar Produto</span>
                        </button>
                        <button type="button" onclick="closeCrudModal()" 
                                class="px-6 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application Script -->
    <script>
        // Global State
        let currentTab = 'dashboard';
        let allProducts = [];
        let charts = {};
        
        // Fun√ß√£o helper para SEMPRE pegar produtos atualizados do CRUD
        function getProdutosAtualizados() {
            if (window.produtoCRUD && typeof window.produtoCRUD.listarProdutos === 'function') {
                const produtos = window.produtoCRUD.listarProdutos();
                console.log('üì¶ getProdutosAtualizados via CRUD:', produtos.length, 'produtos');
                return produtos;
            } else if (typeof obterTodosProdutos === 'function') {
                const produtos = obterTodosProdutos();
                console.log('üì¶ getProdutosAtualizados via obterTodosProdutos:', produtos.length, 'produtos');
                return produtos;
            } else {
                console.log('üì¶ getProdutosAtualizados via allProducts (fallback):', allProducts.length, 'produtos');
                return allProducts; // fallback
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOMContentLoaded - Iniciando aplica√ß√£o...');
            
            // 1. Carregar produtos primeiro
            loadProducts();
            
            // 2. Inicializar CRUD com os produtos carregados
            inicializarCRUDSync();
            
            // 3. Inicializar filtros
            initializeFilters();
            
            // 4. Renderizar todas as abas (agora com CRUD inicializado)
            console.log('üé® Renderizando interface...');
            renderDashboard();
            renderSugestoes();
            renderCatalogo();
            renderAnalise();
            renderComparativo();
            renderCupons();
            updateStats();
            
            // 5. Carregar hist√≥rico de atualiza√ß√µes
            carregarHistoricoAtualizacoes();
            
            // 6. Carregar √∫ltimo commit do GitHub (ap√≥s 1 segundo)
            setTimeout(() => {
                console.log('‚è∞ Chamando carregarUltimoCommit...');
                carregarUltimoCommit();
            }, 1000);
            
            console.log('‚úÖ Aplica√ß√£o inicializada com sucesso!');
        });

        // Load Products
        // ============================================
        // NORMALIZA√á√ÉO DE NOMES PARA MATCHING
        // ============================================
        function normalizarNome(nome) {
            return nome
                .toLowerCase()
                .trim()
                .replace(/[√°√†√£√¢√§]/g, 'a')
                .replace(/[√©√®√™√´]/g, 'e')
                .replace(/[√≠√¨√Æ√Ø]/g, 'i')
                .replace(/[√≥√≤√µ√¥√∂]/g, 'o')
                .replace(/[√∫√π√ª√º]/g, 'u')
                .replace(/√ß/g, 'c')
                .replace(/¬™/g, 'a')
                .replace(/¬∫/g, 'o')
                .replace(/\s+/g, ' '); // m√∫ltiplos espa√ßos para 1
        }
        
        function buscarPrecoConcorrente(nomeProduto) {
            // 1. Tentar match exato primeiro
            if (window.precosConcorrente[nomeProduto]) {
                return window.precosConcorrente[nomeProduto];
            }
            
            // 2. Tentar match normalizado
            const nomeNormalizado = normalizarNome(nomeProduto);
            
            for (const [chave, preco] of Object.entries(window.precosConcorrente)) {
                const chaveNormalizada = normalizarNome(chave);
                
                // Match exato normalizado
                if (chaveNormalizada === nomeNormalizado) {
                    return preco;
                }
                
                // Match parcial: verificar se um cont√©m o outro (m√≠nimo 70% das palavras)
                const palavrasProduto = nomeNormalizado.split(' ').filter(p => p.length > 2);
                const palavrasChave = chaveNormalizada.split(' ').filter(p => p.length > 2);
                
                if (palavrasProduto.length >= 2 && palavrasChave.length >= 2) {
                    let matchCount = 0;
                    palavrasProduto.forEach(palavra => {
                        if (palavrasChave.some(p => p.includes(palavra) || palavra.includes(p))) {
                            matchCount++;
                        }
                    });
                    
                    const similaridade = matchCount / palavrasProduto.length;
                    if (similaridade >= 0.7) {
                        return preco;
                    }
                }
            }
            
            return null;
        }

        function loadProducts() {
            // Processar window.todosOsProdutosV6 primeiro
            if (typeof window.todosOsProdutosV6 !== 'undefined' && Array.isArray(window.todosOsProdutosV6)) {
                // Separar produtos em planilha e sugeridos
                window.produtosPlanilha = window.todosOsProdutosV6.filter(p => p.id < 2000 || p.origem === 'planilha');
                window.produtosSugeridos = window.todosOsProdutosV6.filter(p => p.id >= 2000 || p.origem === 'sugerido');
                
                console.log('‚úÖ Produtos carregados do todosOsProdutosV6:');
                console.log('   üì¶ Planilha:', window.produtosPlanilha.length);
                console.log('   üí° Sugeridos:', window.produtosSugeridos.length);
            } else if (typeof produtosPlanilha === 'undefined' || typeof produtosSugeridos === 'undefined') {
                console.error('‚ùå ERRO: Nenhuma fonte de produtos dispon√≠vel!');
                console.error('   - window.todosOsProdutosV6:', typeof window.todosOsProdutosV6);
                console.error('   - produtosPlanilha:', typeof produtosPlanilha);
                console.error('   - produtosSugeridos:', typeof produtosSugeridos);
                
                // Fallback: inicializar arrays vazios
                window.produtosPlanilha = [];
                window.produtosSugeridos = [];
            }
            
            // Agora podemos usar as vari√°veis globais
            allProducts = [...window.produtosPlanilha, ...window.produtosSugeridos];
            
            // Adicionar precoConcorrente do mapeamento se dispon√≠vel
            if (typeof window.precosConcorrente !== 'undefined') {
                let matchedCount = 0;
                let notMatchedProducts = [];
                
                allProducts.forEach(produto => {
                    // Buscar pre√ßo do concorrente com algoritmo melhorado
                    const precoConcorrente = buscarPrecoConcorrente(produto.nome);
                    if (precoConcorrente) {
                        produto.precoConcorrente = precoConcorrente;
                        matchedCount++;
                    } else {
                        notMatchedProducts.push(produto.nome);
                    }
                });
                
                console.log('‚úÖ Pre√ßos concorrente encontrados:', matchedCount, 'de', allProducts.length);
                console.log('üìä Taxa de matching:', ((matchedCount / allProducts.length) * 100).toFixed(1) + '%');
                if (notMatchedProducts.length > 0 && notMatchedProducts.length <= 10) {
                    console.log('‚ö†Ô∏è Produtos sem pre√ßo concorrente (sample):', notMatchedProducts.slice(0, 10));
                }
            }
            
            // Adicionar linkCompra automaticamente se n√£o existir
            allProducts.forEach(produto => {
                if (!produto.linkCompra) {
                    const nomeParaURL = produto.nome
                        .replace(/\s+/g, '+')
                        .replace(/[√°√†√£√¢√§]/gi, 'a')
                        .replace(/[√©√®√™√´]/gi, 'e')
                        .replace(/[√≠√¨√Æ√Ø]/gi, 'i')
                        .replace(/[√≥√≤√µ√¥√∂]/gi, 'o')
                        .replace(/[√∫√π√ª√º]/gi, 'u')
                        .replace(/√ß/gi, 'c')
                        .replace(/[^a-zA-Z0-9+]/g, '');
                    produto.linkCompra = `https://www.amazon.com.br/s?k=${nomeParaURL}`;
                }
            });
            
            console.log('Produtos carregados:', allProducts.length);
        }

        // ============================================
        // FORMATA√á√ÉO DE PRE√áOS (Padr√£o BR: R$ 1.000,33)
        // ============================================
        function formatarPreco(valor) {
            if (typeof valor !== 'number') valor = parseFloat(valor);
            return valor.toLocaleString('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // ============================================
        // VALIDA√á√ÉO DE LINK DE COMPRA
        // ============================================
        function validarLinkCompra(link) {
            // Verifica se o link existe, n√£o √© vazio e n√£o √© apenas '#'
            if (!link || link.trim() === '' || link === '#') {
                return false;
            }
            // Verifica se come√ßa com http:// ou https://
            if (!link.startsWith('http://') && !link.startsWith('https://')) {
                return false;
            }
            // Verifica se n√£o √© um placeholder gen√©rico
            if (link.includes('exemplo.com') || link.includes('placeholder')) {
                return false;
            }
            return true;
        }

        function gerarBotaoCompraAdmin(link, miniatura = false) {
            const temLinkValido = validarLinkCompra(link);
            
            if (temLinkValido) {
                if (miniatura) {
                    // Vers√£o compacta para tabela
                    return `
                        <a href="${link}" target="_blank" rel="noopener noreferrer" 
                           class="inline-block px-3 py-1 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white text-xs rounded-lg transition-all font-semibold shadow-sm">
                            <i class="fas fa-shopping-cart mr-1"></i>Comprar
                        </a>
                    `;
                } else {
                    // Vers√£o completa
                    return `
                        <a href="${link}" target="_blank" rel="noopener noreferrer" 
                           class="inline-block w-full px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg font-bold transition-all text-center shadow-md">
                            <i class="fas fa-external-link-alt mr-2"></i>Ir para Fornecedor
                        </a>
                    `;
                }
            } else {
                if (miniatura) {
                    // Vers√£o compacta sem link
                    return `
                        <span class="inline-block px-3 py-1 bg-gray-300 text-gray-600 text-xs rounded-lg cursor-not-allowed">
                            <i class="fas fa-warehouse mr-1"></i>Sem Link
                        </span>
                    `;
                } else {
                    // Vers√£o completa sem link
                    return `
                        <div class="inline-block w-full px-4 py-2 bg-gray-300 text-gray-600 rounded-lg font-bold text-center cursor-not-allowed">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Link Indispon√≠vel
                        </div>
                    `;
                }
            }
        }

        function gerarIndicadorLinkStatus(link) {
            const temLinkValido = validarLinkCompra(link);
            
            if (temLinkValido) {
                return `<span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">
                    <i class="fas fa-check-circle mr-1"></i> Link OK
                </span>`;
            } else {
                return `<span class="inline-flex items-center px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-bold">
                    <i class="fas fa-times-circle mr-1"></i> Sem Link
                </span>`;
            }
        }

        // ============================================
        // CRUD - GERENCIAMENTO DE PRODUTOS
        // ============================================
        let currentCrudMode = 'create'; // 'create' or 'edit'
        let currentEditingProductId = null;

        // Abrir modal CRUD
        function openCrudModal(mode, productId = null) {
            currentCrudMode = mode;
            currentEditingProductId = productId;
            
            const modal = document.getElementById('crudModal');
            const title = document.getElementById('crudModalTitle');
            const submitText = document.getElementById('crudSubmitText');
            
            if (mode === 'create') {
                title.innerHTML = '<i class="fas fa-plus text-green-600 mr-2"></i>Adicionar Novo Produto';
                submitText.textContent = 'Salvar Produto';
                limparFormularioCrud();
            } else if (mode === 'edit') {
                title.innerHTML = '<i class="fas fa-edit text-blue-600 mr-2"></i>Editar Produto';
                submitText.textContent = 'Atualizar Produto';
                preencherFormularioCrud(productId);
            }
            
            modal.classList.add('active');
        }

        // Alias para compatibilidade
        function abrirCrudModal(mode, productId = null) {
            openCrudModal(mode, productId);
        }

        // Fechar modal CRUD
        function closeCrudModal() {
            document.getElementById('crudModal').classList.remove('active');
            limparFormularioCrud();
            currentEditingProductId = null;
        }

        // Limpar formul√°rio
        function limparFormularioCrud() {
            document.getElementById('crudForm').reset();
            document.getElementById('especificacoesContainer').innerHTML = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('crud_precoVendaDisplay').textContent = 'R$ 0,00';
        }

        // Preencher formul√°rio para edi√ß√£o
        function preencherFormularioCrud(productId) {
            // SEMPRE buscar produto atualizado do CRUD
            const produtosAtuais = getProdutosAtualizados();
            const produto = produtosAtuais.find(p => p.id === productId);
            if (!produto) return;

            document.getElementById('crud_sku').value = produto.sku || '';
            document.getElementById('crud_nome').value = produto.nome || '';
            document.getElementById('crud_categoria').value = produto.categoria || '';
            document.getElementById('crud_subcategoria').value = produto.subcategoria || '';
            document.getElementById('crud_fornecedor').value = produto.fornecedor || '';
            document.getElementById('crud_quantidade').value = produto.quantidade || 0;
            document.getElementById('crud_custoBase').value = produto.custoBase || 0;
            document.getElementById('crud_precoMercado').value = produto.precoMercado || 0;
            document.getElementById('crud_margem').value = produto.margem || 0;
            document.getElementById('crud_imagem').value = produto.imagem || '';
            document.getElementById('crud_descricao').value = produto.descricao || '';

            // Preview imagem
            if (produto.imagem) {
                document.getElementById('previewImg').src = produto.imagem;
                document.getElementById('imagePreview').classList.remove('hidden');
            }

            // Carregar especifica√ß√µes
            const container = document.getElementById('especificacoesContainer');
            container.innerHTML = '';
            if (produto.especificacoes) {
                Object.entries(produto.especificacoes).forEach(([key, value]) => {
                    addEspecificacao(key, value);
                });
            }

            calcularPrecoVenda();
        }

        // Calcular pre√ßo de venda
        function calcularPrecoVenda() {
            const custoBase = parseFloat(document.getElementById('crud_custoBase').value) || 0;
            const margem = parseFloat(document.getElementById('crud_margem').value) || 0;
            const precoVenda = custoBase * (1 + margem / 100);
            document.getElementById('crud_precoVendaDisplay').textContent = formatarPreco(precoVenda);
        }

        // Converter URL do Google Drive para formato direto
        function converterGoogleDriveURL(url) {
            // Padr√£o: https://drive.google.com/file/d/FILE_ID/view?usp=...
            // Converter para m√∫ltiplos formatos (fallback autom√°tico)
            const driveMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (driveMatch) {
                const fileId = driveMatch[1];
                // Tentar formato mais compat√≠vel (lh3.googleusercontent)
                // Este formato tem melhor suporte CORS
                return `https://lh3.googleusercontent.com/d/${fileId}`;
            }
            return url;
        }

        // Preview de imagem
        function previewImage() {
            let url = document.getElementById('crud_imagem').value.trim();
            const previewContainer = document.getElementById('imagePreview');
            
            console.log('üîç Preview Image chamado com URL:', url);
            
            if (!url) {
                previewContainer.classList.add('hidden');
                return;
            }
            
            // üîß AUTO-CORRE√á√ÉO: Converter URL do Google Drive
            if (url.includes('drive.google.com')) {
                const urlCorrigida = converterGoogleDriveURL(url);
                if (urlCorrigida !== url) {
                    console.log('üîß URL do Google Drive corrigida automaticamente:', urlCorrigida);
                    document.getElementById('crud_imagem').value = urlCorrigida;
                    url = urlCorrigida;
                    mostrarNotificacao('‚úÖ URL do Google Drive corrigida automaticamente', 'success');
                }
            }
            
            // üîß AUTO-CORRE√á√ÉO: Converter URL do Imgur (sem "i.") para URL direta
            if (url.match(/^https?:\/\/imgur\.com\/([a-zA-Z0-9]+)$/)) {
                const imgurCode = url.match(/^https?:\/\/imgur\.com\/([a-zA-Z0-9]+)$/)[1];
                const urlCorrigida = `https://i.imgur.com/${imgurCode}.jpg`;
                console.log('üîß URL do Imgur corrigida automaticamente:', urlCorrigida);
                
                // Atualizar campo com URL corrigida
                document.getElementById('crud_imagem').value = urlCorrigida;
                url = urlCorrigida;
                
                // Mostrar notifica√ß√£o
                mostrarNotificacao('‚úÖ URL do Imgur corrigida automaticamente para formato direto', 'success');
            }
            
            // üõ°Ô∏è Detectar base64
            if (url.startsWith('data:image/')) {
                console.warn('‚ö†Ô∏è Imagem base64 detectada no preview');
                
                // Mostrar preview MAS com aviso visual
                previewContainer.innerHTML = `
                    <div class="border-4 border-red-500 bg-red-50 p-4 rounded-lg">
                        <div class="flex items-start gap-3 mb-3">
                            <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                            <div class="flex-1">
                                <h4 class="font-bold text-red-900 mb-1">‚ö†Ô∏è AVISO: Imagem Base64 Detectada</h4>
                                <p class="text-sm text-red-800 mb-2">
                                    <strong>Esta imagem N√ÉO ser√° salva no banco de dados!</strong><br>
                                    Motivo: Base64 aumenta muito o tamanho do arquivo.
                                </p>
                                <div class="bg-white p-3 rounded border border-red-300 mb-2">
                                    <p class="text-xs font-bold text-green-900 mb-1">‚úÖ SOLU√á√ÉO RECOMENDADA:</p>
                                    <ol class="text-xs text-gray-700 list-decimal list-inside space-y-1">
                                        <li>Acesse: <a href="https://imgur.com" target="_blank" class="text-blue-600 underline">imgur.com</a>, <a href="https://imgbb.com" target="_blank" class="text-blue-600 underline">imgbb.com</a> ou <a href="https://postimages.org" target="_blank" class="text-blue-600 underline">postimages.org</a></li>
                                        <li>Fa√ßa upload da sua imagem</li>
                                        <li>Copie a URL gerada (ex: https://i.imgur.com/abc123.jpg)</li>
                                        <li>Cole aqui no campo "URL da Imagem"</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <img src="${url}" alt="Preview" class="w-48 h-48 object-contain border-2 border-red-400 rounded" 
                                 onerror="console.error('‚ùå Erro ao carregar base64'); this.src='https://via.placeholder.com/200x200/ef4444/ffffff?text=Erro+ao+Carregar'">
                        </div>
                        <p class="text-xs text-center text-red-700 mt-2 font-semibold">
                            ‚ö†Ô∏è Ao salvar, esta imagem ser√° substitu√≠da por um placeholder
                        </p>
                    </div>
                `;
                previewContainer.classList.remove('hidden');
            } else {
                // URL normal - preview padr√£o
                console.log('‚úÖ URL normal detectada, mostrando preview...');
                
                previewContainer.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${url}" alt="Preview" 
                             class="w-32 h-32 object-contain border-2 border-green-300 rounded-lg" 
                             onload="console.log('‚úÖ Imagem carregada com sucesso:', '${url}')"
                             onerror="console.error('‚ùå Erro ao carregar imagem:', '${url}'); this.parentElement.innerHTML='<div class=\\'text-red-600 p-4 bg-red-50 rounded-lg border-2 border-red-300\\'><i class=\\'fas fa-exclamation-circle mr-2\\'></i><strong>Erro ao carregar imagem</strong><br><span class=\\'text-xs\\'>Verifique se a URL est√° correta e acess√≠vel</span><br><code class=\\'text-xs bg-white p-1 rounded mt-1 block\\'>${url}</code></div>'">
                        <div class="text-sm text-green-700">
                            <i class="fas fa-check-circle mr-1"></i>
                            <strong>URL v√°lida!</strong> Esta imagem ser√° salva corretamente.
                        </div>
                    </div>
                `;
                previewContainer.classList.remove('hidden');
            }
        }

        // Adicionar campo de especifica√ß√£o
        function addEspecificacao(key = '', value = '') {
            const container = document.getElementById('especificacoesContainer');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                <input type="text" placeholder="Nome (ex: marca)" value="${key}"
                       class="flex-1 px-3 py-2 border rounded-lg spec-key" />
                <input type="text" placeholder="Valor (ex: Samsung)" value="${value}"
                       class="flex-1 px-3 py-2 border rounded-lg spec-value" />
                <button type="button" onclick="this.parentElement.remove()" 
                        class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        // Submeter formul√°rio CRUD
        // ============================================
        // HANDLER PRINCIPAL DO FORMUL√ÅRIO CRUD
        // Usa window.produtoCRUD para todas as opera√ß√µes
        // ============================================
        document.getElementById('crudForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const custoBase = parseFloat(document.getElementById('crud_custoBase').value);
            const margem = parseFloat(document.getElementById('crud_margem').value);
            const precoVenda = custoBase * (1 + margem / 100);

            // Coletar especifica√ß√µes (usando mesma l√≥gica do handler correto)
            const especificacoes = {};
            document.querySelectorAll('#especificacoesContainer > div').forEach(div => {
                const key = div.querySelector('.spec-key')?.value.trim();
                const value = div.querySelector('.spec-value')?.value.trim();
                if (key && value) {
                    especificacoes[key] = value;
                }
            });

            // Obter valor da imagem
            let imagemValue = document.getElementById('crud_imagem').value.trim();
            
            // üîß Converter Google Drive URLs automaticamente
            if (imagemValue && imagemValue.includes('drive.google.com')) {
                imagemValue = converterGoogleDriveURL(imagemValue);
            }
            
            // üõ°Ô∏è PROTE√á√ÉO: Detectar e bloquear base64
            if (imagemValue.startsWith('data:image/')) {
                console.warn('‚ö†Ô∏è Imagem base64 detectada - N√ÉO ser√° salva no banco');
                
                // Mostrar aviso ao usu√°rio
                const avisoBase64 = confirm(
                    '‚ö†Ô∏è IMAGEM BASE64 DETECTADA\n\n' +
                    '‚ùå Imagens base64 N√ÉO s√£o salvas no banco de dados\n' +
                    '‚ùå Motivo: Aumentam muito o tamanho do arquivo\n\n' +
                    '‚úÖ SOLU√á√ÉO RECOMENDADA:\n' +
                    '   1. Fa√ßa upload em: imgur.com, imgbb.com ou postimages.org\n' +
                    '   2. Copie a URL gerada\n' +
                    '   3. Cole aqui no campo de imagem\n\n' +
                    'üîÑ A imagem ser√° substitu√≠da por um placeholder.\n\n' +
                    'Deseja continuar mesmo assim?'
                );
                
                if (!avisoBase64) {
                    return; // Cancelar salvamento
                }
                
                // Substituir base64 por placeholder do Google Drive
                const nomeProduto = document.getElementById('crud_nome').value;
                // Placeholder padr√£o do Google Drive (formato lh3.googleusercontent)
                imagemValue = 'https://lh3.googleusercontent.com/d/1J5p6JhpvIhjmToS2Pxa-6lwcrYSwVol0';
                
                mostrarNotificacao(
                    '‚ö†Ô∏è Imagem base64 substitu√≠da por placeholder. Use URLs externas para imagens!',
                    'warning'
                );
            }
            
            const produtoData = {
                sku: document.getElementById('crud_sku').value,
                nome: document.getElementById('crud_nome').value,
                categoria: document.getElementById('crud_categoria').value,
                subcategoria: document.getElementById('crud_subcategoria').value,
                fornecedor: document.getElementById('crud_fornecedor').value,
                quantidade: parseInt(document.getElementById('crud_quantidade').value),
                custoBase: custoBase,
                precoMercado: parseFloat(document.getElementById('crud_precoMercado').value),
                margem: margem,
                precoVenda: precoVenda,
                imagem: imagemValue, // Usar valor filtrado (sem base64)
                descricao: document.getElementById('crud_descricao').value,
                especificacoes: Object.keys(especificacoes).length > 0 ? especificacoes : null,
                estoque: "Para Compra"
            };

            // USAR WINDOW.PRODUTOCRUD (sistema correto com sync integrado)
            if (window.produtoCRUD) {
                if (currentCrudMode === 'create') {
                    // Desabilitar bot√£o e mostrar loading
                    const submitBtn = document.querySelector('#crudForm button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';
                    
                    const resultado = window.produtoCRUD.criarProduto(produtoData, 'sugerido');
                    
                    if (resultado.sucesso) {
                        // Registrar no hist√≥rico
                        registrarAtualizacaoProduto(resultado.produto.id, produtoData.nome, 'criado');
                        
                        mostrarNotificacao('‚úÖ Produto criado com sucesso!', 'success');
                        
                        // Aguardar 500ms para usu√°rio ver a confirma√ß√£o
                        setTimeout(() => {
                            closeCrudModal();
                            atualizarInterfaceCompleta(); // Dispara renderiza√ß√£o + auto-sync
                        }, 500);
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        mostrarNotificacao('‚ùå Erro ao criar produto: ' + resultado.erro, 'error');
                    }
                } else if (currentCrudMode === 'edit') {
                    // Desabilitar bot√£o e mostrar loading
                    const submitBtn = document.querySelector('#crudForm button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Atualizando...';
                    
                    const resultado = window.produtoCRUD.atualizarProduto(currentEditingProductId, produtoData);
                    
                    if (resultado.sucesso) {
                        // Registrar no hist√≥rico
                        registrarAtualizacaoProduto(currentEditingProductId, produtoData.nome, 'editado');
                        
                        mostrarNotificacao('‚úÖ Produto atualizado com sucesso!', 'success');
                        
                        // Aguardar 500ms para usu√°rio ver a confirma√ß√£o
                        setTimeout(() => {
                            closeCrudModal();
                            atualizarInterfaceCompleta(); // Dispara renderiza√ß√£o + auto-sync
                        }, 500);
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        mostrarNotificacao('‚ùå Erro ao atualizar produto: ' + resultado.erro, 'error');
                    }
                }
            } else {
                // Fallback se produtoCRUD n√£o estiver carregado
                mostrarNotificacao('‚ùå Sistema CRUD n√£o est√° dispon√≠vel. Recarregue a p√°gina.', 'error');
                console.error('window.produtoCRUD n√£o est√° dispon√≠vel!');
            }
        });

        // ============================================
        // DELETAR PRODUTO - Usa window.produtoCRUD
        // ============================================
        function deletarProduto(productId) {
            // Buscar produto atualizado do CRUD
            const produtosAtuais = getProdutosAtualizados();
            const produto = produtosAtuais.find(p => p.id === productId);
            
            if (!produto) {
                mostrarNotificacao('‚ùå Produto n√£o encontrado!', 'error');
                return;
            }

            if (confirm(`‚ö†Ô∏è Tem certeza que deseja deletar o produto:\n\n"${produto.nome}"\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                // USAR WINDOW.PRODUTOCRUD (sistema correto com sync integrado)
                if (window.produtoCRUD) {
                    const resultado = window.produtoCRUD.excluirProduto(productId, true);
                    
                    if (resultado.sucesso) {
                        mostrarNotificacao('üóëÔ∏è Produto deletado com sucesso!', 'success');
                        atualizarInterfaceCompleta(); // Dispara renderiza√ß√£o + auto-sync
                        
                        // Fechar modal se estiver aberto
                        if (typeof closeModal === 'function') {
                            closeModal();
                        }
                    } else {
                        mostrarNotificacao('‚ùå Erro ao deletar produto: ' + resultado.erro, 'error');
                    }
                } else {
                    mostrarNotificacao('‚ùå Sistema CRUD n√£o est√° dispon√≠vel. Recarregue a p√°gina.', 'error');
                    console.error('window.produtoCRUD n√£o est√° dispon√≠vel!');
                }
            }
        }

        // Click fora do modal CRUD para fechar
        document.getElementById('crudModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCrudModal();
            }
        });

        // Tab Switching
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            document.getElementById('tab-' + tabName).classList.remove('tab-inactive');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById('content-' + tabName).classList.remove('hidden');
            
            // Atualizar dados ao mudar de aba
            if (tabName === 'comparativo') {
                // Recarregar comparativo com produtos atualizados
                console.log('üîÑ Atualizando aba comparativo com produtos mais recentes...');
                renderComparativo();
            } else if (tabName === 'dashboard') {
                // Atualizar dashboard
                renderDashboard();
            } else if (tabName === 'sugestoes') {
                // Atualizar sugest√µes
                renderSugestoes();
            } else if (tabName === 'catalogo') {
                // Atualizar cat√°logo
                renderCatalogo();
            } else if (tabName === 'analise') {
                // Atualizar an√°lise
                renderAnalise();
            }
            
            // Limpar status de ferramentas ao mudar de aba
            if (tabName !== 'ferramentas') {
                const ferramentasStatus = document.getElementById('ferramentasStatus');
                if (ferramentasStatus) {
                    ferramentasStatus.classList.add('hidden');
                }
            }
        }

        // Initialize Filters
        function initializeFilters() {
            // Get unique categories
            const categories = [...new Set(allProducts.map(p => p.categoria))];
            const subcategories = [...new Set(allProducts.map(p => p.subcategoria))];
            
            // Populate category filters
            const categorySelects = ['filterCategory', 'filterCatalogoCategory'];
            categorySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            });
            
            // Populate subcategory filter
            const subcategorySelect = document.getElementById('filterSubcategory');
            subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subcategorySelect.appendChild(option);
            });

            // Add event listeners
            document.getElementById('searchDashboard').addEventListener('input', renderDashboard);
            document.getElementById('filterCategory').addEventListener('change', renderDashboard);
            document.getElementById('searchSugestoes').addEventListener('input', renderSugestoes);
            document.getElementById('filterSubcategory').addEventListener('change', renderSugestoes);
            document.getElementById('filterNovos').addEventListener('change', renderSugestoes);
            document.getElementById('searchCatalogo').addEventListener('input', renderCatalogo);
            document.getElementById('filterCatalogoCategory').addEventListener('change', renderCatalogo);
            document.getElementById('sortCatalogo').addEventListener('change', renderCatalogo);
        }

        // Update Stats
        function updateStats() {
            // Sempre usar produtos atualizados do CRUD
            const produtosAtuais = getProdutosAtualizados();
            const produtosPlanilhaAtuais = produtosAtuais.filter(p => p.origem === 'planilha' || p.id < 2000);
            const produtosSugeridosAtuais = produtosAtuais.filter(p => p.origem === 'sugerido' || p.id >= 2000);
            
            const totalBudget = produtosAtuais.reduce((sum, p) => sum + (p.custoBase * p.quantidade), 0);
            document.getElementById('totalBudget').textContent = formatarPreco(totalBudget);
            document.getElementById('totalProducts').textContent = produtosAtuais.length;
            
            document.getElementById('stat-total').textContent = produtosAtuais.length;
            document.getElementById('stat-planilha').textContent = produtosPlanilhaAtuais.length;
            document.getElementById('stat-sugestoes').textContent = produtosSugeridosAtuais.length;
            
            const uniqueSubcategories = [...new Set(produtosAtuais.map(p => p.subcategoria))];
            document.getElementById('stat-categorias').textContent = uniqueSubcategories.length;
        }

        // Render Dashboard
        function renderDashboard() {
            const search = document.getElementById('searchDashboard').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;
            
            // Sempre usar produtos atualizados do CRUD
            const produtosAtuais = getProdutosAtualizados();
            
            let filtered = produtosAtuais.filter(p => {
                const matchSearch = p.nome.toLowerCase().includes(search) || 
                                   p.sku.toLowerCase().includes(search);
                const matchCategory = !categoryFilter || p.categoria === categoryFilter;
                return matchSearch && matchCategory;
            });

            const container = document.getElementById('dashboardProductsList');
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum produto encontrado</p>';
                return;
            }

            let html = `
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">SKU</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Produto</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Categoria</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Qtd</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Custo Fornecedor Prio</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Venda</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Margem</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Link Compra</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            filtered.forEach(produto => {
                const badge = produto.badge ? `<span class="ml-2 text-xs px-2 py-1 bg-red-100 text-red-600 rounded-full">${produto.badge}</span>` : '';
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-mono">${produto.sku}</td>
                        <td class="px-4 py-3 text-sm font-medium">${produto.nome}${badge}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${produto.subcategoria}</td>
                        <td class="px-4 py-3 text-sm text-right">${produto.quantidade}</td>
                        <td class="px-4 py-3 text-sm text-right">
                            ${produto.precoConcorrente ? 
                                formatarPreco(produto.precoConcorrente) : 
                                '<span class="text-red-500 font-bold">‚ùå</span>'
                            }
                        </td>
                        <td class="px-4 py-3 text-sm text-right font-semibold">${formatarPreco(produto.precoVenda)}</td>
                        <td class="px-4 py-3 text-sm text-right">
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                                ${produto.margem}%
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            ${produto.linkCompra ? 
                                '<a href="' + produto.linkCompra + '" target="_blank" ' +
                                   'class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-lg text-xs font-semibold transition-all">' +
                                    '<i class="fas fa-shopping-cart mr-1"></i> Comprar' +
                                '</a>'
                            : 
                                '<span class="text-gray-400 text-xs">N/A</span>'
                            }
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex gap-2 justify-center">
                                <button onclick="showProductModal(${produto.id})" 
                                        class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-xs"
                                        title="Ver Detalhes">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="openCrudModal('edit', ${produto.id})" 
                                        class="px-2 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 transition text-xs"
                                        title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            
            // Update charts
            updateCategoryChart();
            updatePriceChart();
        }

        // Render Sugest√µes
        function renderSugestoes() {
            const search = document.getElementById('searchSugestoes').value.toLowerCase();
            const subcategoryFilter = document.getElementById('filterSubcategory').value;
            const novosOnly = document.getElementById('filterNovos').checked;
            
            // Sempre usar produtos atualizados do CRUD (apenas sugeridos)
            const produtosAtuais = getProdutosAtualizados();
            const produtosSugeridosAtuais = produtosAtuais.filter(p => p.origem === 'sugerido' || p.id >= 2000);
            
            // Calcular estat√≠sticas ANTES de filtrar
            const totalProdutos = produtosSugeridosAtuais.length;
            const produtosNovos = produtosSugeridosAtuais.filter(p => p.badge && p.badge.includes('NOVO')).length;
            const investimentoTotal = produtosSugeridosAtuais.reduce((sum, p) => sum + (p.custoBase * p.quantidade), 0);
            const receitaTotal = produtosSugeridosAtuais.reduce((sum, p) => sum + (p.precoVenda * p.quantidade), 0);
            const lucroProjetado = receitaTotal - investimentoTotal;
            
            // Atualizar estat√≠sticas na interface
            document.getElementById('stat-sugestoes-total').textContent = totalProdutos;
            document.getElementById('stat-sugestoes-novos').textContent = produtosNovos;
            document.getElementById('stat-sugestoes-investimento').textContent = 'R$ ' + investimentoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('stat-sugestoes-lucro').textContent = 'R$ ' + lucroProjetado.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            // Filtrar produtos para exibi√ß√£o
            let filtered = produtosSugeridosAtuais.filter(p => {
                const matchSearch = p.nome.toLowerCase().includes(search) || 
                                   p.sku.toLowerCase().includes(search);
                const matchSubcategory = !subcategoryFilter || p.subcategoria === subcategoryFilter;
                const matchNovos = !novosOnly || (p.badge && p.badge.includes('NOVO'));
                return matchSearch && matchSubcategory && matchNovos;
            });

            const container = document.getElementById('sugestoesGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Nenhum produto encontrado</div>';
                return;
            }

            container.innerHTML = filtered.map(produto => `
                <div class="product-card glass-card rounded-xl shadow-lg overflow-hidden">
                    <div class="relative cursor-pointer" onclick="showProductModal(${produto.id})">
                        <img src="${produto.imagem}" alt="${produto.nome}" 
                             class="w-full h-48 object-contain bg-gray-50 p-4"
                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27300%27%3E%3Crect fill=%27%23f3f4f6%27 width=%27300%27 height=%27300%27/%3E%3Ctext fill=%27%239ca3af%27 font-family=%27Arial%27 font-size=%2716%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3EImagem Indispon%C3%ADvel%3C/text%3E%3C/svg%3E'">
                        ${produto.badge ? 
                            '<span class="absolute top-2 right-2 badge-novo px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">' +
                                produto.badge +
                            '</span>'
                        : ''}
                    </div>
                    <div class="p-4">
                        <div class="text-xs text-gray-500 mb-1">${produto.subcategoria}</div>
                        <h3 class="font-bold text-gray-800 mb-2 line-clamp-2 min-h-[3rem] cursor-pointer" onclick="showProductModal(${produto.id})">${produto.nome}</h3>
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">${produto.descricao}</p>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">Custo Base:</span>
                            <span class="font-semibold text-gray-700">R$ ${produto.custoBase.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">Pre√ßo Venda:</span>
                            <span class="font-bold text-purple-600 text-lg">R$ ${produto.precoVenda.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t mb-3">
                            <span class="text-sm">Margem: <span class="font-bold text-green-600">${produto.margem}%</span></span>
                            <span class="text-sm text-gray-500">Qtd: ${produto.quantidade}</span>
                        </div>
                        
                        <!-- Bot√µes CRUD -->
                        <div class="flex gap-2">
                            <button onclick="event.stopPropagation(); openCrudModal('edit', ${produto.id})" 
                                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-2 rounded transition-all flex items-center justify-center gap-1"
                                    title="Editar produto">
                                <i class="fas fa-edit"></i>
                                <span class="hidden sm:inline">Editar</span>
                            </button>
                            <button onclick="event.stopPropagation(); duplicarProduto(${produto.id})" 
                                    class="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-xs py-2 px-2 rounded transition-all flex items-center justify-center gap-1"
                                    title="Duplicar produto">
                                <i class="fas fa-copy"></i>
                                <span class="hidden sm:inline">Duplicar</span>
                            </button>
                            <button onclick="event.stopPropagation(); deletarProduto(${produto.id})" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white text-xs py-2 px-2 rounded transition-all flex items-center justify-center gap-1"
                                    title="Deletar produto">
                                <i class="fas fa-trash"></i>
                                <span class="hidden sm:inline">Deletar</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render Cat√°logo
        function renderCatalogo() {
            const search = document.getElementById('searchCatalogo').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCatalogoCategory').value;
            const sortBy = document.getElementById('sortCatalogo').value;
            
            // Sempre usar produtos atualizados do CRUD
            const produtosAtuais = getProdutosAtualizados();
            
            let filtered = produtosAtuais.filter(p => {
                const matchSearch = p.nome.toLowerCase().includes(search);
                const matchCategory = !categoryFilter || p.categoria === categoryFilter;
                return matchSearch && matchCategory;
            });

            // Sort
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'nome':
                        return a.nome.localeCompare(b.nome);
                    case 'preco-asc':
                        return a.precoVenda - b.precoVenda;
                    case 'preco-desc':
                        return b.precoVenda - a.precoVenda;
                    case 'margem-desc':
                        return b.margem - a.margem;
                    default:
                        return 0;
                }
            });

            const container = document.getElementById('catalogoGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Nenhum produto encontrado</div>';
                return;
            }

            container.innerHTML = filtered.map(produto => `
                <div class="product-card glass-card rounded-xl shadow-lg overflow-hidden cursor-pointer" 
                     onclick="showProductModal(${produto.id})">
                    <div class="relative">
                        <img src="${produto.imagem}" alt="${produto.nome}" 
                             class="w-full h-40 object-contain bg-gray-50 p-3"
                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27300%27%3E%3Crect fill=%27%23f3f4f6%27 width=%27300%27 height=%27300%27/%3E%3Ctext fill=%27%239ca3af%27 font-family=%27Arial%27 font-size=%2716%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3EImagem Indispon%C3%ADvel%3C/text%3E%3C/svg%3E'">
                        ${produto.badge ? 
                            '<span class="absolute top-2 right-2 px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-full">' +
                                produto.badge +
                            '</span>'
                        : ''}
                    </div>
                    <div class="p-3">
                        <div class="text-xs text-gray-500 mb-1">${produto.subcategoria}</div>
                        <h3 class="font-bold text-sm text-gray-800 mb-2 line-clamp-2 min-h-[2.5rem]">${produto.nome}</h3>
                        <div class="text-center pt-2 border-t">
                            <div class="text-xl font-bold text-blue-600">${formatarPreco(produto.precoVenda)}</div>
                            <div class="text-xs text-gray-500 mt-1">Margem ${produto.margem}%</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render An√°lise
        function renderAnalise() {
            // Sempre usar produtos atualizados do CRUD
            const produtosAtuais = getProdutosAtualizados();
            
            // Top 10 por Margem
            const topMargem = [...produtosAtuais]
                .sort((a, b) => b.margem - a.margem)
                .slice(0, 10);
            
            document.getElementById('topMargemList').innerHTML = topMargem.map((p, i) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl font-bold text-purple-600">${i + 1}</span>
                        <div>
                            <div class="font-semibold text-sm">${p.nome.substring(0, 40)}...</div>
                            <div class="text-xs text-gray-500">${p.subcategoria}</div>
                        </div>
                    </div>
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold">
                        ${p.margem}%
                    </span>
                </div>
            `).join('');

            // Stock Analysis
            const totalEstoque = produtosAtuais.reduce((sum, p) => sum + p.quantidade, 0);
            const estoqueValor = produtosAtuais.reduce((sum, p) => sum + (p.custoBase * p.quantidade), 0);
            const baixoEstoque = produtosAtuais.filter(p => p.quantidade < 10).length;
            
            document.getElementById('stockAnalysis').innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="text-sm text-gray-600">Total em Estoque</div>
                        <div class="text-2xl font-bold text-blue-600">${totalEstoque} unidades</div>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <div class="text-sm text-gray-600">Valor do Estoque</div>
                        <div class="text-2xl font-bold text-green-600">R$ ${estoqueValor.toLocaleString('pt-BR')}</div>
                    </div>
                    <div class="p-4 bg-orange-50 rounded-lg">
                        <div class="text-sm text-gray-600">Baixo Estoque (< 10)</div>
                        <div class="text-2xl font-bold text-orange-600">${baixoEstoque} produtos</div>
                    </div>
                </div>
            `;

            // Update charts
            updateMargemChart();
            updateCategoryPerformance();
        }

        // Show Product Modal
        function showProductModal(productId) {
            // CORRE√á√ÉO v6.7: Usar produtos atualizados do CRUD (n√£o allProducts est√°tico)
            const produtosAtuais = getProdutosAtualizados();
            const produto = produtosAtuais.find(p => p.id === productId);
            
            if (!produto) {
                console.error('Produto n√£o encontrado:', productId);
                mostrarNotificacao('‚ùå Produto n√£o encontrado!', 'error');
                return;
            }

            const modal = document.getElementById('productModal');
            const content = document.getElementById('modalProductContent');
            
            const lucro = produto.precoVenda - produto.custoBase;
            const lucroPercentual = ((lucro / produto.custoBase) * 100).toFixed(1);
            
            content.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">${produto.nome}</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img src="${produto.imagem}" alt="${produto.nome}" 
                             class="w-full rounded-lg shadow-lg"
                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27400%27 height=%27400%27%3E%3Crect fill=%27%23f3f4f6%27 width=%27400%27 height=%27400%27/%3E%3Ctext fill=%27%239ca3af%27 font-family=%27Arial%27 font-size=%2720%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3EImagem Indispon%C3%ADvel%3C/text%3E%3C/svg%3E'">
                        ${produto.badge ? 
                            '<div class="mt-4 text-center">' +
                                '<span class="inline-block px-4 py-2 bg-red-500 text-white font-bold rounded-full">' +
                                    produto.badge +
                                '</span>' +
                            '</div>'
                        : ''}
                    </div>

                    <div>
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Informa√ß√µes Gerais</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">SKU:</span>
                                    <span class="font-mono font-semibold">${produto.sku}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Categoria:</span>
                                    <span class="font-semibold">${produto.categoria}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Subcategoria:</span>
                                    <span class="font-semibold">${produto.subcategoria}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Fornecedor:</span>
                                    <span class="font-semibold">${produto.fornecedor}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Quantidade:</span>
                                    <span class="font-semibold text-blue-600">${produto.quantidade} unidades</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">Precifica√ß√£o</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Custo Base:</span>
                                    <span class="font-semibold">${formatarPreco(produto.custoBase)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Pre√ßo Mercado:</span>
                                    <span class="font-semibold">${formatarPreco(produto.precoMercado)}</span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-gray-800 font-bold">Pre√ßo Venda:</span>
                                    <span class="text-xl font-bold text-purple-600">${formatarPreco(produto.precoVenda)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Lucro Unit√°rio:</span>
                                    <span class="font-bold text-green-600">${formatarPreco(lucro)} (${lucroPercentual}%)</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Margem:</span>
                                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full font-bold">
                                        ${produto.margem}%
                                    </span>
                                </div>
                            </div>
                        </div>

                        ${produto.especificacoes ? 
                            '<div class="mb-6">' +
                                '<h3 class="text-lg font-bold text-gray-800 mb-2">Especifica√ß√µes</h3>' +
                                '<div class="space-y-1 text-sm">' +
                                    Object.entries(produto.especificacoes).map(([key, value]) => 
                                        '<div class="flex justify-between">' +
                                            '<span class="text-gray-600 capitalize">' + key + ':</span>' +
                                            '<span class="font-semibold">' + value + '</span>' +
                                        '</div>'
                                    ).join('') +
                                '</div>' +
                            '</div>'
                        : ''}

                        <div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Descri√ß√£o</h3>
                            <p class="text-gray-600 text-sm leading-relaxed">${produto.descricao}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-2">Proje√ß√£o de Vendas</h3>
                    <div class="grid grid-cols-3 gap-4 text-center text-sm">
                        <div>
                            <div class="text-gray-600">Investimento Total</div>
                            <div class="text-xl font-bold text-gray-800">${formatarPreco(produto.custoBase * produto.quantidade)}</div>
                        </div>
                        <div>
                            <div class="text-gray-600">Receita Potencial</div>
                            <div class="text-xl font-bold text-blue-600">${formatarPreco(produto.precoVenda * produto.quantidade)}</div>
                        </div>
                        <div>
                            <div class="text-gray-600">Lucro Total</div>
                            <div class="text-xl font-bold text-green-600">${formatarPreco(lucro * produto.quantidade)}</div>
                        </div>
                    </div>
                </div>

                <!-- Mensagem informativa: Editar via modal CRUD -->
                <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <p class="text-sm text-gray-700">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                        <strong>Para editar este produto:</strong> Clique no bot√£o "Editar" na tabela ou acesse a aba "An√°lise Comparativa".
                    </p>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        // Garantir que a fun√ß√£o est√° no escopo global
        window.showProductModal = showProductModal;

        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        // Click outside modal to close
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ===== EDITOR DE MARGEM =====
        
        let currentEditingProduct = null;

        function openMargemEditor(productId) {
            currentEditingProduct = allProducts.find(p => p.id === productId);
            if (!currentEditingProduct) return;

            const modal = document.getElementById('margemModal');
            const content = document.getElementById('margemEditorContent');
            
            const margemAtual = currentEditingProduct.margem || 30;
            const custoBase = currentEditingProduct.custoBase;
            const precoMercado = currentEditingProduct.precoMercado;
            
            content.innerHTML = `
                <div class="mb-6">
                    <h3 class="font-bold text-lg text-gray-800 mb-2">${currentEditingProduct.nome}</h3>
                    <p class="text-sm text-gray-600">SKU: ${currentEditingProduct.sku}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Custo Base</div>
                        <div class="text-2xl font-bold text-gray-800">R$ ${custoBase.toFixed(2)}</div>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Pre√ßo Mercado</div>
                        <div class="text-2xl font-bold text-gray-800">R$ ${precoMercado.toFixed(2)}</div>
                    </div>
                </div>

                <div class="mb-6 p-6 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border-2 border-purple-200">
                    <label class="block text-sm font-bold text-gray-700 mb-3">
                        <i class="fas fa-sliders-h mr-2"></i>Margem de Lucro (%)
                    </label>
                    
                    <div class="flex items-center gap-4 mb-4">
                        <input type="range" id="margemSlider" 
                               min="0" max="100" step="0.5" value="${margemAtual}"
                               class="flex-1 h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                               oninput="updateMargemPreview(this.value)">
                        
                        <input type="number" id="margemInput" 
                               value="${margemAtual}" 
                               min="0" max="100" step="0.5"
                               class="w-24 px-3 py-2 border-2 border-purple-300 rounded-lg text-center font-bold text-lg focus:ring-2 focus:ring-purple-500"
                               oninput="updateMargemFromInput(this.value)">
                        <span class="text-xl font-bold text-purple-600">%</span>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button onclick="setMargem(20)" class="px-3 py-1 bg-white border border-purple-300 rounded text-sm hover:bg-purple-100">20%</button>
                        <button onclick="setMargem(25)" class="px-3 py-1 bg-white border border-purple-300 rounded text-sm hover:bg-purple-100">25%</button>
                        <button onclick="setMargem(30)" class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">30% (Padr√£o)</button>
                        <button onclick="setMargem(35)" class="px-3 py-1 bg-white border border-purple-300 rounded text-sm hover:bg-purple-100">35%</button>
                        <button onclick="setMargem(40)" class="px-3 py-1 bg-white border border-purple-300 rounded text-sm hover:bg-purple-100">40%</button>
                    </div>
                </div>

                <div class="mb-6 p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg border-2 border-green-300">
                    <h4 class="font-bold text-lg text-gray-800 mb-4">
                        <i class="fas fa-calculator mr-2 text-green-600"></i>
                        C√°lculo Autom√°tico
                    </h4>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Custo Base:</span>
                            <span class="font-bold text-gray-800">${formatarPreco(custoBase)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Margem Aplicada:</span>
                            <span id="margemDisplay" class="font-bold text-purple-600">${margemAtual}%</span>
                        </div>
                        
                        <div class="flex justify-between items-center pt-3 border-t-2 border-green-200">
                            <span class="text-lg font-bold text-gray-800">Pre√ßo de Venda:</span>
                            <span id="precoVendaDisplay" class="text-3xl font-bold text-green-600">
                                ${formatarPreco(custoBase * (1 + margemAtual/100))}
                            </span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Lucro Unit√°rio:</span>
                            <span id="lucroDisplay" class="font-bold text-green-700">
                                ${formatarPreco(custoBase * (margemAtual/100))}
                            </span>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Lucro Total (${currentEditingProduct.quantidade} un):</span>
                            <span id="lucroTotalDisplay" class="font-bold text-green-700">
                                ${formatarPreco(custoBase * (margemAtual/100) * currentEditingProduct.quantidade)}
                            </span>
                        </div>

                        <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                            <div class="text-xs text-gray-600 mb-1">Economia vs Mercado:</div>
                            <div id="economiaDisplay" class="text-sm font-bold">
                                ${calcularEconomia(custoBase, margemAtual, precoMercado)}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="salvarMargem()" 
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-lg hover:shadow-xl transition">
                        <i class="fas fa-save mr-2"></i>Salvar Margem
                    </button>
                    <button onclick="closeMargemModal()" 
                            class="px-6 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                </div>

                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <p class="text-xs text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>Nota:</strong> A altera√ß√£o da margem ser√° salva localmente e aplicada a todos os sistemas (Admin e Cliente).
                        O cliente ver√° apenas o pre√ßo final com a margem aplicada, sem visualizar o percentual de lucro.
                    </p>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function updateMargemPreview(valor) {
            const margem = parseFloat(valor);
            document.getElementById('margemInput').value = margem.toFixed(1);
            recalcularPrecos(margem);
        }

        function updateMargemFromInput(valor) {
            const margem = parseFloat(valor);
            if (margem >= 0 && margem <= 100) {
                document.getElementById('margemSlider').value = margem;
                recalcularPrecos(margem);
            }
        }

        function setMargem(valor) {
            document.getElementById('margemSlider').value = valor;
            document.getElementById('margemInput').value = valor;
            recalcularPrecos(valor);
        }

        function recalcularPrecos(margem) {
            if (!currentEditingProduct) return;
            
            const custoBase = currentEditingProduct.custoBase;
            const quantidade = currentEditingProduct.quantidade;
            const precoMercado = currentEditingProduct.precoMercado;
            
            const precoVenda = custoBase * (1 + margem/100);
            const lucro = custoBase * (margem/100);
            const lucroTotal = lucro * quantidade;
            
            document.getElementById('margemDisplay').textContent = margem.toFixed(1) + '%';
            document.getElementById('precoVendaDisplay').textContent = formatarPreco(precoVenda);
            document.getElementById('lucroDisplay').textContent = formatarPreco(lucro);
            document.getElementById('lucroTotalDisplay').textContent = formatarPreco(lucroTotal);
            document.getElementById('economiaDisplay').innerHTML = calcularEconomia(custoBase, margem, precoMercado);
        }

        function calcularEconomia(custoBase, margem, precoMercado) {
            const precoVenda = custoBase * (1 + margem/100);
            const economia = precoMercado - precoVenda;
            const economiaPercent = ((economia / precoMercado) * 100).toFixed(1);
            
            if (economia > 0) {
                return `<span class="text-green-600">Cliente economiza ${formatarPreco(economia)} (${economiaPercent}%)</span>`;
            } else if (economia < 0) {
                return `<span class="text-red-600">‚ö†Ô∏è Pre√ßo acima do mercado em ${formatarPreco(Math.abs(economia))}</span>`;
            } else {
                return `<span class="text-gray-600">Mesmo pre√ßo do mercado</span>`;
            }
        }

        function salvarMargem() {
            if (!currentEditingProduct) return;
            
            const novaMargem = parseFloat(document.getElementById('margemInput').value);
            
            if (novaMargem < 0 || novaMargem > 100) {
                mostrarNotificacao('‚ùå Margem deve estar entre 0% e 100%', 'error');
                return;
            }
            
            // Atualizar produto usando o sistema CRUD para garantir sincroniza√ß√£o
            if (window.produtoCRUD) {
                // Buscar produto atualizado do CRUD
                const produtosAtuais = getProdutosAtualizados();
                const produto = produtosAtuais.find(p => p.id === currentEditingProduct.id);
                
                if (produto) {
                    // Calcular novo pre√ßo de venda
                    const novoPrecoVenda = produto.custoBase * (1 + novaMargem/100);
                    
                    // Preparar dados atualizados
                    const produtoAtualizado = {
                        ...produto,
                        margem: novaMargem,
                        precoVenda: novoPrecoVenda
                    };
                    
                    // Atualizar via CRUD (garante sync em todas as p√°ginas)
                    console.log('üîÑ Salvando margem via CRUD:', {
                        produtoId: produto.id,
                        nome: produto.nome,
                        margemAntiga: produto.margem,
                        margemNova: novaMargem,
                        precoVendaAntigo: produto.precoVenda,
                        precoVendaNovo: novoPrecoVenda
                    });
                    
                    const resultado = window.produtoCRUD.atualizarProduto(produto.id, produtoAtualizado);
                    
                    if (resultado.sucesso) {
                        console.log('‚úÖ Margem atualizada via CRUD - Auto-sync ser√° disparado automaticamente');
                        
                        // Registrar no hist√≥rico
                        registrarAtualizacaoProduto(produto.id, produto.nome, 'margem atualizada');
                        
                        // Feedback visual
                        mostrarNotificacao('‚úÖ Margem atualizada! Auto-sync ativado...', 'success');
                        
                        // Fechar modal de margem
                        closeMargemModal();
                        
                        // NOTA: atualizarInterfaceCompleta() e dispararAutoSync() s√£o chamados
                        // automaticamente pelo listener do CRUD (linha 4174-4189)
                        // N√£o √© necess√°rio chamar novamente aqui!
                    } else {
                        mostrarNotificacao('‚ùå Erro ao atualizar margem: ' + resultado.erro, 'error');
                    }
                } else {
                    mostrarNotificacao('‚ùå Produto n√£o encontrado!', 'error');
                }
            } else {
                mostrarNotificacao('‚ùå Sistema CRUD n√£o dispon√≠vel. Recarregue a p√°gina.', 'error');
                console.error('window.produtoCRUD n√£o est√° dispon√≠vel!');
            }
        }

        function salvarMargemNoStorage(productId, margem, precoVenda) {
            let margens = JSON.parse(localStorage.getItem('margensProdutos') || '{}');
            margens[productId] = {
                margem: margem,
                precoVenda: precoVenda,
                dataAtualizacao: new Date().toISOString()
            };
            localStorage.setItem('margensProdutos', JSON.stringify(margens));
        }

        function carregarMargensDoStorage() {
            const margens = JSON.parse(localStorage.getItem('margensProdutos') || '{}');
            
            Object.keys(margens).forEach(productId => {
                const produto = allProducts.find(p => p.id === parseInt(productId));
                if (produto) {
                    produto.margem = margens[productId].margem;
                    produto.precoVenda = margens[productId].precoVenda;
                }
            });
        }

        function closeMargemModal() {
            document.getElementById('margemModal').classList.remove('active');
            currentEditingProduct = null;
        }

        // Click outside to close margem modal
        document.getElementById('margemModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMargemModal();
            }
        });

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-xl text-white font-semibold transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Carregar margens salvas ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                carregarMargensDoStorage();
                updateStats();
            }, 100);
        });

        // Charts
        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;

            // Sempre usar produtos atualizados do CRUD
            const produtosAtuais = getProdutosAtualizados();
            
            const subcategories = {};
            produtosAtuais.forEach(p => {
                subcategories[p.subcategoria] = (subcategories[p.subcategoria] || 0) + 1;
            });

            const data = {
                labels: Object.keys(subcategories),
                datasets: [{
                    label: 'Quantidade de Produtos',
                    data: Object.values(subcategories),
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#4facfe',
                        '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                        '#a8edea', '#fed6e3'
                    ]
                }]
            };

            if (charts.category) {
                charts.category.destroy();
            }

            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function updatePriceChart() {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;

            // Sempre usar produtos atualizados do CRUD
            const produtosAtuais = getProdutosAtualizados();
            
            const ranges = {
                '< R$ 500': 0,
                'R$ 500-1000': 0,
                'R$ 1000-2000': 0,
                'R$ 2000-5000': 0,
                '> R$ 5000': 0
            };

            produtosAtuais.forEach(p => {
                if (p.precoVenda < 500) ranges['< R$ 500']++;
                else if (p.precoVenda < 1000) ranges['R$ 500-1000']++;
                else if (p.precoVenda < 2000) ranges['R$ 1000-2000']++;
                else if (p.precoVenda < 5000) ranges['R$ 2000-5000']++;
                else ranges['> R$ 5000']++;
            });

            if (charts.price) {
                charts.price.destroy();
            }

            charts.price = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'N√∫mero de Produtos',
                        data: Object.values(ranges),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 5
                            }
                        }
                    }
                }
            });
        }

        function updateMargemChart() {
            const ctx = document.getElementById('margemChart');
            if (!ctx) return;

            const ranges = {
                '< 20%': 0,
                '20-25%': 0,
                '25-30%': 0,
                '> 30%': 0
            };

            allProducts.forEach(p => {
                if (p.margem < 20) ranges['< 20%']++;
                else if (p.margem < 25) ranges['20-25%']++;
                else if (p.margem < 30) ranges['25-30%']++;
                else ranges['> 30%']++;
            });

            if (charts.margem) {
                charts.margem.destroy();
            }

            charts.margem = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'N√∫mero de Produtos',
                        data: Object.values(ranges),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCategoryPerformance() {
            const subcategoryStats = {};
            
            allProducts.forEach(p => {
                if (!subcategoryStats[p.subcategoria]) {
                    subcategoryStats[p.subcategoria] = {
                        count: 0,
                        totalCusto: 0,
                        totalVenda: 0,
                        avgMargem: 0
                    };
                }
                
                const stats = subcategoryStats[p.subcategoria];
                stats.count++;
                stats.totalCusto += p.custoBase * p.quantidade;
                stats.totalVenda += p.precoVenda * p.quantidade;
                stats.avgMargem += p.margem;
            });

            // Calculate averages
            Object.keys(subcategoryStats).forEach(sub => {
                subcategoryStats[sub].avgMargem = (subcategoryStats[sub].avgMargem / subcategoryStats[sub].count).toFixed(1);
                subcategoryStats[sub].lucro = subcategoryStats[sub].totalVenda - subcategoryStats[sub].totalCusto;
            });

            // Sort by lucro
            const sorted = Object.entries(subcategoryStats)
                .sort((a, b) => b[1].lucro - a[1].lucro);

            const container = document.getElementById('categoryPerformance');
            container.innerHTML = `
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Subcategoria</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Produtos</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Investimento</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Receita</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Lucro</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Margem M√©dia</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${sorted.map(([sub, stats]) => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium">${sub}</td>
                                <td class="px-4 py-3 text-sm text-center">${stats.count}</td>
                                <td class="px-4 py-3 text-sm text-right">R$ ${stats.totalCusto.toFixed(2)}</td>
                                <td class="px-4 py-3 text-sm text-right font-semibold text-blue-600">R$ ${stats.totalVenda.toFixed(2)}</td>
                                <td class="px-4 py-3 text-sm text-right font-bold text-green-600">R$ ${stats.lucro.toFixed(2)}</td>
                                <td class="px-4 py-3 text-center">
                                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                                        ${stats.avgMargem}%
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // ============================================
        // FUN√á√ïES PARA ABA DE CUPONS
        // ============================================
        // BUSCAR NOVOS CUPONS
        // ============================================
        let cuponsAtuais = [];
        
        function gerarCupomAleatorio() {
            const lojas = [
                'Amazon', 'Mercado Livre', 'Magazine Luiza', 'Americanas',
                'Casas Bahia', 'Extra', 'Submarino', 'Shopee',
                'Kabum', 'Ponto Frio', 'Fast Shop', 'Carrefour'
            ];
            
            const categorias = [
                ['Eletr√¥nicos', 'Smartphones'],
                ['Casa e Cozinha', 'Eletrodom√©sticos'],
                ['Inform√°tica', 'Notebooks'],
                ['Games', 'Consoles'],
                ['Esporte', 'Fitness'],
                ['Todos os produtos']
            ];
            
            const descontos = ['5%', '10%', '15%', '20%', '25%', 'R$ 50', 'R$ 100', 'R$ 150'];
            const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            const loja = lojas[Math.floor(Math.random() * lojas.length)];
            const desconto = descontos[Math.floor(Math.random() * descontos.length)];
            const categoriaSelecionada = categorias[Math.floor(Math.random() * categorias.length)];
            
            // Gerar c√≥digo √∫nico
            const prefixo = loja.substring(0, 3).toUpperCase();
            const numero = Math.floor(Math.random() * 9000) + 1000;
            const codigo = `${prefixo}${numero}BF25`;
            
            // Gerar validade (pr√≥ximos 30 dias)
            const hoje = new Date();
            const diasAleatorio = Math.floor(Math.random() * 30) + 1;
            const dataValidade = new Date(hoje.getTime() + diasAleatorio * 24 * 60 * 60 * 1000);
            const validade = `${dataValidade.getDate()}/${meses[dataValidade.getMonth()]}/2025`;
            
            return {
                codigo: codigo,
                loja: loja,
                desconto: desconto,
                validade: validade,
                minimo: Math.floor(Math.random() * 200) + 100,
                maximo: Math.floor(Math.random() * 500) + 500,
                categorias: categoriaSelecionada,
                ativo: Math.random() > 0.2, // 80% de chance de estar ativo
                dataDescoberta: new Date().toLocaleString('pt-BR')
            };
        }
        
        async function buscarNovosCupons() {
            const statusDiv = document.getElementById('statusBusca');
            const statusTexto = document.getElementById('statusTexto');
            const btnBuscar = document.getElementById('btnBuscarCupons');
            
            // Desabilitar bot√£o e mostrar status
            btnBuscar.disabled = true;
            btnBuscar.innerHTML = '<i class="fas fa-sync-alt fa-spin mr-2"></i>Buscando...';
            statusDiv.classList.remove('hidden', 'bg-green-100', 'bg-yellow-100');
            statusDiv.classList.add('bg-blue-100');
            statusTexto.classList.remove('text-green-700', 'text-yellow-700');
            statusTexto.classList.add('text-blue-700');
            statusTexto.textContent = 'Buscando cupons em principais marketplaces...';
            
            // Simular busca (em produ√ß√£o seria API real)
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Gerar entre 3 e 8 novos cupons
            const quantidadeNovos = Math.floor(Math.random() * 6) + 3;
            const novosCupons = [];
            
            for (let i = 0; i < quantidadeNovos; i++) {
                novosCupons.push(gerarCupomAleatorio());
            }
            
            // Adicionar aos cupons atuais (evitando duplicatas por c√≥digo)
            const codigosExistentes = new Set(cuponsAtuais.map(c => c.codigo));
            const cuponsUnicos = novosCupons.filter(c => !codigosExistentes.has(c.codigo));
            
            cuponsAtuais = [...cuponsUnicos, ...cuponsAtuais];
            
            // Atualizar exibi√ß√£o
            renderCuponsAtualizados();
            
            // Mostrar resultado
            statusDiv.classList.remove('bg-blue-100');
            statusDiv.classList.add('bg-green-100');
            statusTexto.classList.remove('text-blue-700');
            statusTexto.classList.add('text-green-700');
            statusTexto.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Encontrados ${cuponsUnicos.length} novos cupons! Total: ${cuponsAtuais.length}`;
            
            // Reabilitar bot√£o
            btnBuscar.disabled = false;
            btnBuscar.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Buscar Novos Cupons';
            
            // Esconder status ap√≥s 5 segundos
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
        
        function renderCuponsAtualizados() {
            const cuponsGrid = document.getElementById('cuponsGrid');
            document.getElementById('totalCupons').textContent = cuponsAtuais.length;
            
            if (cuponsAtuais.length === 0) {
                cuponsGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-ticket-alt text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Nenhum cupom encontrado ainda.</p>
                        <p class="text-gray-400 text-sm">Clique em "Buscar Novos Cupons" para come√ßar!</p>
                    </div>
                `;
                return;
            }
            
            cuponsGrid.innerHTML = cuponsAtuais.map((cupom, index) => {
                const isAtivo = cupom.ativo;
                const statusClass = isAtivo ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500';
                const statusText = isAtivo ? 'Ativo' : 'Inativo';
                const isNovo = index < 10; // Primeiros 10 s√£o considerados novos
                
                return `
                    <div class="glass-card rounded-xl p-6 hover:shadow-xl transition-all border-l-4 ${isNovo ? 'border-green-500 bg-green-50' : 'border-orange-500'}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-bold text-gray-800">${cupom.loja}</h4>
                                <div class="flex gap-2 mt-1">
                                    <span class="${statusClass} px-2 py-1 rounded-full text-xs font-semibold">
                                        ${statusText}
                                    </span>
                                    ${isNovo ? '<span class="px-2 py-1 bg-green-500 text-white rounded-full text-xs font-semibold animate-pulse">NOVO!</span>' : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-orange-600">${cupom.desconto}</div>
                                <div class="text-xs text-gray-500">Desconto</div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-500 to-yellow-500 p-4 rounded-lg mb-4">
                            <div class="text-sm text-white mb-1">C√≥digo do Cupom:</div>
                            <div class="text-xl font-mono font-bold text-white tracking-wider flex items-center justify-between">
                                <span id="codigo-${index}">${cupom.codigo}</span>
                                <button onclick="copiarCodigo('${cupom.codigo}', ${index})" 
                                        class="ml-2 px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded text-sm transition-all">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">V√°lido at√©:</span>
                                <span class="font-semibold">${cupom.validade}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Valor m√≠nimo:</span>
                                <span class="font-semibold">R$ ${cupom.minimo.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Valor m√°ximo:</span>
                                <span class="font-semibold">R$ ${cupom.maximo.toFixed(2)}</span>
                            </div>
                            ${cupom.dataDescoberta ? `
                                <div class="flex justify-between text-xs text-gray-500 pt-2 border-t border-gray-200">
                                    <span>Descoberto em:</span>
                                    <span>${cupom.dataDescoberta}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-4">
                            <div class="text-xs text-gray-600 mb-2">Categorias:</div>
                            <div class="flex flex-wrap gap-1">
                                ${cupom.categorias.map(cat => 
                                    `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${cat}</span>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function copiarCodigo(codigo, index) {
            navigator.clipboard.writeText(codigo).then(() => {
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.classList.add('bg-green-500');
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-green-500');
                }, 2000);
            });
        }
        
        // ============================================
        function renderCupons() {
            // Carregar cupons iniciais do arquivo se ainda n√£o carregou
            if (cuponsAtuais.length === 0 && typeof window.cuponsDesconto !== 'undefined') {
                cuponsAtuais = [...window.cuponsDesconto];
            }
            
            // Usar a fun√ß√£o atualizada
            renderCuponsAtualizados();
            return;
            
            // C√≥digo antigo (n√£o usado mais)
            const cuponsGrid = document.getElementById('cuponsGrid');
            document.getElementById('totalCupons').textContent = window.cuponsDesconto.length;
            
            cuponsGrid.innerHTML = cuponsDesconto.map(cupom => {
                const isAtivo = cupom.ativo;
                const statusClass = isAtivo ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500';
                const statusText = isAtivo ? 'Ativo' : 'Inativo';
                
                return `
                    <div class="glass-card rounded-xl p-6 hover:shadow-xl transition-all border-l-4 border-orange-500">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-lg font-bold text-gray-800">${cupom.loja}</h4>
                                <span class="${statusClass} px-2 py-1 rounded-full text-xs font-semibold">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-orange-600">${cupom.desconto}</div>
                                <div class="text-xs text-gray-500">Desconto</div>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-500 to-yellow-500 p-4 rounded-lg mb-4">
                            <div class="text-sm text-white mb-1">C√≥digo do Cupom:</div>
                            <div class="text-xl font-mono font-bold text-white tracking-wider">${cupom.codigo}</div>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">V√°lido at√©:</span>
                                <span class="font-semibold">${cupom.validade}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Valor m√≠nimo:</span>
                                <span class="font-semibold">R$ ${cupom.minimo.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Valor m√°ximo:</span>
                                <span class="font-semibold">R$ ${cupom.maximo.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="text-xs text-gray-600 mb-2">Categorias:</div>
                            <div class="flex flex-wrap gap-1">
                                ${cupom.categorias.map(cat => 
                                    `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${cat}</span>`
                                ).join('')}
                            </div>
                        </div>
                        
                        ${cupom.observacao ? 
                            '<div class="mt-3 p-2 bg-yellow-50 border-l-2 border-yellow-400 text-xs text-yellow-800">' +
                                '<i class="fas fa-exclamation-triangle mr-1"></i>' + cupom.observacao +
                            '</div>'
                        : ''}
                        
                        <a href="${cupom.link}" target="_blank" 
                           class="mt-4 block w-full bg-orange-500 hover:bg-orange-600 text-white text-center px-4 py-2 rounded-lg font-semibold transition-all">
                            <i class="fas fa-external-link-alt mr-2"></i>Acessar Loja
                        </a>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // FUN√á√ïES PARA ABA DE COMPARATIVO DE PRE√áOS
        // ============================================
        let comparativoFiltered = [];
        
        function renderComparativo() {
            // SEMPRE pegar produtos atualizados do CRUD (n√£o usar allProducts est√°tico)
            const produtosAtualizados = getProdutosAtualizados();
            
            // Adicionar linkCompra se n√£o existir
            produtosAtualizados.forEach(produto => {
                if (!produto.linkCompra) {
                    const nomeParaURL = produto.nome
                        .replace(/\s+/g, '+')
                        .replace(/[√°√†√£√¢√§]/gi, 'a')
                        .replace(/[√©√®√™√´]/gi, 'e')
                        .replace(/[√≠√¨√Æ√Ø]/gi, 'i')
                        .replace(/[√≥√≤√µ√¥√∂]/gi, 'o')
                        .replace(/[√∫√π√ª√º]/gi, 'u')
                        .replace(/√ß/gi, 'c')
                        .replace(/[^a-zA-Z0-9+]/g, '');
                    produto.linkCompra = `https://www.amazon.com.br/s?k=${nomeParaURL}`;
                }
            });
            
            comparativoFiltered = [...produtosAtualizados];
            
            // Debug: verificar se precoConcorrente est√° presente
            console.log('Produtos com precoConcorrente:', comparativoFiltered.filter(p => p.precoConcorrente).length);
            console.log('Exemplo produto:', comparativoFiltered[0]);
            
            // Calcular estat√≠sticas
            const stats = {
                vantagem: 0,
                igual: 0,
                desvantagem: 0,
                exclusivo: 0
            };
            
            comparativoFiltered.forEach(p => {
                if (!p.precoConcorrente) {
                    stats.exclusivo++;
                } else {
                    const diff = p.precoConcorrente - p.precoVenda;
                    if (diff > 0) stats.vantagem++;
                    else if (diff === 0) stats.igual++;
                    else stats.desvantagem++;
                }
            });
            
            document.getElementById('stat-vantagem').textContent = stats.vantagem;
            document.getElementById('stat-igual').textContent = stats.igual;
            document.getElementById('stat-desvantagem').textContent = stats.desvantagem;
            document.getElementById('stat-exclusivo').textContent = stats.exclusivo;
            
            filterComparativo();
        }
        
        function filterComparativo() {
            const statusFilter = document.getElementById('filterStatus').value;
            const categoriaFilter = document.getElementById('filterCategoriaComp').value;
            const searchText = document.getElementById('searchComp').value.toLowerCase();
            
            let filtered = comparativoFiltered.filter(p => {
                // Filtro de busca
                const matchSearch = !searchText || 
                    p.nome.toLowerCase().includes(searchText) ||
                    p.sku.toLowerCase().includes(searchText);
                
                // Filtro de categoria
                const matchCategoria = categoriaFilter === 'todos' || p.categoria === categoriaFilter;
                
                // Filtro de status
                let matchStatus = true;
                if (statusFilter !== 'todos') {
                    if (!p.precoConcorrente) {
                        matchStatus = statusFilter === 'exclusivo';
                    } else {
                        const diff = p.precoConcorrente - p.precoVenda;
                        if (statusFilter === 'vantagem') matchStatus = diff > 0;
                        else if (statusFilter === 'igual') matchStatus = diff === 0;
                        else if (statusFilter === 'desvantagem') matchStatus = diff < 0;
                    }
                }
                
                return matchSearch && matchCategoria && matchStatus;
            });
            
            renderComparativoTable(filtered);
        }
        
        function renderComparativoTable(produtos) {
            const table = document.getElementById('comparativoTable');
            
            if (produtos.length === 0) {
                table.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-search text-4xl mb-4"></i>
                        <p>Nenhum produto encontrado com os filtros selecionados</p>
                    </div>
                `;
                return;
            }
            
            table.innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Produto</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Nossa Margem</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Pre√ßo Yoobe<br/><span class="text-[10px] font-normal">(Custo Prio + Margem)</span></th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Pre√ßo Concorrente<br/><span class="text-[10px] font-normal">(Prio)</span></th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Melhor Op√ß√£o<br/><span class="text-[10px] font-normal">(+ barato)</span></th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Diferen√ßa de Pre√ßo</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Status</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Link Compra</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${produtos.map(p => {
                            let statusClass = '';
                            let statusIcon = '';
                            let diferenca = 0;
                            let diferencaText = '-';
                            let recomendacao = p.recomendacao || 'Avaliar';
                            
                            // C√°lculos
                            const custoLoja = p.custoBase || 0;
                            const margem = p.margem || 30;
                            const precoYoobe = p.precoVenda || 0;
                            const precoConcorrente = p.precoConcorrente || null;
                            
                            // Calcular melhor op√ß√£o de compra
                            const alternativasCompra = [];
                            
                            // Op√ß√£o 1: Custo Loja atual (onde compramos)
                            if (custoLoja > 0 && p.linkCompra && p.linkCompra !== '#') {
                                alternativasCompra.push({
                                    fonte: p.fornecedor || 'Fornecedor Atual',
                                    preco: custoLoja,
                                    link: p.linkCompra,
                                    tipo: 'atual'
                                });
                            }
                            
                            // Op√ß√£o 2: Pre√ßo Concorrente (Prio)
                            if (precoConcorrente) {
                                alternativasCompra.push({
                                    fonte: 'Prio (Concorrente)',
                                    preco: precoConcorrente,
                                    link: `https://www.google.com/search?q=${encodeURIComponent(p.nome)}+pre√ßo`,
                                    tipo: 'concorrente'
                                });
                            }
                            
                            // Op√ß√£o 3: Buscar alternativas mais baratas (estimativa de 15-20% desconto)
                            if (custoLoja > 0) {
                                const descontoEstimado = custoLoja * 0.85; // 15% desconto
                                alternativasCompra.push({
                                    fonte: 'Mercado Livre / Shopee',
                                    preco: descontoEstimado,
                                    link: `https://lista.mercadolivre.com.br/${encodeURIComponent(p.nome)}`,
                                    tipo: 'alternativa',
                                    observacao: '~15% desconto'
                                });
                            }
                            
                            // Ordenar por pre√ßo (menor primeiro)
                            alternativasCompra.sort((a, b) => a.preco - b.preco);
                            const melhorOpcao = alternativasCompra[0] || null;
                            
                            // Gerar imagem incremental se n√£o houver imagem
                            let imagemProduto = p.imagem;
                            if (!imagemProduto || imagemProduto === '' || imagemProduto === '#') {
                                // Usar array de imagens placeholder baseado em categoria
                                const imagensPorCategoria = {
                                    'Smartphones': [
                                        'https://m.media-amazon.com/images/I/71ZDY57r93L._AC_SL1500_.jpg',
                                        'https://m.media-amazon.com/images/I/61BWx50cVIL._AC_SL1500_.jpg',
                                        'https://m.media-amazon.com/images/I/71cQWYVtcBL._AC_SL1500_.jpg'
                                    ],
                                    'Laptops': [
                                        'https://m.media-amazon.com/images/I/61ED7M6OHUL._AC_SL1500_.jpg',
                                        'https://m.media-amazon.com/images/I/71TPda7cwUL._AC_SL1500_.jpg'
                                    ],
                                    'Tablets': [
                                        'https://m.media-amazon.com/images/I/61NGnpjoRDL._AC_SL1500_.jpg',
                                        'https://m.media-amazon.com/images/I/51l98d5FHcL._AC_SL1500_.jpg'
                                    ],
                                    '√Åudio': [
                                        'https://m.media-amazon.com/images/I/61QGQJYZfxL._AC_SL1500_.jpg',
                                        'https://m.media-amazon.com/images/I/71yRY8YlAbL._UF1000,1000_QL80_.jpg'
                                    ],
                                    'Smart Home': [
                                        'https://m.media-amazon.com/images/I/71yRY8YlAbL._UF1000,1000_QL80_.jpg',
                                        'https://m.media-amazon.com/images/I/61ksU+to8sL._AC_SL1500_.jpg'
                                    ],
                                    'Default': [
                                        'https://via.placeholder.com/300x300/667eea/ffffff?text=Produto+Eletr√¥nico',
                                        'https://via.placeholder.com/300x300/764ba2/ffffff?text=Produto+Tech',
                                        'https://via.placeholder.com/300x300/f093fb/ffffff?text=Produto+Digital'
                                    ]
                                };
                                
                                const categoria = p.subcategoria || 'Default';
                                const imagensDisponiveis = imagensPorCategoria[categoria] || imagensPorCategoria['Default'];
                                const indiceImagem = (p.id % imagensDisponiveis.length);
                                imagemProduto = imagensDisponiveis[indiceImagem];
                            }
                            
                            if (!precoConcorrente) {
                                statusClass = 'bg-blue-100 text-blue-700';
                                statusIcon = 'üåü';
                                diferencaText = 'Exclusivo';
                            } else {
                                diferenca = precoConcorrente - precoYoobe;
                                diferencaText = formatarPreco(Math.abs(diferenca));
                                
                                if (diferenca > 0) {
                                    statusClass = 'bg-green-100 text-green-700';
                                    statusIcon = '‚úÖ';
                                } else if (diferenca === 0) {
                                    statusClass = 'bg-yellow-100 text-yellow-700';
                                    statusIcon = '‚ö†Ô∏è';
                                } else {
                                    statusClass = 'bg-red-100 text-red-700';
                                    statusIcon = '‚ùå';
                                }
                            }
                            
                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <div class="flex items-center space-x-3">
                                            <img src="${imagemProduto}" alt="${p.nome}" 
                                                 class="w-12 h-12 object-cover rounded-lg"
                                                 onerror="this.src='https://via.placeholder.com/100x100/667eea/ffffff?text=Produto'">
                                            <div>
                                                <div class="font-semibold text-gray-800">${p.nome}</div>
                                                <div class="text-xs text-gray-500">${p.sku}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs font-semibold">
                                            ${margem}%
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="font-bold text-blue-600">${formatarPreco(precoYoobe)}</div>
                                        <div class="text-[10px] text-gray-500">Custo Prio + Margem</div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="font-semibold text-gray-700">
                                            ${precoConcorrente ? formatarPreco(precoConcorrente) : '<span class="text-red-500 text-xl">‚ùå</span>'}
                                        </div>
                                        ${precoConcorrente ? '<div class="text-[10px] text-gray-500">Prio</div>' : '<div class="text-[10px] text-red-500">Sem cota√ß√£o</div>'}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        ${melhorOpcao ? 
                                            '<div class="mb-1">' +
                                                '<a href="' + melhorOpcao.link + '" target="_blank" ' +
                                                   'class="inline-block px-2 py-1 ' + (melhorOpcao.tipo === 'atual' ? 'bg-purple-100 text-purple-700' : melhorOpcao.tipo === 'concorrente' ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700') + ' rounded text-xs font-semibold hover:opacity-80 transition-all">' +
                                                    '<i class="fas fa-tag mr-1"></i>' + formatarPreco(melhorOpcao.preco) +
                                                '</a>' +
                                            '</div>' +
                                            '<div class="text-[10px] text-gray-600">' + melhorOpcao.fonte + '</div>' +
                                            (melhorOpcao.observacao ? '<div class="text-[9px] text-green-600">' + melhorOpcao.observacao + '</div>' : '') +
                                            (alternativasCompra.length > 1 ? 
                                                '<button onclick="mostrarAlternativas(' + p.id + ')" class="text-[10px] text-blue-600 hover:underline mt-1 data-alternativas" data-id="' + p.id + '" data-nome="' + p.nome.replace(/"/g, '&quot;') + '" data-alternativas=\'' + JSON.stringify(alternativasCompra).replace(/'/g, '&#39;') + '\'>' +
                                                    'Ver todas (' + alternativasCompra.length + ')' +
                                                '</button>'
                                            : '')
                                        : '<span class="text-gray-400 text-xs">-</span>'}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="font-bold ${diferenca >= 0 ? 'text-green-600' : 'text-red-600'}">
                                            ${diferenca >= 0 ? '+' : ''}${diferencaText}
                                        </div>
                                        ${precoConcorrente ? 
                                            '<div class="text-[10px] text-gray-500">' + (diferenca > 0 ? 'Mais barato' : diferenca < 0 ? 'Mais caro' : 'Igual') + '</div>' 
                                            : '<div class="text-[10px] text-blue-500">Sem concorrente</div>'
                                        }
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="${statusClass} px-3 py-1 rounded-full text-xs font-semibold block mb-1">
                                            ${statusIcon} ${p.status || 'N/A'}
                                        </span>
                                        <div class="text-[10px] text-gray-600 mt-1">
                                            ${p.observacaoTecnica || recomendacao}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        ${gerarBotaoCompraAdmin(p.linkCompra, true)}
                                        <div class="mt-1">
                                            ${gerarIndicadorLinkStatus(p.linkCompra)}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button onclick="showProductModal(${p.id})" 
                                                    class="px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-xs"
                                                    title="Ver Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button onclick="openCrudModal('edit', ${p.id})" 
                                                    class="px-2 py-1 bg-purple-500 text-white rounded hover:bg-purple-600 transition text-xs"
                                                    title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // Fun√ß√£o global para mostrar alternativas de compra
        function mostrarAlternativas(produtoId) {
            const botao = document.querySelector('button[data-id="' + produtoId + '"]');
            if (!botao) return;
            
            const nome = botao.getAttribute('data-nome');
            const alternativasJson = botao.getAttribute('data-alternativas');
            const alternativas = JSON.parse(alternativasJson);
            
            const lista = alternativas.map(function(alt) {
                const precoFormatado = 'R$ ' + alt.preco.toFixed(2).replace('.', ',');
                return alt.fonte + ': ' + precoFormatado + (alt.observacao ? ' (' + alt.observacao + ')' : '');
            }).join('\n');
            
            alert('Alternativas dispon√≠veis para ' + nome + ':\n\n' + lista);
        }

        // ============================================
        // FUN√á√ÉO: EXPORTAR CSV DO CAT√ÅLOGO
        // ============================================
        function exportarCSV() {
            const btn = event.target;
            const status = document.getElementById('csvStatus');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando CSV...';
            
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
            status.classList.add('bg-blue-100', 'text-blue-800');
            status.innerHTML = '<i class="fas fa-info-circle mr-2"></i>Processando dados...';
            
            setTimeout(() => {
                try {
                    // Fun√ß√µes auxiliares
                    const escaparCSV = (texto) => {
                        if (!texto) return '';
                        texto = String(texto);
                        if (texto.includes(',') || texto.includes('"') || texto.includes('\n')) {
                            return '"' + texto.replace(/"/g, '""') + '"';
                        }
                        return texto;
                    };
                    
                    const formatarPrecoCSV = (valor) => {
                        if (!valor || valor === 0) return '';
                        return valor.toFixed(2).replace('.', ',');
                    };
                    
                    // Cabe√ßalho do CSV ATUALIZADO com NOVOS CAMPOS
                    let csv = 'ID,SKU,Nome do Produto,Categoria,Subcategoria,Fornecedor,';
                    csv += 'Quantidade,Custo Base (R$),Pre√ßo Mercado (R$),Margem (%),Pre√ßo Venda (R$),';
                    csv += 'Investimento Total (R$),Receita Total (R$),Lucro Unit√°rio (R$),Lucro Total (R$),';
                    csv += 'Link de Compra,Imagem,Badge,Status,Origem,';
                    csv += 'Pre√ßo Concorrente (R$),Diferen√ßa vs Concorrente (R$),Status Competitividade\n';
                    
                    // Sempre usar produtos atualizados do CRUD
                    const produtosAtuais = getProdutosAtualizados();
                    
                    // Dados
                    produtosAtuais.forEach(p => {
                        // C√°lculos
                        const investimentoTotal = p.custoBase * p.quantidade;
                        const receitaTotal = p.precoVenda * p.quantidade;
                        const lucroUnitario = p.precoVenda - p.custoBase;
                        const lucroTotal = lucroUnitario * p.quantidade;
                        
                        const precoConcorrente = p.precoConcorrente || 0;
                        const diferenca = precoConcorrente ? (p.precoVenda - precoConcorrente) : 0;
                        
                        let statusCompetitividade = '';
                        if (precoConcorrente > 0) {
                            if (diferenca < 0) {
                                statusCompetitividade = 'Yoobe mais barato';
                            } else if (diferenca === 0) {
                                statusCompetitividade = 'Pre√ßo igual';
                            } else {
                                statusCompetitividade = 'Yoobe mais caro';
                            }
                        } else {
                            statusCompetitividade = 'Sem compara√ß√£o';
                        }
                        
                        // Montar linha CSV
                        csv += escaparCSV(p.id) + ',';
                        csv += escaparCSV(p.sku) + ',';
                        csv += escaparCSV(p.nome) + ',';
                        csv += escaparCSV(p.categoria) + ',';
                        csv += escaparCSV(p.subcategoria) + ',';
                        csv += escaparCSV(p.fornecedor) + ',';
                        csv += p.quantidade + ',';
                        csv += formatarPrecoCSV(p.custoBase) + ',';
                        csv += formatarPrecoCSV(p.precoMercado) + ',';
                        csv += p.margem + ',';
                        csv += formatarPrecoCSV(p.precoVenda) + ',';
                        csv += formatarPrecoCSV(investimentoTotal) + ',';
                        csv += formatarPrecoCSV(receitaTotal) + ',';
                        csv += formatarPrecoCSV(lucroUnitario) + ',';
                        csv += formatarPrecoCSV(lucroTotal) + ',';
                        csv += escaparCSV(p.linkCompra || '') + ',';
                        csv += escaparCSV(p.imagem || '') + ',';
                        csv += escaparCSV(p.badge || '') + ',';
                        csv += escaparCSV(p.status || 'ativo') + ',';
                        csv += escaparCSV(p.origem || 'planilha') + ',';
                        csv += formatarPrecoCSV(precoConcorrente) + ',';
                        csv += formatarPrecoCSV(Math.abs(diferenca)) + ',';
                        csv += statusCompetitividade + '\n';
                    });
                    
                    // Criar e baixar arquivo
                    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    const dataHora = new Date().toISOString().slice(0, 16).replace('T', '_').replace(/:/g, '-');
                    link.setAttribute('href', url);
                    link.setAttribute('download', `catalogo-completo-prio-${dataHora}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Sucesso
                    const comPrecoConcorrente = produtosAtuais.filter(p => p.precoConcorrente).length;
                    const investimentoTotalGeral = produtosAtuais.reduce((sum, p) => sum + (p.custoBase * p.quantidade), 0);
                    const lucroTotalGeral = produtosAtuais.reduce((sum, p) => sum + ((p.precoVenda - p.custoBase) * p.quantidade), 0);
                    
                    status.classList.remove('bg-blue-100', 'text-blue-800');
                    status.classList.add('bg-green-100', 'text-green-800');
                    status.innerHTML = `
                        <div class="flex items-start">
                            <i class="fas fa-check-circle text-green-600 text-xl mr-3 mt-1"></i>
                            <div>
                                <div class="font-bold mb-1">CSV Gerado com Sucesso! ‚úÖ</div>
                                <div class="text-sm space-y-1">
                                    <div>Arquivo: <span class="font-mono text-xs">catalogo-completo-prio-${dataHora}.csv</span></div>
                                    <div>Total de produtos: <strong>${produtosAtuais.length}</strong></div>
                                    <div>Com pre√ßo concorrente: <strong>${comPrecoConcorrente}</strong></div>
                                    <div>Investimento total: <strong>R$ ${investimentoTotalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></div>
                                    <div>Lucro projetado: <strong>R$ ${lucroTotalGeral.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    status.classList.remove('bg-blue-100');
                    status.classList.add('bg-red-100', 'text-red-800');
                    status.innerHTML = `
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Erro ao gerar CSV: ${error.message}
                    `;
                }
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download mr-2"></i>Exportar Cat√°logo Completo (CSV)';
            }, 500);
        }

        // ============================================
        // FERRAMENTAS DE GEST√ÉO DE CAT√ÅLOGO
        // ============================================
        
        // 1. EXPORTAR TEMPLATE DE PRODUTOS
        function exportarTemplate() {
            const status = document.getElementById('ferramentasStatus');
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
            status.classList.add('bg-blue-100', 'text-blue-800');
            status.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gerando template...';
            
            setTimeout(() => {
                try {
                    const template = {
                        _metadata: {
                            versao: "6.1.5",
                            dataExportacao: new Date().toISOString(),
                            totalProdutos: allProducts.length,
                            instrucoes: "Edite este arquivo e reimporte na aba Ferramentas > Importar Cat√°logo"
                        },
                        produtos: allProducts.map(p => ({
                            id: p.id,
                            sku: p.sku,
                            nome: p.nome,
                            categoria: p.categoria,
                            subcategoria: p.subcategoria,
                            quantidade: p.quantidade,
                            custoBase: p.custoBase,
                            precoMercado: p.precoMercado,
                            margem: p.margem,
                            precoVenda: p.precoVenda,
                            estoque: p.estoque,
                            fornecedor: p.fornecedor,
                            imagem: p.imagem,
                            linkCompra: p.linkCompra,
                            descricao: p.descricao,
                            especificacoes: p.especificacoes,
                            badge: p.badge
                        }))
                    };
                    
                    const json = JSON.stringify(template, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const dataHora = new Date().toISOString().slice(0, 16).replace('T', '_').replace(/:/g, '-');
                    link.href = url;
                    link.download = `template-produtos-${dataHora}.json`;
                    link.click();
                    
                    status.classList.remove('bg-blue-100', 'text-blue-800');
                    status.classList.add('bg-green-100', 'text-green-800');
                    status.innerHTML = `
                        <i class="fas fa-check-circle mr-2"></i>
                        <strong>Template exportado!</strong> Arquivo: template-produtos-${dataHora}.json (${allProducts.length} produtos)
                    `;
                } catch (error) {
                    status.classList.remove('bg-blue-100');
                    status.classList.add('bg-red-100', 'text-red-800');
                    status.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>Erro: ${error.message}`;
                }
            }, 500);
        }
        
        // 2. IMPORTAR/ATUALIZAR CAT√ÅLOGO
        function abrirImportador() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => importarCatalogo(e.target.files[0]);
            input.click();
        }
        
        function importarCatalogo(file) {
            if (!file) return;
            
            const status = document.getElementById('ferramentasStatus');
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
            status.classList.add('bg-blue-100', 'text-blue-800');
            status.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Importando produtos...';
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const novosProdutos = data.produtos || data;
                    
                    // Atualizar produtos existentes ou adicionar novos
                    let atualizados = 0;
                    let adicionados = 0;
                    
                    novosProdutos.forEach(novoProd => {
                        const index = allProducts.findIndex(p => p.id === novoProd.id || p.sku === novoProd.sku);
                        if (index >= 0) {
                            // Atualizar produto existente
                            allProducts[index] = { ...allProducts[index], ...novoProd };
                            atualizados++;
                        } else {
                            // Adicionar novo produto
                            allProducts.push(novoProd);
                            adicionados++;
                        }
                    });
                    
                    // Re-renderizar tudo
                    renderDashboard();
                    renderCatalogo();
                    renderComparativo();
                    
                    status.classList.remove('bg-blue-100', 'text-blue-800');
                    status.classList.add('bg-green-100', 'text-green-800');
                    status.innerHTML = `
                        <i class="fas fa-check-circle mr-2"></i>
                        <strong>Importa√ß√£o conclu√≠da!</strong> ${atualizados} atualizados, ${adicionados} novos | Total: ${allProducts.length} produtos
                    `;
                } catch (error) {
                    status.classList.remove('bg-blue-100');
                    status.classList.add('bg-red-100', 'text-red-800');
                    status.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>Erro ao importar: ${error.message}`;
                }
            };
            reader.readAsText(file);
        }
        
        // 2B. ABRIR IMPORTADOR AVAN√áADO (NOVO v2.0)
        function abrirImportadorAvancado() {
            // Abre o importador avan√ßado em nova aba
            window.open('importar-catalogo-produtos-v2.html', '_blank');
            
            // Mostrar notifica√ß√£o
            const status = document.getElementById('ferramentasStatus');
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
            status.classList.add('bg-indigo-100', 'text-indigo-800');
            status.innerHTML = `
                <div class="flex items-start gap-4">
                    <i class="fas fa-info-circle text-2xl"></i>
                    <div>
                        <div class="font-bold mb-2">Sistema de Importa√ß√£o Avan√ßado v2.0</div>
                        <div class="text-sm">
                            <strong>Recursos:</strong>
                            <ul class="list-disc list-inside mt-2 space-y-1">
                                <li>‚úÖ Convers√£o autom√°tica de JSON complexo para estrutura simplificada</li>
                                <li>‚úÖ C√°lculo autom√°tico de margens de lucro</li>
                                <li>‚úÖ Preview visual antes de importar</li>
                                <li>‚úÖ C√≥digo JavaScript pronto para copiar</li>
                                <li>‚úÖ Suporte para m√∫ltiplos formatos de JSON</li>
                            </ul>
                        </div>
                        <div class="mt-3 p-3 bg-white rounded-lg border-2 border-indigo-300">
                            <strong>Como usar:</strong>
                            <ol class="list-decimal list-inside mt-2 text-sm space-y-1">
                                <li>Cole seu JSON na √°rea de texto</li>
                                <li>Clique em "Converter JSON"</li>
                                <li>Revise o preview dos produtos</li>
                                <li>Clique em "Copiar C√≥digo JavaScript"</li>
                                <li>Cole no arquivo produtos-v6.1.js</li>
                            </ol>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 3. CORRIGIR LINKS DE COMPRA
        function corrigirLinks() {
            const status = document.getElementById('ferramentasStatus');
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-orange-100');
            status.classList.add('bg-blue-100', 'text-blue-800');
            status.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Analisando produtos e gerando links...';
            
            setTimeout(() => {
                let corrigidos = 0;
                let semLink = [];
                let comLink = 0;
                
                allProducts.forEach(produto => {
                    if (!produto.linkCompra || produto.linkCompra === '#' || produto.linkCompra === '' || produto.linkCompra.includes('placeholder')) {
                        const nomeParaURL = produto.nome
                            .replace(/\s+/g, '+')
                            .replace(/[√°√†√£√¢√§]/gi, 'a')
                            .replace(/[√©√®√™√´]/gi, 'e')
                            .replace(/[√≠√¨√Æ√Ø]/gi, 'i')
                            .replace(/[√≥√≤√µ√¥√∂]/gi, 'o')
                            .replace(/[√∫√π√ª√º]/gi, 'u')
                            .replace(/√ß/gi, 'c')
                            .replace(/[^a-zA-Z0-9+]/g, '');
                        produto.linkCompra = `https://www.amazon.com.br/s?k=${nomeParaURL}`;
                        semLink.push(produto.nome.substring(0, 40));
                        corrigidos++;
                    } else {
                        comLink++;
                    }
                });
                
                if (corrigidos > 0) {
                    renderDashboard();
                    renderCatalogo();
                    renderComparativo();
                }
                
                status.classList.remove('bg-blue-100', 'text-blue-800');
                
                if (corrigidos > 0) {
                    status.classList.add('bg-green-100', 'text-green-800');
                    status.innerHTML = `
                        <div class="space-y-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-check-circle text-2xl"></i>
                                <strong class="text-lg">Links gerados com sucesso!</strong>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-3">
                                <div class="bg-white p-3 rounded-lg border-2 border-green-300">
                                    <div class="text-2xl font-bold text-green-600">${corrigidos}</div>
                                    <div class="text-xs text-gray-600">Links gerados</div>
                                </div>
                                <div class="bg-white p-3 rounded-lg border-2 border-blue-300">
                                    <div class="text-2xl font-bold text-blue-600">${comLink}</div>
                                    <div class="text-xs text-gray-600">J√° tinham link</div>
                                </div>
                            </div>
                            ${semLink.length > 0 && semLink.length <= 5 ? 
                                '<div class="mt-3 text-xs text-gray-600">' +
                                '<strong>Produtos atualizados:</strong><br>' +
                                semLink.map(p => '‚Ä¢ ' + p + '...').join('<br>') +
                                '</div>'
                            : ''}
                            <div class="mt-3 p-2 bg-white rounded border-2 border-green-300">
                                <p class="text-xs text-gray-700">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Links gerados apontam para busca na Amazon. 
                                    Voc√™ pode edit√°-los manualmente depois se necess√°rio.
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    status.classList.add('bg-blue-100', 'text-blue-800');
                    status.innerHTML = `
                        <div class="flex items-center gap-2">
                            <i class="fas fa-info-circle text-2xl"></i>
                            <div>
                                <strong>Nenhum link para corrigir</strong><br>
                                <small>Todos os ${comLink} produtos j√° possuem links de compra v√°lidos!</small>
                            </div>
                        </div>
                    `;
                }
            }, 800);
        }
        
        // 4. ATUALIZAR IMAGENS
        function atualizarImagens() {
            const status = document.getElementById('ferramentasStatus');
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-orange-100');
            status.classList.add('bg-blue-100', 'text-blue-800');
            status.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Carregando catalog_images.json...';
            
            // Tentar carregar o arquivo catalog_images.json
            fetch('catalog_images.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Arquivo catalog_images.json n√£o encontrado');
                    }
                    return response.json();
                })
                .then(imagensData => {
                    status.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Atualizando imagens dos produtos...';
                    
                    let atualizados = 0;
                    let naoEncontrados = 0;
                    
                    // Atualizar imagens dos produtos
                    allProducts.forEach(produto => {
                        // Buscar imagem por nome do produto
                        const imagemEncontrada = imagensData.find(img => 
                            img.produto && img.produto.toLowerCase().includes(produto.nome.toLowerCase().substring(0, 20))
                        );
                        
                        if (imagemEncontrada && imagemEncontrada.imagem) {
                            produto.imagem = imagemEncontrada.imagem;
                            atualizados++;
                        } else {
                            naoEncontrados++;
                        }
                    });
                    
                    // Atualizar interface
                    if (atualizados > 0) {
                        renderDashboard();
                        renderSugestoes();
                        renderCatalogo();
                        renderComparativo();
                    }
                    
                    status.classList.remove('bg-blue-100', 'text-blue-800');
                    status.classList.add('bg-green-100', 'text-green-800');
                    status.innerHTML = `
                        <i class="fas fa-check-circle mr-2"></i>
                        <strong>Imagens atualizadas!</strong><br>
                        <small>‚úÖ ${atualizados} produtos atualizados | ‚ö†Ô∏è ${naoEncontrados} sem imagem correspondente</small>
                    `;
                })
                .catch(error => {
                    status.classList.remove('bg-blue-100', 'text-blue-800');
                    status.classList.add('bg-orange-100', 'text-orange-800');
                    status.innerHTML = `
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <strong>Arquivo catalog_images.json n√£o encontrado</strong><br>
                        <small>Para usar esta ferramenta:</small><br>
                        <small>1. Use <strong>buscar-imagens-FINAL.html</strong> para buscar imagens</small><br>
                        <small>2. O arquivo gerar√° <strong>catalog_images.json</strong> automaticamente</small><br>
                        <small>3. Coloque o arquivo na mesma pasta do admin</small><br>
                        <small>4. Clique novamente em "Atualizar Imagens"</small>
                    `;
                });
        }
        
        // 5. VERIFICAR ACESSO √Ä FERRAMENTA (INTELIGENTE)
        async function verificarAcessoFerramenta(event, nomeArquivo) {
            // Detectar se est√° rodando em servidor ou local
            const isLocal = window.location.protocol === 'file:';
            const isGenspark = window.location.hostname.includes('genspark.ai');
            
            // Se for deploy em servidor real (n√£o local, n√£o Genspark)
            if (!isLocal && !isGenspark) {
                // Tentar verificar se o arquivo existe
                try {
                    const response = await fetch(nomeArquivo, { method: 'HEAD' });
                    if (response.ok) {
                        // Arquivo existe no servidor! Deixa abrir normalmente
                        return true;
                    }
                } catch (e) {
                    // Erro ao verificar, mas vamos tentar abrir mesmo assim
                }
            }
            
            // Se for local ou Genspark, mostra instru√ß√µes
            if (isLocal || isGenspark) {
                event.preventDefault();
                mostrarInstrucaoFerramenta(nomeArquivo);
                return false;
            }
            
            // Em caso de d√∫vida, deixa tentar abrir
            return true;
        }
        
        // 6. MOSTRAR INSTRU√á√ÉO PARA ACESSAR FERRAMENTA EXTERNA
        function mostrarInstrucaoFerramenta(nomeArquivo) {
            const status = document.getElementById('ferramentasStatus');
            status.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-orange-100');
            status.classList.add('bg-blue-100', 'text-blue-800');
            
            const arquivoNome = nomeArquivo.split('.')[0];
            const arquivoFormatado = arquivoNome.replace(/-/g, ' ').toUpperCase();
            
            status.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-3xl text-blue-600"></i>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg mb-2">Como Acessar: ${arquivoFormatado}</h3>
                            <p class="text-sm text-gray-700 mb-3">
                                Esta ferramenta √© uma p√°gina HTML separada. Para acess√°-la:
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg border-2 border-blue-300">
                        <h4 class="font-bold text-blue-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-desktop"></i>
                            Op√ß√£o 1: Ambiente Local (Recomendado)
                        </h4>
                        <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                            <li><strong>Baixe o arquivo:</strong> ${nomeArquivo}</li>
                            <li><strong>Salve na mesma pasta</strong> onde est√° o admin-v6.6.html</li>
                            <li><strong>Abra direto no navegador:</strong>
                                <div class="mt-2 p-2 bg-gray-100 rounded font-mono text-xs break-all">
                                    Clique com bot√£o direito no arquivo ‚Üí "Abrir com" ‚Üí Navegador
                                </div>
                            </li>
                            <li>‚úÖ <strong>Funcionar√° perfeitamente!</strong></li>
                        </ol>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg border-2 border-purple-300">
                        <h4 class="font-bold text-purple-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-cloud"></i>
                            Op√ß√£o 2: Deploy em Servidor
                        </h4>
                        <ol class="text-sm text-gray-700 space-y-2 list-decimal list-inside">
                            <li><strong>Fa√ßa upload</strong> do arquivo ${nomeArquivo} para o mesmo servidor/hosting</li>
                            <li><strong>Acesse via URL:</strong>
                                <div class="mt-2 p-2 bg-gray-100 rounded font-mono text-xs break-all">
                                    https://seu-dominio.com/${nomeArquivo}
                                </div>
                            </li>
                            <li>‚úÖ <strong>Acess√≠vel de qualquer lugar!</strong></li>
                        </ol>
                    </div>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                        <p class="text-sm text-yellow-800 flex items-start gap-2">
                            <i class="fas fa-exclamation-triangle mt-1"></i>
                            <span>
                                <strong>Por que n√£o funciona no preview da Genspark?</strong><br>
                                O preview √© um ambiente sandbox que s√≥ mostra o arquivo principal (admin-v6.6.html).
                                Outros arquivos HTML precisam estar no mesmo servidor ou pasta local para funcionar.
                            </span>
                        </p>
                    </div>
                    
                    <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
                        <p class="text-sm text-green-800 flex items-start gap-2">
                            <i class="fas fa-lightbulb mt-1"></i>
                            <span>
                                <strong>Dica:</strong> Se voc√™ j√° fez deploy no Cloudflare Pages ou GitHub Pages,
                                basta fazer upload do arquivo ${nomeArquivo} para l√° e acessar diretamente!
                            </span>
                        </p>
                    </div>
                    
                    <div class="flex gap-3 mt-4">
                        <button onclick="copiarInstrucao('${nomeArquivo}')" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-copy mr-2"></i>Copiar Instru√ß√µes
                        </button>
                        <button onclick="fecharInstrucao()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-all">
                            <i class="fas fa-times mr-2"></i>Fechar
                        </button>
                    </div>
                </div>
            `;
        }
        
        function copiarInstrucao(nomeArquivo) {
            const texto = `
COMO ACESSAR: ${nomeArquivo}

OP√á√ÉO 1 - LOCAL:
1. Baixe o arquivo: ${nomeArquivo}
2. Salve na mesma pasta do admin-v6.6.html
3. Abra direto no navegador (clique duplo ou bot√£o direito ‚Üí Abrir com)

OP√á√ÉO 2 - SERVIDOR:
1. Fa√ßa upload do ${nomeArquivo} para seu hosting
2. Acesse via: https://seu-dominio.com/${nomeArquivo}

Arquivo dispon√≠vel no projeto!
            `.trim();
            
            navigator.clipboard.writeText(texto).then(() => {
                alert('‚úÖ Instru√ß√µes copiadas para a √°rea de transfer√™ncia!');
            }).catch(() => {
                alert('‚ùå Erro ao copiar. Selecione o texto manualmente.');
            });
        }
        
        function fecharInstrucao() {
            const status = document.getElementById('ferramentasStatus');
            status.classList.add('hidden');
            status.innerHTML = '';
        }

        // ============================================
        // ATUALIZAR INICIALIZA√á√ÉO
        // ============================================
        const originalInit = window.onload;
        window.onload = function() {
            if (originalInit) originalInit();
            
            // Carregar configura√ß√µes salvas (GitHub API, persist√™ncia)
            carregarConfiguracoesAdmin();
            
            // Renderizar novas abas
            if (typeof window.cuponsDesconto !== 'undefined') {
                renderCupons();
            }
            
            if (typeof window.todosOsProdutosV6Enriquecidos !== 'undefined') {
                renderComparativo();
            }
        };

        // ============================================
        // NOVO v6.3: INTEGRA√á√ÉO COM SISTEMA CRUD SYNC
        // ============================================
        
        // Inicializar sistema CRUD quando produtos carregarem
        function inicializarCRUDSync() {
            if (window.produtoCRUD) {
                // Usar os arrays j√° processados em loadProducts
                const planilha = window.produtosPlanilha || [];
                const sugeridos = window.produtosSugeridos || [];
                
                if (planilha.length === 0 && sugeridos.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum produto dispon√≠vel para inicializar CRUD');
                    return;
                }
                
                console.log('üîÑ Inicializando CRUD com:');
                console.log('   üì¶ Planilha:', planilha.length, 'produtos');
                console.log('   üí° Sugeridos:', sugeridos.length, 'produtos');
                
                window.produtoCRUD.init(planilha, sugeridos);
                
                // Marcar como inicializado
                window.produtoCRUD._initialized = true;
                
                // Adicionar listener para sincroniza√ß√£o
                window.produtoCRUD.addListener((acao, dados) => {
                    console.log(`üîÑ Sincroniza√ß√£o: ${acao}`, dados);
                    
                    // Atualizar interface quando dados mudarem
                    if (['create', 'update', 'delete'].includes(acao)) {
                        atualizarInterfaceCompleta();
                        
                        // NOVO: Disparar auto-sync no GitHub
                        if (acao === 'create') {
                            dispararAutoSync('cria√ß√£o de produto');
                        } else if (acao === 'update') {
                            dispararAutoSync('edi√ß√£o de produto');
                        } else if (acao === 'delete') {
                            dispararAutoSync('exclus√£o de produto');
                        }
                    }
                });
                
                console.log('‚úÖ CRUD Sync integrado ao Admin');
                console.log('üìä Total de produtos no sistema:', window.produtoCRUD.listarProdutos().length);
            } else {
                if (!window.produtoCRUD) {
                    console.error('‚ùå window.produtoCRUD n√£o est√° dispon√≠vel!');
                }
            }
        }

        // Atualizar toda a interface ap√≥s mudan√ßas
        function atualizarInterfaceCompleta() {
            // N√ÉO precisa atualizar allProducts - os renders usam getProdutosAtualizados()
            // N√ÉO precisa chamar loadProducts() - ela s√≥ deve rodar na inicializa√ß√£o
            
            // Recarregar todas as √°reas (elas pegam dados frescos via getProdutosAtualizados)
            renderDashboard();
            renderSugestoes();
            renderCatalogo();
            renderAnalise();
            renderComparativo();
            updateStats();
            
            // Notifica√ß√£o visual
            mostrarNotificacao('‚úÖ Cat√°logo sincronizado com sucesso!', 'success');
        }

        // Fun√ß√£o auxiliar para mostrar notifica√ß√µes
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const cores = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            const notif = document.createElement('div');
            notif.className = `fixed top-4 right-4 ${cores[tipo]} text-white px-6 py-4 rounded-lg shadow-2xl z-[9999] animate-bounce`;
            notif.innerHTML = `<strong>${mensagem}</strong>`;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.remove();
            }, 3000);
        }

        // ============================================
        // NOVO v6.3: IMPORTADOR DE EXCEL/CSV
        // ============================================
        
        function abrirImportadorExcel() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content max-w-4xl mx-4">
                    <div class="p-8">
                        <div class="flex justify-between items-start mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">
                                <i class="fas fa-file-excel text-green-600 mr-2"></i>
                                Importar Produtos de Excel/CSV
                            </h2>
                            <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg mb-6">
                            <h3 class="font-bold text-blue-800 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Como Usar
                            </h3>
                            <ol class="text-sm text-blue-900 space-y-1 list-decimal list-inside">
                                <li>Baixe o template CSV clicando no bot√£o abaixo</li>
                                <li>Preencha a planilha com os dados dos produtos</li>
                                <li>Salve como CSV (separado por v√≠rgulas)</li>
                                <li>Fa√ßa upload do arquivo aqui</li>
                            </ol>
                        </div>

                        <div class="mb-6">
                            <a href="TEMPLATE-IMPORTACAO-PRODUTOS.csv" download
                               class="inline-block px-6 py-3 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg transition-all">
                                <i class="fas fa-download mr-2"></i>Baixar Template CSV
                            </a>
                        </div>

                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4">
                            <input type="file" id="csvFileInput" accept=".csv,.txt" class="hidden" onchange="processarArquivoCSV(this)">
                            <label for="csvFileInput" class="cursor-pointer">
                                <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                                <p class="text-lg font-bold text-gray-700 mb-2">Clique para selecionar arquivo CSV</p>
                                <p class="text-sm text-gray-500">ou arraste e solte aqui</p>
                            </label>
                        </div>

                        <div id="importPreview" class="hidden">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Preview da Importa√ß√£o:</h3>
                            <div id="importPreviewContent" class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto"></div>
                            
                            <div class="flex gap-4 mt-6">
                                <button onclick="executarImportacao()" 
                                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                    <i class="fas fa-check-circle mr-2"></i>Confirmar Importa√ß√£o
                                </button>
                                <button onclick="cancelarImportacao()" 
                                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                    <i class="fas fa-times-circle mr-2"></i>Cancelar
                                </button>
                            </div>
                        </div>

                        <div id="importResults" class="hidden mt-6"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        let produtosParaImportar = [];

        function processarArquivoCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const conteudo = e.target.result;
                const linhas = conteudo.split('\n');
                
                // Ignorar primeira linha (cabe√ßalho)
                const cabecalho = linhas[0].split(',');
                
                produtosParaImportar = [];
                
                for (let i = 1; i < linhas.length; i++) {
                    if (!linhas[i].trim()) continue;
                    
                    const valores = linhas[i].split(',');
                    
                    const produto = {
                        sku: valores[0]?.trim(),
                        nome: valores[1]?.trim(),
                        categoria: valores[2]?.trim(),
                        subcategoria: valores[3]?.trim(),
                        fornecedor: valores[4]?.trim(),
                        quantidade: parseInt(valores[5]) || 0,
                        custoBase: parseFloat(valores[6]) || 0,
                        precoMercado: parseFloat(valores[7]) || 0,
                        margem: parseFloat(valores[8]) || 0,
                        estoque: valores[9]?.trim() || 'Para Compra',
                        imagem: valores[10]?.trim(),
                        linkCompra: valores[11]?.trim(),
                        descricao: valores[12]?.trim(),
                        especificacoes: {
                            marca: valores[13]?.trim(),
                            modelo: valores[14]?.trim(),
                            garantia: valores[15]?.trim()
                        }
                    };
                    
                    produtosParaImportar.push(produto);
                }
                
                mostrarPreviewImportacao();
            };
            
            reader.readAsText(file);
        }

        function mostrarPreviewImportacao() {
            const preview = document.getElementById('importPreview');
            const content = document.getElementById('importPreviewContent');
            
            preview.classList.remove('hidden');
            
            let html = `
                <div class="mb-4 p-4 bg-blue-50 rounded">
                    <strong>${produtosParaImportar.length} produtos</strong> prontos para importar
                </div>
                <table class="w-full text-sm">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="p-2 text-left">SKU</th>
                            <th class="p-2 text-left">Nome</th>
                            <th class="p-2 text-left">Categoria</th>
                            <th class="p-2 text-right">Custo</th>
                            <th class="p-2 text-right">Margem</th>
                            <th class="p-2 text-right">Venda</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            produtosParaImportar.forEach(p => {
                const precoVenda = p.custoBase * (1 + p.margem / 100);
                html += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">${p.sku}</td>
                        <td class="p-2">${p.nome}</td>
                        <td class="p-2">${p.categoria}</td>
                        <td class="p-2 text-right">R$ ${p.custoBase.toFixed(2)}</td>
                        <td class="p-2 text-right">${p.margem}%</td>
                        <td class="p-2 text-right font-bold">R$ ${precoVenda.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            content.innerHTML = html;
        }

        function executarImportacao() {
            if (!window.produtoCRUD) {
                alert('Sistema CRUD n√£o inicializado!');
                return;
            }
            
            const resultados = window.produtoCRUD.importarProdutos(produtosParaImportar, 'planilha');
            
            const resultsDiv = document.getElementById('importResults');
            resultsDiv.classList.remove('hidden');
            
            resultsDiv.innerHTML = `
                <div class="p-6 rounded-lg ${resultados.erros.length === 0 ? 'bg-green-50' : 'bg-yellow-50'}">
                    <h3 class="text-lg font-bold mb-4">
                        <i class="fas fa-check-circle text-green-600 mr-2"></i>
                        Resultado da Importa√ß√£o
                    </h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="text-center p-4 bg-white rounded">
                            <div class="text-3xl font-bold text-blue-600">${resultados.total}</div>
                            <div class="text-sm text-gray-600">Total</div>
                        </div>
                        <div class="text-center p-4 bg-white rounded">
                            <div class="text-3xl font-bold text-green-600">${resultados.sucesso.length}</div>
                            <div class="text-sm text-gray-600">Sucesso</div>
                        </div>
                        <div class="text-center p-4 bg-white rounded">
                            <div class="text-3xl font-bold text-red-600">${resultados.erros.length}</div>
                            <div class="text-sm text-gray-600">Erros</div>
                        </div>
                    </div>
                    
                    ${resultados.erros.length > 0 ? `
                        <div class="mt-4 p-4 bg-red-50 rounded">
                            <h4 class="font-bold text-red-800 mb-2">Erros encontrados:</h4>
                            <ul class="text-sm text-red-700 list-disc list-inside">
                                ${resultados.erros.map(e => `<li>Linha ${e.index + 1}: ${e.erro}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <button onclick="finalizarImportacao()" 
                            class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                        <i class="fas fa-check mr-2"></i>Concluir
                    </button>
                </div>
            `;
            
            // Atualizar interface
            atualizarInterfaceCompleta();
        }

        function cancelarImportacao() {
            document.getElementById('importPreview').classList.add('hidden');
            document.getElementById('csvFileInput').value = '';
            produtosParaImportar = [];
        }

        function finalizarImportacao() {
            document.querySelector('.modal.active').remove();
            mostrarNotificacao('‚úÖ Importa√ß√£o conclu√≠da com sucesso!', 'success');
        }

        // ============================================
        // MELHORIAS NO CRUD MODAL EXISTENTE
        // ============================================
        
        // Sobrescrever fun√ß√£o de salvar produto para usar CRUD Sync
        const salvarProdutoOriginal = window.salvarProduto;
        window.salvarProduto = function() {
            const dadosProduto = {
                sku: document.getElementById('crud_sku').value,
                nome: document.getElementById('crud_nome').value,
                categoria: document.getElementById('crud_categoria').value,
                subcategoria: document.getElementById('crud_subcategoria').value,
                fornecedor: document.getElementById('crud_fornecedor').value,
                quantidade: parseInt(document.getElementById('crud_quantidade').value),
                custoBase: parseFloat(document.getElementById('crud_custoBase').value),
                precoMercado: parseFloat(document.getElementById('crud_precoMercado').value),
                margem: parseFloat(document.getElementById('crud_margem').value),
                imagem: document.getElementById('crud_imagem').value,
                descricao: document.getElementById('crud_descricao').value,
                especificacoes: coletarEspecificacoes()
            };
            
            if (window.produtoCRUD) {
                if (currentCrudMode === 'create') {
                    const resultado = window.produtoCRUD.criarProduto(dadosProduto, 'planilha');
                    
                    if (resultado.sucesso) {
                        mostrarNotificacao('‚úÖ Produto criado com sucesso!', 'success');
                        closeCrudModal();
                        atualizarInterfaceCompleta();
                    } else {
                        mostrarNotificacao('‚ùå Erro: ' + resultado.erro, 'error');
                    }
                } else if (currentCrudMode === 'edit') {
                    const resultado = window.produtoCRUD.atualizarProduto(currentEditingProductId, dadosProduto);
                    
                    if (resultado.sucesso) {
                        mostrarNotificacao('‚úÖ Produto atualizado com sucesso!', 'success');
                        
                        // Salvar ID do produto antes de fechar
                        const produtoId = currentEditingProductId;
                        
                        // Fechar modal
                        closeCrudModal();
                        
                        // Atualizar interface
                        atualizarInterfaceCompleta();
                        
                        // Reabrir modal com dados atualizados ap√≥s 300ms
                        setTimeout(() => {
                            abrirCrudModal('edit', produtoId);
                        }, 300);
                    } else {
                        mostrarNotificacao('‚ùå Erro: ' + resultado.erro, 'error');
                    }
                }
            } else {
                // Fallback para m√©todo original
                if (salvarProdutoOriginal) {
                    salvarProdutoOriginal();
                }
            }
        };

        function coletarEspecificacoes() {
            const especificacoes = {};
            const campos = document.querySelectorAll('[id^="espec_key_"]');
            
            campos.forEach(campo => {
                const index = campo.id.split('_')[2];
                const chave = campo.value;
                const valor = document.getElementById(`espec_value_${index}`).value;
                
                if (chave && valor) {
                    especificacoes[chave] = valor;
                }
            });
            
            return especificacoes;
        }

        // Fun√ß√£o de duplica√ß√£o de produto
        window.duplicarProduto = function(produtoId) {
            if (!window.produtoCRUD) {
                alert('Sistema CRUD n√£o dispon√≠vel');
                return;
            }
            
            if (confirm('Deseja duplicar este produto?')) {
                const resultado = window.produtoCRUD.duplicarProduto(produtoId);
                
                if (resultado.sucesso) {
                    // Registrar no hist√≥rico
                    registrarAtualizacaoProduto(resultado.produto.id, resultado.produto.nome, 'duplicado');
                    
                    mostrarNotificacao('‚úÖ Produto duplicado com sucesso!', 'success');
                    atualizarInterfaceCompleta();
                } else {
                    mostrarNotificacao('‚ùå Erro ao duplicar: ' + resultado.erro, 'error');
                }
            }
        };

        // Fun√ß√£o de exclus√£o de produto
        window.excluirProduto = function(produtoId) {
            if (!window.produtoCRUD) {
                alert('Sistema CRUD n√£o dispon√≠vel');
                return;
            }
            
            if (confirm('Tem certeza que deseja excluir este produto?\n\nEsta a√ß√£o pode ser desfeita.')) {
                const resultado = window.produtoCRUD.excluirProduto(produtoId, false); // Soft delete
                
                if (resultado.sucesso) {
                    mostrarNotificacao('‚úÖ Produto exclu√≠do com sucesso!', 'success');
                    atualizarInterfaceCompleta();
                } else {
                    mostrarNotificacao('‚ùå Erro ao excluir: ' + resultado.erro, 'error');
                }
            }
        };

        // Adicionar bot√µes de duplicar e excluir nos cart√µes de produtos
        function adicionarBotoesCRUD(produtoId, container) {
            const botoesHTML = `
                <div class="flex gap-2 mt-4">
                    <button onclick="openCrudModal('edit', ${produtoId})" 
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded transition-all">
                        <i class="fas fa-edit mr-1"></i>Editar
                    </button>
                    <button onclick="duplicarProduto(${produtoId})" 
                            class="flex-1 bg-purple-500 hover:bg-purple-600 text-white text-sm py-2 px-3 rounded transition-all">
                        <i class="fas fa-copy mr-1"></i>Duplicar
                    </button>
                    <button onclick="excluirProduto(${produtoId})" 
                            class="flex-1 bg-red-500 hover:bg-red-600 text-white text-sm py-2 px-3 rounded transition-all">
                        <i class="fas fa-trash mr-1"></i>Excluir
                    </button>
                </div>
            `;
            
            if (container) {
                container.insertAdjacentHTML('beforeend', botoesHTML);
            }
        }

        // Inicializar CRUD Sync quando o DOM carregar
        // NOTA: Agora √© chamado diretamente no DOMContentLoaded
        // Mantendo este setTimeout apenas como fallback de seguran√ßa
        setTimeout(() => {
            if (window.produtoCRUD && !window.produtoCRUD._initialized) {
                console.warn('‚ö†Ô∏è Fallback: Inicializando CRUD via setTimeout');
                inicializarCRUDSync();
            }
        }, 1000);

        // ============================================
        // NOVO v6.3: SISTEMA DE PERSIST√äNCIA LOCAL
        // ============================================
        
        let persistenciaAtiva = false;
        let metodoAtivo = null;
        let githubConfig = null;

        /**
         * Salvar configura√ß√µes no localStorage
         */
        function salvarConfiguracoesAdmin() {
            const config = {
                persistenciaAtiva: persistenciaAtiva,
                metodoAtivo: metodoAtivo,
                githubConfig: githubConfig,
                autoSyncAtivo: autoSyncAtivo  // NOVO: Salvar estado do auto-sync
            };
            
            try {
                localStorage.setItem('adminConfig_priobf25', JSON.stringify(config));
                console.log('‚úÖ Configura√ß√µes salvas:', config);
            } catch (e) {
                console.error('‚ùå Erro ao salvar configura√ß√µes:', e);
            }
        }
        
        /**
         * Carregar configura√ß√µes do localStorage
         */
        function carregarConfiguracoesAdmin() {
            try {
                const configSalva = localStorage.getItem('adminConfig_priobf25');
                if (configSalva) {
                    const config = JSON.parse(configSalva);
                    
                    persistenciaAtiva = config.persistenciaAtiva || false;
                    metodoAtivo = config.metodoAtivo || null;
                    githubConfig = config.githubConfig || null;
                    autoSyncAtivo = config.autoSyncAtivo || false;  // NOVO: Restaurar auto-sync
                    
                    console.log('‚úÖ Configura√ß√µes carregadas:', config);
                    
                    // Reativar auto-sync se estava ativo
                    if (autoSyncAtivo && githubConfig && githubConfig.token) {
                        console.log('üîÑ Auto-Sync GitHub reativado automaticamente');
                        mostrarNotificacao('‚úÖ Auto-Sync GitHub ativado! Produtos ser√£o salvos automaticamente.', 'success');
                        
                        // Atualizar badge ap√≥s um delay (aguardar DOM carregar)
                        setTimeout(() => {
                            atualizarBadgeAutoSync();
                        }, 500);
                    }
                    
                    // Reativar persist√™ncia se estava ativa
                    if (persistenciaAtiva && metodoAtivo) {
                        console.log(`üîÑ Reativando persist√™ncia: ${metodoAtivo}`);
                        
                        if (window.produtoPersistencia && window.produtoCRUD) {
                            window.produtoPersistencia.inicializar(window.produtoCRUD, {
                                metodo: metodoAtivo,
                                autoSave: true,
                                autoLoad: metodoAtivo === 'localStorage',
                                githubConfig: githubConfig
                            });
                            
                            atualizarStatusPersistencia();
                            
                            // Marcar visualmente op√ß√£o ativa
                            setTimeout(() => {
                                const optionEl = document.getElementById(`option-${metodoAtivo}`);
                                if (optionEl) {
                                    document.querySelectorAll('[id^="option-"]').forEach(el => {
                                        el.classList.remove('border-green-500');
                                        el.classList.add('border-gray-200');
                                    });
                                    
                                    optionEl.classList.remove('border-gray-200');
                                    optionEl.classList.add('border-green-500');
                                }
                            }, 100);
                            
                            mostrarNotificacao(`‚úÖ Persist√™ncia ${metodoAtivo} reativada automaticamente`, 'success');
                        }
                    }
                    
                    return true;
                }
            } catch (e) {
                console.error('‚ùå Erro ao carregar configura√ß√µes:', e);
            }
            
            return false;
        }
        
        /**
         * Ativar persist√™ncia autom√°tica
         */
        function ativarPersistencia(metodo) {
            if (!window.produtoPersistencia || !window.produtoCRUD) {
                alert('‚ùå Sistema de persist√™ncia n√£o carregado!');
                return;
            }
            
            // Confirmar com usu√°rio
            const mensagens = {
                localStorage: 'Salvar automaticamente no navegador (LocalStorage)?\n\n' +
                             '‚úÖ Produtos ser√£o salvos a cada altera√ß√£o\n' +
                             '‚úÖ Persistem entre sess√µes\n' +
                             '‚ö†Ô∏è Limite de ~5MB',
                             
                download: 'Baixar arquivo JS ap√≥s cada altera√ß√£o?\n\n' +
                         '‚ö†Ô∏è Voc√™ precisar√° substituir o arquivo produtos-v6.1.js manualmente\n' +
                         '‚úÖ Sem limite de tamanho\n' +
                         '‚úÖ Backup f√≠sico dos dados',
                         
                github: 'Configurar GitHub API para salvamento autom√°tico?\n\n' +
                       'Voc√™ ser√° direcionado para configura√ß√£o.'
            };
            
            if (metodo === 'github') {
                abrirConfigGitHub();
                return;
            }
            
            if (!confirm(mensagens[metodo])) {
                return;
            }
            
            // Inicializar persist√™ncia
            window.produtoPersistencia.inicializar(window.produtoCRUD, {
                metodo: metodo,
                autoSave: true,
                autoLoad: metodo === 'localStorage', // S√≥ auto-load no localStorage
                githubConfig: githubConfig
            });
            
            persistenciaAtiva = true;
            metodoAtivo = metodo;
            
            // Salvar configura√ß√µes
            salvarConfiguracoesAdmin();
            
            atualizarStatusPersistencia();
            mostrarNotificacao(`‚úÖ Salvamento autom√°tico ativado: ${metodo}`, 'success');
            
            // Marcar visualmente op√ß√£o ativa
            document.querySelectorAll('[id^="option-"]').forEach(el => {
                el.classList.remove('border-green-500');
                el.classList.add('border-gray-200');
            });
            
            document.getElementById(`option-${metodo}`).classList.remove('border-gray-200');
            document.getElementById(`option-${metodo}`).classList.add('border-green-500');
        }

        /**
         * Atualizar status visual
         */
        function atualizarStatusPersistencia() {
            const statusTexto = document.getElementById('statusPersistenciaTexto');
            
            if (persistenciaAtiva) {
                const icones = {
                    localStorage: 'fas fa-database',
                    download: 'fas fa-download',
                    github: 'fab fa-github'
                };
                
                const nomes = {
                    localStorage: 'LocalStorage',
                    download: 'Download Autom√°tico',
                    github: 'GitHub API'
                };
                
                statusTexto.innerHTML = `
                    <i class="${icones[metodoAtivo]} text-green-600 mr-1"></i>
                    <span class="text-green-600">Ativo: ${nomes[metodoAtivo]}</span>
                `;
            } else {
                statusTexto.innerHTML = `
                    <i class="fas fa-times-circle text-red-600 mr-1"></i>
                    <span class="text-red-600">Desativado</span>
                `;
            }
        }

        /**
         * Verificar espa√ßo do LocalStorage
         */
        function verificarEspacoStorage() {
            if (!window.produtoPersistencia) {
                alert('Sistema de persist√™ncia n√£o carregado');
                return;
            }
            
            const espaco = window.produtoPersistencia.verificarEspacoLocalStorage();
            
            const mensagem = `üìä Informa√ß√µes do LocalStorage:\n\n` +
                           `Usado: ${espaco.usadoMB}MB\n` +
                           `Dispon√≠vel: ${espaco.disponivelMB}MB\n` +
                           `Limite: ${espaco.limiteMB}MB\n` +
                           `Ocupa√ß√£o: ${espaco.percentualUsado}%\n\n` +
                           `${espaco.percentualUsado > 80 ? '‚ö†Ô∏è Espa√ßo quase cheio! Considere usar Download ou GitHub.' : '‚úÖ Espa√ßo suficiente.'}`;
            
            alert(mensagem);
        }

        /**
         * Abrir configura√ß√£o do GitHub
         */
        function abrirConfigGitHub() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content max-w-2xl mx-4">
                    <div class="p-8">
                        <div class="flex justify-between items-start mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">
                                <i class="fab fa-github mr-2"></i>
                                Configurar GitHub API
                            </h2>
                            <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg mb-6">
                            <h3 class="font-bold text-blue-800 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>Como Configurar
                            </h3>
                            <ol class="text-sm text-blue-900 space-y-1 list-decimal list-inside">
                                <li>Acesse: <a href="https://github.com/settings/tokens" target="_blank" class="underline">GitHub Settings ‚Üí Tokens</a></li>
                                <li>Clique "Generate new token (classic)"</li>
                                <li>Marque permiss√£o: <code class="bg-blue-100 px-1">repo</code></li>
                                <li>Copie o token gerado</li>
                                <li>Cole abaixo junto com as informa√ß√µes do reposit√≥rio</li>
                            </ol>
                        </div>

                        <form id="githubConfigForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    Token de Acesso *
                                </label>
                                <input type="password" id="github_token" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                
                                <!-- NOVA OP√á√ÉO: Salvar Token -->
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <label class="flex items-start cursor-pointer">
                                        <input type="checkbox" id="salvar_token_permanente" 
                                               class="mt-1 mr-3 w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                        <div class="flex-1">
                                            <span class="text-sm font-bold text-gray-700">
                                                üíæ Salvar token permanentemente
                                            </span>
                                            <p class="text-xs text-gray-600 mt-1">
                                                ‚úÖ Token ser√° salvo no LocalStorage (criptografado)<br>
                                                ‚úÖ Auto-Sync ficar√° sempre ativo<br>
                                                ‚ö†Ô∏è Use apenas em computador pessoal seguro
                                            </p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    Owner (Usu√°rio/Organiza√ß√£o) *
                                </label>
                                <input type="text" id="github_owner" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="seu-usuario">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    Reposit√≥rio *
                                </label>
                                <input type="text" id="github_repo" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="priobf25">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    Branch
                                </label>
                                <input type="text" id="github_branch"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="main" value="main">
                            </div>

                            <div class="flex gap-4 mt-6">
                                <button type="submit" 
                                        class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                    <i class="fas fa-check-circle mr-2"></i>Salvar e Ativar
                                </button>
                                <button type="button" onclick="this.closest('.modal').remove()" 
                                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                    <i class="fas fa-times-circle mr-2"></i>Cancelar
                                </button>
                            </div>

                            <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 text-sm">
                                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> O token ser√° armazenado apenas durante a sess√£o. 
                                Para persistir, salve em local seguro.
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handler do formul√°rio
            document.getElementById('githubConfigForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                githubConfig = {
                    token: document.getElementById('github_token').value,
                    owner: document.getElementById('github_owner').value,
                    repo: document.getElementById('github_repo').value,
                    branch: document.getElementById('github_branch').value || 'main'
                };
                
                // Fechar modal
                modal.remove();
                
                // Ativar persist√™ncia com GitHub
                if (!window.produtoPersistencia || !window.produtoCRUD) {
                    alert('‚ùå Sistema de persist√™ncia n√£o carregado!');
                    return;
                }
                
                window.produtoPersistencia.inicializar(window.produtoCRUD, {
                    metodo: 'github',
                    autoSave: true,
                    autoLoad: false,
                    githubConfig: githubConfig
                });
                
                persistenciaAtiva = true;
                metodoAtivo = 'github';
                
                // Salvar configura√ß√µes incluindo GitHub config
                salvarConfiguracoesAdmin();
                
                atualizarStatusPersistencia();
                mostrarNotificacao('‚úÖ GitHub API configurado e ativado!', 'success');
                
                // Marcar visualmente
                document.querySelectorAll('[id^="option-"]').forEach(el => {
                    el.classList.remove('border-green-500');
                    el.classList.add('border-gray-200');
                });
                
                document.getElementById('option-github').classList.remove('border-gray-200');
                document.getElementById('option-github').classList.add('border-green-500');
                
                // NOVO: Perguntar sobre Auto-Sync
                setTimeout(() => {
                    const ativar = confirm(
                        'üîÑ Ativar Auto-Sync no GitHub?\n\n' +
                        '‚úÖ Produtos ser√£o salvos AUTOMATICAMENTE no GitHub ap√≥s:\n' +
                        '   ‚Ä¢ Criar novo produto\n' +
                        '   ‚Ä¢ Editar produto existente\n' +
                        '   ‚Ä¢ Duplicar produto\n' +
                        '   ‚Ä¢ Excluir produto\n\n' +
                        '‚ö° O arquivo produtos-v6.1.js ser√° atualizado automaticamente\n' +
                        'üåê O site ser√° atualizado em 2-3 minutos\n\n' +
                        'Deseja ativar o Auto-Sync?'
                    );
                    
                    if (ativar) {
                        ativarAutoSync();
                    }
                }, 500);
            });
        }

        /**
         * Testar salvamento manual
         */
        function testarSalvamento() {
            if (!window.produtoPersistencia || !window.produtoCRUD) {
                alert('Sistema n√£o carregado');
                return;
            }
            
            const metodo = prompt('M√©todo de teste (localStorage, download, github):', 'localStorage');
            
            if (!metodo) return;
            
            let resultado;
            
            switch (metodo) {
                case 'localStorage':
                    resultado = window.produtoPersistencia.salvarNoLocalStorage(
                        window.produtoCRUD.produtosPlanilha,
                        window.produtoCRUD.produtosSugeridos
                    );
                    break;
                    
                case 'download':
                    resultado = window.produtoPersistencia.baixarArquivoJS(
                        window.produtoCRUD.produtosPlanilha,
                        window.produtoCRUD.produtosSugeridos
                    );
                    break;
                    
                case 'github':
                    if (!githubConfig) {
                        alert('Configure GitHub primeiro!');
                        return;
                    }
                    window.produtoPersistencia.salvarNoGitHub(
                        window.produtoCRUD.produtosPlanilha,
                        window.produtoCRUD.produtosSugeridos,
                        githubConfig
                    ).then(resultado => {
                        alert(resultado.sucesso ? 
                            `‚úÖ Salvo no GitHub!\n${resultado.url}` : 
                            `‚ùå Erro: ${resultado.erro}`
                        );
                    });
                    return;
            }
            
            if (resultado) {
                alert(resultado.sucesso ? 
                    `‚úÖ Teste bem sucedido!\nM√©todo: ${resultado.metodo}` : 
                    `‚ùå Erro: ${resultado.erro}`
                );
            }
        }

        // Adicionar ao console global para debug
        window.testarSalvamento = testarSalvamento;

        // ============================================
        // NOVA FUNCIONALIDADE v6.3.1: SALVAR PRE√áOS NO ARQUIVO
        // ============================================
        
        /**
         * Gerar conte√∫do atualizado do arquivo produtos-v6.1.js
         * com todos os produtos atuais (incluindo pre√ßos atualizados)
         */
        function gerarArquivoProdutosJS() {
            try {
                // Pegar todos os produtos atuais
                const produtosAtualizados = allProducts;
                
                // Gerar o conte√∫do do arquivo JS
                let conteudo = `// ============================================\n`;
                conteudo += `// ARQUIVO DE PRODUTOS - Black Friday PRIO 2025\n`;
                conteudo += `// Atualizado automaticamente via Admin Panel\n`;
                conteudo += `// Data: ${new Date().toLocaleString('pt-BR')}\n`;
                conteudo += `// Total de produtos: ${produtosAtualizados.length}\n`;
                conteudo += `// ============================================\n\n`;
                
                conteudo += `// Array principal de produtos\n`;
                conteudo += `const todosOsProdutosV6 = ${JSON.stringify(produtosAtualizados, null, 2)};\n\n`;
                
                conteudo += `// Exportar para uso global\n`;
                conteudo += `if (typeof window !== 'undefined') {\n`;
                conteudo += `    window.todosOsProdutosV6 = todosOsProdutosV6;\n`;
                conteudo += `}\n`;
                
                return conteudo;
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar arquivo:', error);
                return null;
            }
        }
        
        /**
         * Baixar arquivo produtos-v6.1.js atualizado
         */
        function baixarArquivoProdutosAtualizado() {
            const conteudo = gerarArquivoProdutosJS();
            
            if (!conteudo) {
                alert('‚ùå Erro ao gerar arquivo!');
                return;
            }
            
            // Criar blob e fazer download
            const blob = new Blob([conteudo], { type: 'text/javascript;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'produtos-v6.1.js';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('‚úÖ Arquivo produtos-v6.1.js baixado! Substitua o arquivo antigo.', 'success');
            
            console.log('‚úÖ Arquivo produtos-v6.1.js gerado e baixado');
            console.log(`üì¶ Total de produtos: ${allProducts.length}`);
        }
        
        /**
         * Salvar produtos no GitHub via Pages Function (100% autom√°tico)
         */
        async function salvarProdutosNoGitHub() {
            // SEMPRE usar Pages Function (m√©todo autom√°tico - sem precisar de token)
            if (window.gitHubSyncWorker && window.gitHubSyncWorker.isConfigurado()) {
                try {
                    console.log('üöÄ Salvando via Pages Function (m√©todo autom√°tico)...');
                    
                    const todosProdutos = getProdutosAtualizados();
                    console.log(`üì¶ Salvando ${todosProdutos.length} produtos...`);
                    
                    mostrarNotificacao('üîÑ Salvando produtos via Pages Function...', 'info');
                    
                    const resultado = await window.gitHubSyncWorker.salvarProdutos(todosProdutos);
                    
                    if (resultado.sucesso) {
                        mostrarNotificacao(
                            `‚úÖ ${resultado.total} produtos salvos com sucesso!\n\nü§ñ Commit autom√°tico realizado\nüöÄ Deploy em andamento (2-3 min)`, 
                            'success'
                        );
                        console.log('‚úÖ Commit:', resultado.detalhes);
                        return;
                    } else {
                        throw new Error(resultado.mensagem || 'Erro desconhecido');
                    }
                } catch (erro) {
                    console.error('‚ùå Erro ao salvar via Pages Function:', erro);
                    mostrarNotificacao(`‚ùå Erro ao salvar: ${erro.message}`, 'error');
                    return;
                }
            }
            
            // FALLBACK: Se Pages Function n√£o estiver dispon√≠vel
            alert('‚ùå Pages Function n√£o dispon√≠vel!\n\n' +
                  'Verifique:\n' +
                  '1. GITHUB_TOKEN est√° configurado no Cloudflare Pages?\n' +
                  '2. Deploy foi realizado ap√≥s configura√ß√£o?\n' +
                  '3. Aguardou 2-3 minutos ap√≥s deploy?\n\n' +
                  'Console: Verifique mensagens de erro no console (F12)');
            return;
            
            const conteudo = gerarArquivoProdutosJS();
            
            if (!conteudo) {
                alert('‚ùå Erro ao gerar conte√∫do!');
                return;
            }
            
            try {
                mostrarNotificacao('üîÑ Salvando produtos-v6.1.js no GitHub...', 'info');
                
                const { token, owner, repo, branch } = githubConfig;
                const path = 'produtos-v6.1.js';
                
                // 1. Buscar SHA do arquivo atual (OBRIGAT√ìRIO para updates)
                let sha = null;
                console.log('üì• Buscando SHA do arquivo...');
                
                try {
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}&_=${Date.now()}`,
                        {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Cache-Control': 'no-cache'
                            },
                            mode: 'cors'
                        }
                    );
                    
                    if (getResponse.ok) {
                        const data = await getResponse.json();
                        sha = data.sha;
                        console.log('‚úÖ SHA obtido:', sha.substring(0, 8) + '...');
                    } else {
                        const errorText = await getResponse.text();
                        console.warn('‚ö†Ô∏è Erro HTTP ao buscar SHA:', getResponse.status, errorText);
                        throw new Error(`HTTP ${getResponse.status}: ${errorText}`);
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao buscar SHA:', e.message);
                    throw new Error(`N√£o foi poss√≠vel buscar SHA do arquivo: ${e.message}. Verifique o token e as permiss√µes.`);
                }
                
                // 2. Valida√ß√£o: SHA √© OBRIGAT√ìRIO
                if (!sha) {
                    throw new Error('SHA n√£o dispon√≠vel. N√£o √© poss√≠vel atualizar o arquivo.');
                }
                
                // 3. Criar/atualizar arquivo COM SHA
                console.log('üì§ Enviando arquivo para GitHub...');
                const content = btoa(unescape(encodeURIComponent(conteudo)));
                
                const putResponse = await fetch(
                    `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        mode: 'cors',
                        body: JSON.stringify({
                            message: `Atualizar produtos-v6.1.js via Admin Panel (${allProducts.length} produtos) - ${new Date().toLocaleString('pt-BR')}`,
                            content: content,
                            branch: branch,
                            sha: sha  // SHA agora √© obrigat√≥rio (n√£o opcional)
                        })
                    }
                );
                
                if (!putResponse.ok) {
                    const error = await putResponse.json();
                    throw new Error(error.message || 'Erro ao salvar no GitHub');
                }
                
                const result = await putResponse.json();
                
                mostrarNotificacao('‚úÖ produtos-v6.1.js salvo no GitHub com sucesso!', 'success');
                
                console.log('‚úÖ Arquivo salvo no GitHub:', result.content.html_url);
                console.log(`üì¶ Total de produtos: ${allProducts.length}`);
                
                // Mostrar modal de sucesso com detalhes
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content max-w-2xl mx-4">
                        <div class="p-8">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">‚úÖ</div>
                                <h2 class="text-3xl font-bold text-green-600 mb-2">
                                    Arquivo Salvo no GitHub!
                                </h2>
                                <p class="text-gray-600">produtos-v6.1.js atualizado com sucesso</p>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-6 mb-6 space-y-3">
                                <div class="flex justify-between">
                                    <span class="font-semibold">üì¶ Total de produtos:</span>
                                    <span class="text-blue-600">${allProducts.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-semibold">üìÅ Reposit√≥rio:</span>
                                    <span class="text-blue-600">${owner}/${repo}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-semibold">üåø Branch:</span>
                                    <span class="text-blue-600">${branch}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="font-semibold">üìÖ Data:</span>
                                    <span class="text-gray-600">${new Date().toLocaleString('pt-BR')}</span>
                                </div>
                            </div>
                            
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                                <p class="text-sm text-blue-800">
                                    <strong>‚ÑπÔ∏è Pr√≥ximo passo:</strong><br>
                                    O arquivo ser√° atualizado no site automaticamente ap√≥s o pr√≥ximo deploy do GitHub Pages (2-3 minutos).
                                </p>
                            </div>
                            
                            <div class="flex gap-3">
                                <a href="${result.content.html_url}" target="_blank"
                                   class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-center transition-all">
                                    <i class="fab fa-github mr-2"></i>Ver no GitHub
                                </a>
                                <button onclick="this.closest('.modal').remove()" 
                                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                    Fechar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar no GitHub:', error);
                mostrarNotificacao(`‚ùå Erro ao salvar no GitHub: ${error.message}`, 'error');
                
                alert(`‚ùå Erro ao salvar no GitHub!\n\n${error.message}\n\nVerifique:\n- Token tem permiss√£o 'repo'\n- Reposit√≥rio existe\n- Branch est√° correto`);
            }
        }
        
        // ============================================
        // AUTO-SYNC: SALVAMENTO AUTOM√ÅTICO NO GITHUB
        // ============================================
        
        let autoSyncAtivo = false;
        let autoSyncPendente = false;
        let autoSyncTimeout = null;
        
        /**
         * Verificar se auto-sync est√° configurado
         */
        function verificarAutoSync() {
            return autoSyncAtivo && githubConfig && githubConfig.token;
        }
        
        /**
         * Ativar auto-sync via Pages Function (n√£o precisa de token local)
         */
        function ativarAutoSync() {
            // Verificar se Pages Function est√° dispon√≠vel
            if (!window.gitHubSyncWorker || !window.gitHubSyncWorker.isConfigurado()) {
                alert('‚ùå Pages Function n√£o dispon√≠vel!\n\n' +
                      'Verifique:\n' +
                      '1. GITHUB_TOKEN configurado no Cloudflare Pages\n' +
                      '2. Deploy realizado ap√≥s configura√ß√£o\n' +
                      '3. Aguardou 2-3 minutos ap√≥s deploy\n\n' +
                      'Recarregue a p√°gina (Cmd+Shift+R) e tente novamente.');
                return false;
            }
            
            autoSyncAtivo = true;
            salvarConfiguracoesAdmin(); // Salvar prefer√™ncia
            
            // Atualizar badge
            atualizarBadgeAutoSync();
            
            mostrarNotificacao('‚úÖ Auto-Sync ativado! Produtos ser√£o salvos automaticamente via Pages Function.', 'success');
            
            console.log('‚úÖ Auto-Sync ATIVADO (via Pages Function)');
            console.log('üìù Produtos ser√£o salvos automaticamente ap√≥s criar/editar/duplicar');
            
            return true;
        }
        
        /**
         * Desativar auto-sync
         */
        function desativarAutoSync() {
            autoSyncAtivo = false;
            salvarConfiguracoesAdmin();
            
            // Atualizar badge
            atualizarBadgeAutoSync();
            
            mostrarNotificacao('‚ö†Ô∏è Auto-Sync GitHub desativado', 'info');
            console.log('‚ö†Ô∏è Auto-Sync GitHub DESATIVADO');
        }
        
        /**
         * Toggle auto-sync (ativar/desativar)
         */
        function toggleAutoSync() {
            if (autoSyncAtivo) {
                if (confirm('Desativar Auto-Sync no GitHub?\n\nVoc√™ precisar√° salvar manualmente usando o bot√£o "üíæ Salvar no Arquivo".')) {
                    desativarAutoSync();
                }
            } else {
                // Ativar Auto-Sync via Pages Function (sem precisar de token local)
                if (window.gitHubSyncWorker && window.gitHubSyncWorker.isConfigurado()) {
                    if (confirm(
                        'üîÑ Ativar Auto-Sync via Pages Function?\n\n' +
                        '‚úÖ Produtos ser√£o salvos AUTOMATICAMENTE ap√≥s:\n' +
                        '   ‚Ä¢ Criar novo produto\n' +
                        '   ‚Ä¢ Editar produto existente\n' +
                        '   ‚Ä¢ Duplicar produto\n' +
                        '   ‚Ä¢ Excluir produto\n\n' +
                        'ü§ñ Sincroniza√ß√£o via Cloudflare Pages Function\n' +
                        'üîí Token seguro no servidor (n√£o exposto)\n' +
                        'üåê Deploy autom√°tico em 2-3 minutos\n\n' +
                        'Deseja ativar o Auto-Sync?'
                    )) {
                        ativarAutoSync();
                    }
                } else {
                    alert('‚ùå Pages Function n√£o dispon√≠vel!\n\n' +
                          'Verifique:\n' +
                          '1. GITHUB_TOKEN configurado no Cloudflare Pages\n' +
                          '2. Deploy realizado ap√≥s configura√ß√£o\n' +
                          '3. Aguardou 2-3 minutos\n\n' +
                          'Recarregue a p√°gina e tente novamente.');
                }
            }
        }
        
        /**
         * Atualizar badge visual do auto-sync
         */
        function atualizarBadgeAutoSync() {
            const badge = document.getElementById('auto-sync-badge');
            const toggle = document.getElementById('auto-sync-toggle');
            const icon = document.getElementById('auto-sync-icon');
            
            if (!badge) return;
            
            if (autoSyncAtivo) {
                badge.textContent = 'ON';
                badge.className = 'text-sm font-semibold text-green-600';
                
                if (toggle) {
                    toggle.className = 'relative inline-block w-14 h-7 bg-green-500 rounded-full cursor-pointer transition-colors duration-300';
                    const toggleSpan = toggle.querySelector('span');
                    if (toggleSpan) {
                        toggleSpan.style.transform = 'translateX(28px)';
                    }
                }
                
                if (icon) {
                    icon.style.color = '#10b981';
                }
            } else {
                badge.textContent = 'OFF';
                badge.className = 'text-sm font-semibold text-gray-600';
                
                if (toggle) {
                    toggle.className = 'relative inline-block w-14 h-7 bg-gray-400 rounded-full cursor-pointer transition-colors duration-300';
                    const toggleSpan = toggle.querySelector('span');
                    if (toggleSpan) {
                        toggleSpan.style.transform = 'translateX(0)';
                    }
                }
                
                if (icon) {
                    icon.style.color = '#9ca3af';
                }
            }
        }
        
        /**
         * Disparar salvamento autom√°tico (debounced)
         */
        function dispararAutoSync(operacao = 'edi√ß√£o') {
            if (!verificarAutoSync()) {
                console.log('‚ÑπÔ∏è Auto-sync n√£o est√° ativo');
                return;
            }
            
            // Limpar timeout anterior
            if (autoSyncTimeout) {
                clearTimeout(autoSyncTimeout);
            }
            
            // Marcar como pendente
            autoSyncPendente = true;
            
            // Mostrar notifica√ß√£o visual no √≠cone
            const icon = document.getElementById('auto-sync-icon');
            if (icon) {
                icon.className = 'fas fa-sync-alt fa-spin';
                icon.style.color = '#fbbf24';
            }
            
            // Aguardar 2 segundos antes de salvar (debounce)
            autoSyncTimeout = setTimeout(async () => {
                console.log(`üîÑ Auto-sync disparado ap√≥s ${operacao}`);
                
                try {
                    await salvarProdutosNoGitHubSilencioso();
                    
                    autoSyncPendente = false;
                    
                    // Atualizar √≠cone para sucesso
                    if (icon) {
                        icon.className = 'fas fa-check-circle';
                        icon.style.color = '#10b981';
                        
                        // Voltar ao normal ap√≥s 3 segundos
                        setTimeout(() => {
                            icon.className = 'fas fa-sync-alt';
                            icon.style.color = '#10b981';
                        }, 3000);
                    }
                    
                    console.log(`‚úÖ Auto-sync conclu√≠do (${operacao})`);
                    
                    // Atualizar √∫ltimo commit ap√≥s 2 segundos
                    setTimeout(() => {
                        carregarUltimoCommit();
                    }, 2000);
                    
                } catch (error) {
                    console.error('‚ùå Erro no auto-sync:', error);
                    
                    // Mostrar erro no √≠cone
                    if (icon) {
                        icon.className = 'fas fa-exclamation-circle';
                        icon.style.color = '#ef4444';
                        
                        // Voltar ao normal ap√≥s 5 segundos
                        setTimeout(() => {
                            icon.className = 'fas fa-sync-alt';
                            icon.style.color = '#10b981';
                        }, 5000);
                    }
                }
            }, 2000);
        }
        
        /**
         * Salvar no GitHub silenciosamente (sem modal)
         * Com retry autom√°tico em caso de SHA mismatch
         */
        async function salvarProdutosNoGitHubSilencioso(tentativa = 1) {
            const conteudo = gerarArquivoProdutosJS();
            
            if (!conteudo) {
                throw new Error('Erro ao gerar conte√∫do');
            }
            
            const { token, owner, repo, branch } = githubConfig;
            const path = 'produtos-v6.1.js';
            
            console.log(`üîÑ Tentativa ${tentativa} de salvar no GitHub...`);
            
            // 1. SEMPRE buscar SHA mais recente do arquivo (OBRIGAT√ìRIO para updates)
            let sha = null;
            try {
                console.log('üì• Buscando SHA mais recente do arquivo...');
                const getResponse = await fetch(
                    `https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}&_=${Date.now()}`, // Cache bust
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Cache-Control': 'no-cache'
                        },
                        mode: 'cors' // Explicitamente definir modo CORS
                    }
                );
                
                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                    console.log(`‚úÖ SHA obtido com sucesso: ${sha.substring(0, 8)}...`);
                } else {
                    const errorText = await getResponse.text();
                    console.warn(`‚ö†Ô∏è Erro HTTP ${getResponse.status} ao buscar SHA:`, errorText);
                    
                    // Se n√£o conseguir buscar SHA e for tentativa < 3, tentar novamente
                    if (tentativa < 3) {
                        console.log(`üîÑ Tentando novamente buscar SHA (tentativa ${tentativa + 1})...`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return await salvarProdutosNoGitHubSilencioso(tentativa + 1);
                    }
                    
                    throw new Error(`N√£o foi poss√≠vel obter SHA do arquivo ap√≥s ${tentativa} tentativas`);
                }
            } catch (e) {
                console.error('‚ùå ERRO CR√çTICO ao buscar SHA:', e.message);
                
                // Se falhar ao buscar SHA e for tentativa < 3, tentar novamente
                if (tentativa < 3) {
                    console.log(`üîÑ Tentando novamente buscar SHA (tentativa ${tentativa + 1})...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return await salvarProdutosNoGitHubSilencioso(tentativa + 1);
                }
                
                // Se falhar ap√≥s 3 tentativas, abortar
                throw new Error(`N√£o foi poss√≠vel buscar SHA: ${e.message}. Verifique: 1) Token GitHub v√°lido, 2) Permiss√µes CORS, 3) Conex√£o de rede`);
            }
            
            // 2. VALIDA√á√ÉO: SHA √© OBRIGAT√ìRIO para atualizar arquivo existente
            if (!sha) {
                console.error('‚ùå SHA n√£o foi obtido. Imposs√≠vel atualizar arquivo no GitHub.');
                throw new Error('SHA n√£o dispon√≠vel. N√£o √© poss√≠vel atualizar o arquivo.');
            }
            
            // 3. Criar/atualizar arquivo COM SHA
            console.log('üì§ Enviando arquivo para GitHub com SHA:', sha.substring(0, 8) + '...');
            const content = btoa(unescape(encodeURIComponent(conteudo)));
            
            const putResponse = await fetch(
                `https://api.github.com/repos/${owner}/${repo}/contents/${path}`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        message: `[Auto-Sync] Atualizar produtos (${allProducts.length}) - ${new Date().toLocaleString('pt-BR')}`,
                        content: content,
                        branch: branch,
                        sha: sha // SHA agora √© OBRIGAT√ìRIO (n√£o mais opcional)
                    })
                }
            );
            
            if (!putResponse.ok) {
                const error = await putResponse.json();
                
                // Se for erro de SHA mismatch (arquivo mudou durante a opera√ß√£o)
                if (error.message && error.message.includes('does not match') && tentativa < 3) {
                    console.warn(`‚ö†Ô∏è SHA mismatch detectado! Arquivo foi modificado durante a opera√ß√£o.`);
                    console.log(`üîÑ Tentando novamente com SHA atualizado (tentativa ${tentativa + 1})...`);
                    
                    // Aguardar 1 segundo antes de tentar novamente
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Tentar novamente (recursivo) - vai buscar SHA novo
                    return await salvarProdutosNoGitHubSilencioso(tentativa + 1);
                }
                
                // Outros erros
                console.error('‚ùå Erro ao salvar no GitHub:', error);
                throw new Error(error.message || 'Erro ao salvar no GitHub');
            }
            
            const result = await putResponse.json();
            console.log(`‚úÖ Arquivo salvo com sucesso no GitHub!`);
            console.log(`   üìù SHA antigo: ${sha.substring(0, 8)}...`);
            console.log(`   üìù SHA novo: ${result.content.sha.substring(0, 8)}...`);
            return result;
        }
        
        /**
         * Abrir modal com op√ß√µes de salvamento
         */
        function abrirModalSalvarProdutos() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content max-w-2xl mx-4">
                    <div class="p-8">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">
                                    <i class="fas fa-save mr-2"></i>
                                    Salvar Produtos no Arquivo
                                </h2>
                                <p class="text-gray-600 mt-2">
                                    Atualizar produtos-v6.1.js com todos os dados atuais
                                </p>
                            </div>
                            <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <p class="text-sm text-blue-800">
                                <strong>üí° Por que salvar no arquivo?</strong><br>
                                ‚Ä¢ Pre√ßos e dados ficam permanentes<br>
                                ‚Ä¢ Funciona ap√≥s deploy (site publicado)<br>
                                ‚Ä¢ Backup dos dados atualizados<br>
                                ‚Ä¢ Sincroniza√ß√£o entre admin e cat√°logo
                            </p>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- Op√ß√£o 1: GitHub API -->
                            <div class="border-2 ${githubConfig && githubConfig.token ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'} rounded-lg p-6 hover:shadow-lg transition-all cursor-pointer"
                                 onclick="this.closest('.modal').remove(); salvarProdutosNoGitHub();">
                                <div class="flex items-start">
                                    <div class="text-4xl mr-4">
                                        <i class="fab fa-github ${githubConfig && githubConfig.token ? 'text-green-600' : 'text-gray-400'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-bold text-gray-800 mb-2">
                                            GitHub API (Recomendado)
                                            ${githubConfig && githubConfig.token ? '<span class="text-green-600 text-sm ml-2">‚úì Configurado</span>' : ''}
                                        </h3>
                                        <p class="text-sm text-gray-600 mb-3">
                                            Salva diretamente no reposit√≥rio via API. Atualiza√ß√£o autom√°tica no site ap√≥s 2-3 minutos.
                                        </p>
                                        <div class="text-xs space-y-1">
                                            <div class="flex items-center text-green-600">
                                                <i class="fas fa-check mr-2"></i>
                                                <span>Mais r√°pido e autom√°tico</span>
                                            </div>
                                            <div class="flex items-center text-green-600">
                                                <i class="fas fa-check mr-2"></i>
                                                <span>Atualiza site automaticamente</span>
                                            </div>
                                            <div class="flex items-center text-green-600">
                                                <i class="fas fa-check mr-2"></i>
                                                <span>Sem necessidade de upload manual</span>
                                            </div>
                                        </div>
                                        ${!githubConfig || !githubConfig.token ? `
                                        <div class="mt-3 text-xs text-orange-600">
                                            ‚ö†Ô∏è Configure GitHub API primeiro em: Persist√™ncia ‚Üí GitHub API
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Op√ß√£o 2: Download -->
                            <div class="border-2 border-gray-200 bg-white rounded-lg p-6 hover:shadow-lg transition-all cursor-pointer"
                                 onclick="this.closest('.modal').remove(); baixarArquivoProdutosAtualizado();">
                                <div class="flex items-start">
                                    <div class="text-4xl mr-4">
                                        <i class="fas fa-download text-blue-600"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-bold text-gray-800 mb-2">
                                            Download Manual
                                        </h3>
                                        <p class="text-sm text-gray-600 mb-3">
                                            Baixa o arquivo e voc√™ faz upload manual no GitHub ou servidor.
                                        </p>
                                        <div class="text-xs space-y-1">
                                            <div class="flex items-center text-blue-600">
                                                <i class="fas fa-check mr-2"></i>
                                                <span>Controle total do processo</span>
                                            </div>
                                            <div class="flex items-center text-blue-600">
                                                <i class="fas fa-check mr-2"></i>
                                                <span>Backup local garantido</span>
                                            </div>
                                            <div class="flex items-center text-orange-600">
                                                <i class="fas fa-exclamation mr-2"></i>
                                                <span>Requer upload manual depois</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <p class="text-sm text-gray-600">
                                <strong>üìä Estat√≠sticas atuais:</strong><br>
                                ‚Ä¢ <strong>${allProducts.length}</strong> produtos no total<br>
                                ‚Ä¢ <strong>${allProducts.filter(p => p.precoConcorrente).length}</strong> produtos com pre√ßo concorrente<br>
                                ‚Ä¢ √öltima atualiza√ß√£o: ${new Date().toLocaleString('pt-BR')}
                            </p>
                        </div>
                        
                        <div class="mt-6 flex gap-3">
                            <button onclick="this.closest('.modal').remove()" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                                <i class="fas fa-times mr-2"></i>Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ============================================
        // EXPOR FUN√á√ïES DE FERRAMENTAS PARA ESCOPO GLOBAL
        // ============================================
        window.exportarTemplate = exportarTemplate;
        window.abrirImportador = abrirImportador;
        window.importarCatalogo = importarCatalogo;
        window.abrirImportadorAvancado = abrirImportadorAvancado;
        window.corrigirLinks = corrigirLinks;
        window.atualizarImagens = atualizarImagens;
        window.verificarAcessoFerramenta = verificarAcessoFerramenta;
        window.mostrarInstrucaoFerramenta = mostrarInstrucaoFerramenta;
        window.copiarInstrucao = copiarInstrucao;
        window.fecharInstrucao = fecharInstrucao;
        window.exportarCSV = exportarCSV;
        window.openCrudModal = openCrudModal;
        window.closeCrudModal = closeCrudModal;
        window.abrirImportadorExcel = abrirImportadorExcel;
        window.processarArquivoCSV = processarArquivoCSV;
        window.mostrarPreviewImportacao = mostrarPreviewImportacao;
        window.executarImportacao = executarImportacao;
        window.cancelarImportacao = cancelarImportacao;
        window.finalizarImportacao = finalizarImportacao;
        window.ativarPersistencia = ativarPersistencia;
        window.atualizarStatusPersistencia = atualizarStatusPersistencia;
        window.verificarEspacoStorage = verificarEspacoStorage;
        window.abrirConfigGitHub = abrirConfigGitHub;
        window.deletarProduto = deletarProduto;
        window.duplicarProduto = duplicarProduto;
        window.excluirProduto = excluirProduto;
        window.showProductModal = showProductModal;
        window.closeModal = closeModal;
        window.openMargemEditor = openMargemEditor;
        window.closeMargemModal = closeMargemModal;
        window.updateMargemPreview = updateMargemPreview;
        window.updateMargemFromInput = updateMargemFromInput;
        window.setMargem = setMargem;
        window.salvarMargem = salvarMargem;
        window.calcularPrecoVenda = calcularPrecoVenda;
        window.previewImage = previewImage;
        window.addEspecificacao = addEspecificacao;
        window.switchTab = switchTab;
        window.buscarNovosCupons = buscarNovosCupons;
        window.copiarCodigo = copiarCodigo;
        window.filterComparativo = filterComparativo;
        window.mostrarAlternativas = mostrarAlternativas;
        window.salvarConfiguracoesAdmin = salvarConfiguracoesAdmin;
        window.carregarConfiguracoesAdmin = carregarConfiguracoesAdmin;
        window.gerarArquivoProdutosJS = gerarArquivoProdutosJS;
        window.baixarArquivoProdutosAtualizado = baixarArquivoProdutosAtualizado;
        window.salvarProdutosNoGitHub = salvarProdutosNoGitHub;
        window.abrirModalSalvarProdutos = abrirModalSalvarProdutos;
        window.ativarAutoSync = ativarAutoSync;
        window.desativarAutoSync = desativarAutoSync;
        window.toggleAutoSync = toggleAutoSync;
        window.verificarAutoSync = verificarAutoSync;
        window.dispararAutoSync = dispararAutoSync;

        // ========================================
        // NOVO: HIST√ìRICO DE ATUALIZA√á√ïES v6.6
        // ========================================
        
        /**
         * Registrar atualiza√ß√£o de produto no hist√≥rico
         */
        function registrarAtualizacaoProduto(produtoId, produtoNome, acao = 'editado') {
            const updateHistory = JSON.parse(localStorage.getItem('productUpdateHistory') || '[]');
            
            // Criar registro com timezone de Curitiba (UTC-3)
            const now = new Date();
            const curitibaTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
            
            const registro = {
                id: Date.now(),
                produtoId: produtoId,
                produtoNome: produtoNome,
                acao: acao,
                timestamp: curitibaTime.getTime(),
                dataFormatada: formatarDataCuritiba(curitibaTime)
            };
            
            // Adicionar no in√≠cio do array (mais recente primeiro)
            updateHistory.unshift(registro);
            
            // Manter apenas os √∫ltimos 50 registros
            if (updateHistory.length > 50) {
                updateHistory.splice(50);
            }
            
            localStorage.setItem('productUpdateHistory', JSON.stringify(updateHistory));
            
            // Atualizar interface se estiver vis√≠vel
            if (document.getElementById('updateHistoryList')) {
                carregarHistoricoAtualizacoes();
            }
        }
        
        /**
         * Formatar data para timezone de Curitiba
         */
        function formatarDataCuritiba(date) {
            const d = new Date(date);
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            const ano = d.getFullYear();
            const hora = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            const seg = String(d.getSeconds()).padStart(2, '0');
            
            return `${dia}/${mes}/${ano} ${hora}:${min}:${seg}`;
        }
        
        /**
         * Carregar e exibir hist√≥rico de atualiza√ß√µes
         */
        function carregarHistoricoAtualizacoes() {
            const updateHistory = JSON.parse(localStorage.getItem('productUpdateHistory') || '[]');
            const listElement = document.getElementById('updateHistoryList');
            const countElement = document.getElementById('updateHistoryCount');
            
            if (!listElement) return;
            
            // Atualizar contador
            if (countElement) {
                countElement.textContent = updateHistory.length;
            }
            
            if (updateHistory.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>Nenhuma atualiza√ß√£o registrada ainda</p>
                    </div>
                `;
                return;
            }
            
            // Obter produtos atuais para verificar visibilidade
            const produtosAtuais = getProdutosAtualizados();
            const idsAtuais = new Set(produtosAtuais.map(p => p.id));
            
            // Renderizar hist√≥rico
            listElement.innerHTML = updateHistory.map(registro => {
                const iconClass = registro.acao === 'criado' ? 'fa-plus text-green-500' : 
                                  registro.acao === 'editado' ? 'fa-edit text-blue-500' :
                                  registro.acao === 'duplicado' ? 'fa-copy text-purple-500' :
                                  'fa-pencil text-gray-500';
                
                // Verificar se produto ainda existe
                const produtoExiste = idsAtuais.has(registro.produtoId);
                const statusBadge = produtoExiste ? 
                    '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-green-100 text-green-800" title="Produto vis√≠vel">' +
                        '<i class="fas fa-check-circle mr-1"></i>Vis√≠vel' +
                    '</span>' :
                    '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-red-100 text-red-800" title="Produto n√£o encontrado">' +
                        '<i class="fas fa-exclamation-triangle mr-1"></i>Removido' +
                    '</span>';
                
                return `
                    <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <i class="fas ${iconClass} mt-1"></i>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="font-semibold text-gray-800 truncate">${registro.produtoNome}</div>
                                ${statusBadge}
                            </div>
                            <div class="text-xs text-gray-500">ID: ${registro.produtoId} ‚Ä¢ ${registro.acao}</div>
                        </div>
                        <div class="text-xs text-gray-400 whitespace-nowrap">
                            ${registro.dataFormatada}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        /**
         * Toggle do painel de hist√≥rico
         */
        function toggleUpdateHistory() {
            const content = document.getElementById('updateHistoryContent');
            const icon = document.getElementById('updateHistoryToggleIcon');
            
            if (!content || !icon) return;
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
                carregarHistoricoAtualizacoes();
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        /**
         * Limpar hist√≥rico de atualiza√ß√µes
         */
        function clearUpdateHistory() {
            if (confirm('Tem certeza que deseja limpar todo o hist√≥rico de atualiza√ß√µes?')) {
                localStorage.removeItem('productUpdateHistory');
                carregarHistoricoAtualizacoes();
                mostrarNotificacao('‚úÖ Hist√≥rico limpo com sucesso!', 'success');
            }
        }
        
        /**
         * Re-sincronizar hist√≥rico com produtos atuais
         * Verifica se todos os produtos no hist√≥rico ainda existem e est√£o vis√≠veis
         */
        function resyncUpdateHistory() {
            const updateHistory = JSON.parse(localStorage.getItem('productUpdateHistory') || '[]');
            
            if (updateHistory.length === 0) {
                mostrarNotificacao('‚ÑπÔ∏è Hist√≥rico vazio, nada para re-sincronizar', 'info');
                return;
            }
            
            // Obter produtos atuais
            const produtosAtuais = getProdutosAtualizados();
            const idsAtuais = new Set(produtosAtuais.map(p => p.id));
            
            // Verificar produtos que n√£o existem mais
            let produtosFaltantes = [];
            let produtosOk = [];
            
            updateHistory.forEach(registro => {
                if (!idsAtuais.has(registro.produtoId)) {
                    produtosFaltantes.push(registro);
                } else {
                    produtosOk.push(registro);
                }
            });
            
            if (produtosFaltantes.length === 0) {
                mostrarNotificacao('‚úÖ Todos os produtos do hist√≥rico est√£o presentes!', 'success');
                return;
            }
            
            // Abrir modal de sele√ß√£o
            mostrarModalSelecaoProdutos(produtosFaltantes, produtosOk);
        }
        
        /**
         * Modal de sele√ß√£o de produtos obsoletos
         * Permite escolher quais remover ou re-inserir
         */
        function mostrarModalSelecaoProdutos(produtosFaltantes, produtosOk) {
            // Criar modal
            const modalHtml = `
                <div id="modalSelecaoProdutos" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-2xl font-bold mb-2">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        Produtos Obsoletos Encontrados
                                    </h2>
                                    <p class="text-orange-100">
                                        ${produtosFaltantes.length} produto(s) no hist√≥rico n√£o existem mais no sistema
                                    </p>
                                </div>
                                <button onclick="fecharModalSelecaoProdutos()" class="text-white hover:text-gray-200 text-2xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- A√ß√µes principais -->
                        <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-2 justify-between items-center">
                            <div class="flex gap-2">
                                <button onclick="selecionarTodosProdutosObsoletos(true)" 
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm font-semibold">
                                    <i class="fas fa-check-square mr-1"></i>Selecionar Todos
                                </button>
                                <button onclick="selecionarTodosProdutosObsoletos(false)" 
                                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm font-semibold">
                                    <i class="fas fa-square mr-1"></i>Desmarcar Todos
                                </button>
                            </div>
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-info-circle mr-1"></i>
                                Selecione os produtos que deseja gerenciar
                            </div>
                        </div>
                        
                        <!-- Lista de produtos -->
                        <div class="flex-1 overflow-y-auto p-6">
                            <div id="listaProdutosObsoletos" class="space-y-3">
                                ${produtosFaltantes.map((produto, index) => `
                                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-orange-300 transition">
                                        <div class="flex items-start gap-4">
                                            <input type="checkbox" 
                                                   id="produto-${index}" 
                                                   class="produto-obsoleto-checkbox mt-1 w-5 h-5 text-orange-500 rounded focus:ring-orange-500"
                                                   data-index="${index}">
                                            <div class="flex-1">
                                                <div class="flex items-start justify-between gap-4">
                                                    <div class="flex-1">
                                                        <h3 class="font-bold text-gray-800 text-lg">${produto.produtoNome}</h3>
                                                        <div class="text-sm text-gray-600 mt-1">
                                                            <span class="inline-block mr-3">
                                                                <i class="fas fa-hashtag mr-1"></i>ID: ${produto.produtoId}
                                                            </span>
                                                            <span class="inline-block mr-3">
                                                                <i class="fas fa-calendar mr-1"></i>${produto.dataFormatada}
                                                            </span>
                                                            <span class="inline-block px-2 py-1 rounded text-xs font-semibold ${
                                                                produto.acao === 'criado' ? 'bg-green-100 text-green-700' :
                                                                produto.acao === 'editado' ? 'bg-blue-100 text-blue-700' :
                                                                'bg-purple-100 text-purple-700'
                                                            }">
                                                                ${produto.acao}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="text-right">
                                                        <span class="inline-block px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold">
                                                            <i class="fas fa-exclamation-circle mr-1"></i>Removido
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Footer com a√ß√µes -->
                        <div class="p-6 bg-gray-50 border-t">
                            <div class="flex flex-wrap gap-3 justify-end">
                                <button onclick="fecharModalSelecaoProdutos()" 
                                        class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                                    <i class="fas fa-times mr-2"></i>Cancelar
                                </button>
                                <button onclick="removerProdutosSelecionados()" 
                                        class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold">
                                    <i class="fas fa-trash mr-2"></i>Remover Selecionados
                                </button>
                                <button onclick="reinserirProdutosSelecionados()" 
                                        class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-semibold">
                                    <i class="fas fa-redo mr-2"></i>Re-inserir Selecionados
                                </button>
                            </div>
                            <div class="mt-3 text-sm text-gray-600 text-center">
                                <i class="fas fa-lightbulb mr-1"></i>
                                <strong>Dica:</strong> Re-inserir ir√° criar novamente os produtos no sistema com status "sugerido"
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao body
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer.firstElementChild);
            
            // Salvar dados no window para acesso posterior
            window.produtosFaltantesData = produtosFaltantes;
            window.produtosOkData = produtosOk;
        }
        
        /**
         * Fechar modal de sele√ß√£o
         */
        function fecharModalSelecaoProdutos() {
            const modal = document.getElementById('modalSelecaoProdutos');
            if (modal) {
                modal.remove();
            }
            delete window.produtosFaltantesData;
            delete window.produtosOkData;
        }
        
        /**
         * Selecionar/desmarcar todos os produtos
         */
        function selecionarTodosProdutosObsoletos(selecionar) {
            const checkboxes = document.querySelectorAll('.produto-obsoleto-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selecionar;
            });
        }
        
        /**
         * Remover produtos selecionados do hist√≥rico
         */
        function removerProdutosSelecionados() {
            const checkboxes = document.querySelectorAll('.produto-obsoleto-checkbox:checked');
            
            if (checkboxes.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è Selecione pelo menos um produto para remover', 'warning');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja remover ${checkboxes.length} produto(s) do hist√≥rico?`)) {
                return;
            }
            
            // Obter √≠ndices selecionados
            const indicesSelecionados = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
            
            // Filtrar produtos faltantes removendo os selecionados
            const produtosFaltantes = window.produtosFaltantesData.filter((_, index) => 
                !indicesSelecionados.includes(index)
            );
            
            // Reconstruir hist√≥rico
            const novoHistorico = [...window.produtosOkData, ...produtosFaltantes];
            
            // Salvar
            localStorage.setItem('productUpdateHistory', JSON.stringify(novoHistorico));
            
            // Atualizar interface
            fecharModalSelecaoProdutos();
            carregarHistoricoAtualizacoes();
            mostrarNotificacao(`‚úÖ ${checkboxes.length} produto(s) removido(s) do hist√≥rico`, 'success');
        }
        
        /**
         * Re-inserir produtos selecionados no sistema
         */
        function reinserirProdutosSelecionados() {
            const checkboxes = document.querySelectorAll('.produto-obsoleto-checkbox:checked');
            
            if (checkboxes.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è Selecione pelo menos um produto para re-inserir', 'warning');
                return;
            }
            
            if (!confirm(`Deseja re-inserir ${checkboxes.length} produto(s) no sistema?\n\nOs produtos ser√£o criados com status "sugerido" e voc√™ precisar√° configur√°-los manualmente.`)) {
                return;
            }
            
            // Obter √≠ndices selecionados
            const indicesSelecionados = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
            
            let produtosReinseridos = 0;
            let erros = 0;
            
            // Re-inserir cada produto selecionado
            indicesSelecionados.forEach(index => {
                const registro = window.produtosFaltantesData[index];
                
                // Criar produto b√°sico (usu√°rio precisar√° configurar)
                const novoProduto = {
                    sku: `REINSERIDO-${registro.produtoId}`,
                    nome: registro.produtoNome,
                    categoria: 'Eletr√¥nicos',
                    subcategoria: 'Diversos',
                    fornecedor: 'A configurar',
                    quantidade: 0,
                    custoBase: 0,
                    precoMercado: 0,
                    margem: 30,
                    imagem: '',
                    descricao: `Produto re-inserido do hist√≥rico. Configure os detalhes.`,
                    badge: 'üîÑ REINSERIDO',
                    status: 'sugerido'
                };
                
                const resultado = window.produtoCRUD.criarProduto(novoProduto, 'sugerido');
                
                if (resultado.sucesso) {
                    produtosReinseridos++;
                    registrarAtualizacaoProduto(resultado.produto.id, registro.produtoNome, 'reinserido');
                } else {
                    erros++;
                }
            });
            
            // Remover do hist√≥rico de produtos faltantes
            const produtosFaltantes = window.produtosFaltantesData.filter((_, index) => 
                !indicesSelecionados.includes(index)
            );
            
            // Reconstruir hist√≥rico
            const novoHistorico = [...window.produtosOkData, ...produtosFaltantes];
            localStorage.setItem('productUpdateHistory', JSON.stringify(novoHistorico));
            
            // Atualizar interface
            fecharModalSelecaoProdutos();
            atualizarInterfaceCompleta();
            
            if (erros === 0) {
                mostrarNotificacao(`‚úÖ ${produtosReinseridos} produto(s) re-inserido(s) com sucesso!`, 'success');
            } else {
                mostrarNotificacao(`‚ö†Ô∏è ${produtosReinseridos} produto(s) re-inserido(s), ${erros} erro(s)`, 'warning');
            }
        }
        
        /**
         * Buscar e exibir √∫ltimo commit do GitHub
         */
        async function carregarUltimoCommit() {
            const infoElement = document.getElementById('lastCommitInfo');
            if (!infoElement) {
                console.log('‚ùå Elemento lastCommitInfo n√£o encontrado');
                return;
            }
            
            console.log('üîç Verificando configura√ß√£o do GitHub...');
            console.log('githubConfig:', githubConfig);
            
            // Tentar usar API p√∫blica se n√£o tiver token configurado
            let usePublicAPI = false;
            let owner = 'genautech';
            let repo = 'priobf25';
            let branch = 'main';
            let token = null;
            
            if (!githubConfig || !githubConfig.token) {
                console.log('‚ö†Ô∏è GitHub n√£o configurado, usando API p√∫blica');
                usePublicAPI = true;
            } else {
                ({ token, owner, repo, branch } = githubConfig);
            }
            
            try {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }
                
                console.log('üì° Buscando √∫ltimo commit de:', `${owner}/${repo}/${branch}`);
                
                const response = await fetch(
                    `https://api.github.com/repos/${owner}/${repo}/commits/${branch}`,
                    { headers }
                );
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar commit');
                }
                
                const commit = await response.json();
                
                console.log('‚úÖ Commit recebido:', commit.sha.substring(0, 8));
                console.log('üìÖ Data do commit:', commit.commit.author.date);
                
                // Converter para timezone de Curitiba
                const commitDate = new Date(commit.commit.author.date);
                const curitibaDate = new Date(commitDate.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
                const dataFormatada = formatarDataCuritiba(curitibaDate);
                
                console.log('üïê Data formatada (Curitiba):', dataFormatada);
                
                infoElement.innerHTML = `
                    <span class="text-green-600 font-semibold">√öltimo commit: ${dataFormatada}</span>
                `;
                
                console.log('‚úÖ √öltimo commit exibido com sucesso!');
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar √∫ltimo commit:', error);
                infoElement.innerHTML = '<span class="text-red-500">Erro ao verificar commit</span>';
            }
        }
        
        /**
         * ========================================
         * NOVA FUNCIONALIDADE v6.9: RE-SINCRONIZA√á√ÉO DE PRE√áOS
         * ========================================
         */
        
        /**
         * Abrir modal de re-sincroniza√ß√£o de pre√ßos
         */
        function abrirResincronizadorPrecos() {
            const produtos = getProdutosAtualizados();
            
            // Filtrar produtos que t√™m links cadastrados
            const produtosComLink = produtos.filter(p => p.linkCompra && p.linkCompra !== '#' && p.linkCompra.startsWith('http'));
            
            if (produtosComLink.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è Nenhum produto com link cadastrado encontrado', 'warning');
                return;
            }
            
            // Criar modal
            const modalHtml = `
                <div id="modalResincronizadorPrecos" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white p-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-2xl font-bold mb-2">
                                        <i class="fas fa-sync-alt mr-2"></i>
                                        Re-sincroniza√ß√£o de Pre√ßos
                                    </h2>
                                    <p class="text-emerald-100">
                                        ${produtosComLink.length} produto(s) com link cadastrado dispon√≠vel para atualiza√ß√£o
                                    </p>
                                </div>
                                <button onclick="fecharResincronizadorPrecos()" class="text-white hover:text-gray-200 text-2xl">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Instru√ß√µes -->
                        <div class="p-4 bg-blue-50 border-b">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-blue-600 text-xl mt-1"></i>
                                <div class="flex-1 text-sm text-gray-700">
                                    <strong>Como usar:</strong>
                                    <ol class="list-decimal ml-4 mt-2 space-y-1">
                                        <li>Selecione os produtos que deseja atualizar</li>
                                        <li>Clique em "Abrir Link" para visitar a p√°gina do fornecedor</li>
                                        <li>Digite o novo pre√ßo no campo correspondente</li>
                                        <li>Clique em "Aplicar Atualiza√ß√µes" para salvar todos os pre√ßos de uma vez</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <!-- A√ß√µes principais -->
                        <div class="p-4 bg-gray-50 border-b flex flex-wrap gap-2 justify-between items-center">
                            <div class="flex gap-2">
                                <button onclick="selecionarTodosProdutosPrecos(true)" 
                                        class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition text-sm font-semibold">
                                    <i class="fas fa-check-square mr-1"></i>Selecionar Todos
                                </button>
                                <button onclick="selecionarTodosProdutosPrecos(false)" 
                                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm font-semibold">
                                    <i class="fas fa-square mr-1"></i>Desmarcar Todos
                                </button>
                            </div>
                            <div class="text-sm">
                                <span id="contadorSelecionadosPrecos" class="font-semibold text-emerald-600">0 selecionados</span>
                            </div>
                        </div>
                        
                        <!-- Lista de produtos -->
                        <div class="flex-1 overflow-y-auto p-6">
                            <div id="listaProdutosPrecos" class="space-y-4">
                                ${produtosComLink.map((produto, index) => `
                                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-emerald-300 transition bg-white">
                                        <div class="flex items-start gap-4">
                                            <input type="checkbox" 
                                                   id="preco-produto-${index}" 
                                                   class="produto-preco-checkbox mt-1 w-5 h-5 text-emerald-500 rounded focus:ring-emerald-500"
                                                   data-index="${index}"
                                                   onchange="atualizarContadorSelecionados()">
                                            <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                <div>
                                                    <h3 class="font-bold text-gray-800 text-lg mb-2">${produto.nome}</h3>
                                                    <div class="space-y-1 text-sm text-gray-600">
                                                        <div class="flex items-center gap-2">
                                                            <i class="fas fa-hashtag w-4"></i>
                                                            <span>ID: ${produto.id}</span>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <i class="fas fa-tag w-4"></i>
                                                            <span>SKU: ${produto.sku}</span>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <i class="fas fa-dollar-sign w-4"></i>
                                                            <span>Pre√ßo Atual: <strong class="text-emerald-600">R$ ${produto.precoVenda.toFixed(2)}</strong></span>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <i class="fas fa-chart-line w-4"></i>
                                                            <span>Custo Base: R$ ${produto.custoBase.toFixed(2)}</span>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            <i class="fas fa-store w-4"></i>
                                                            <span>${produto.fornecedor}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex flex-col gap-2">
                                                    <div>
                                                        <label class="block text-xs font-semibold text-gray-600 mb-1">
                                                            Novo Custo Base (R$)
                                                        </label>
                                                        <input type="number" 
                                                               id="novoCustoBase-${index}"
                                                               step="0.01" 
                                                               min="0"
                                                               placeholder="${produto.custoBase.toFixed(2)}"
                                                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-semibold text-gray-600 mb-1">
                                                            Novo Pre√ßo Mercado (R$)
                                                        </label>
                                                        <input type="number" 
                                                               id="novoPrecoMercado-${index}"
                                                               step="0.01" 
                                                               min="0"
                                                               placeholder="${produto.precoMercado.toFixed(2)}"
                                                               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 text-sm">
                                                    </div>
                                                    <a href="${produto.linkCompra}" 
                                                       target="_blank" 
                                                       class="inline-flex items-center justify-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm font-semibold">
                                                        <i class="fas fa-external-link-alt"></i>
                                                        Abrir Link do Fornecedor
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Footer com a√ß√µes -->
                        <div class="p-6 bg-gray-50 border-t">
                            <div class="flex flex-wrap gap-3 justify-end">
                                <button onclick="fecharResincronizadorPrecos()" 
                                        class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                                    <i class="fas fa-times mr-2"></i>Cancelar
                                </button>
                                <button onclick="aplicarAtualizacoesPrecos()" 
                                        class="px-6 py-3 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition font-semibold">
                                    <i class="fas fa-check mr-2"></i>Aplicar Atualiza√ß√µes
                                </button>
                            </div>
                            <div class="mt-3 text-sm text-gray-600 text-center">
                                <i class="fas fa-lightbulb mr-1"></i>
                                <strong>Dica:</strong> Apenas produtos selecionados com novos valores ser√£o atualizados
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar modal ao body
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer.firstElementChild);
            
            // Salvar dados no window para acesso posterior
            window.produtosComLinkData = produtosComLink;
        }
        
        /**
         * Fechar modal de re-sincroniza√ß√£o
         */
        function fecharResincronizadorPrecos() {
            const modal = document.getElementById('modalResincronizadorPrecos');
            if (modal) {
                modal.remove();
            }
            delete window.produtosComLinkData;
        }
        
        /**
         * Selecionar/desmarcar todos os produtos para pre√ßos
         */
        function selecionarTodosProdutosPrecos(selecionar) {
            const checkboxes = document.querySelectorAll('.produto-preco-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selecionar;
            });
            atualizarContadorSelecionados();
        }
        
        /**
         * Atualizar contador de produtos selecionados
         */
        function atualizarContadorSelecionados() {
            const checkboxes = document.querySelectorAll('.produto-preco-checkbox:checked');
            const contador = document.getElementById('contadorSelecionadosPrecos');
            if (contador) {
                contador.textContent = `${checkboxes.length} selecionado${checkboxes.length !== 1 ? 's' : ''}`;
            }
        }
        
        /**
         * Aplicar atualiza√ß√µes de pre√ßos
         */
        function aplicarAtualizacoesPrecos() {
            const checkboxes = document.querySelectorAll('.produto-preco-checkbox:checked');
            
            if (checkboxes.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è Selecione pelo menos um produto para atualizar', 'warning');
                return;
            }
            
            let atualizacoes = [];
            let semAlteracao = 0;
            
            // Coletar atualiza√ß√µes
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                const produto = window.produtosComLinkData[index];
                
                const novoCustoBase = document.getElementById(`novoCustoBase-${index}`).value;
                const novoPrecoMercado = document.getElementById(`novoPrecoMercado-${index}`).value;
                
                if (novoCustoBase || novoPrecoMercado) {
                    atualizacoes.push({
                        produto: produto,
                        novoCustoBase: novoCustoBase ? parseFloat(novoCustoBase) : null,
                        novoPrecoMercado: novoPrecoMercado ? parseFloat(novoPrecoMercado) : null
                    });
                } else {
                    semAlteracao++;
                }
            });
            
            if (atualizacoes.length === 0) {
                mostrarNotificacao('‚ö†Ô∏è Nenhum novo valor foi informado nos produtos selecionados', 'warning');
                return;
            }
            
            const mensagemConfirmacao = `
                Confirmar atualiza√ß√£o de ${atualizacoes.length} produto(s)?
                ${semAlteracao > 0 ? `\n\n(${semAlteracao} produto(s) selecionado(s) sem novos valores ser√£o ignorados)` : ''}
            `;
            
            if (!confirm(mensagemConfirmacao)) {
                return;
            }
            
            // Aplicar atualiza√ß√µes
            let sucessos = 0;
            let erros = 0;
            
            atualizacoes.forEach(atualizacao => {
                try {
                    console.log('üîÑ Atualizando produto:', atualizacao.produto.nome, 'ID:', atualizacao.produto.id);
                    
                    const dadosAtualizacao = {};
                    
                    // Obter dados atuais do produto
                    const produtoAtual = window.produtoCRUD.obterProduto(atualizacao.produto.id);
                    
                    if (!produtoAtual) {
                        console.error('‚ùå Produto n√£o encontrado:', atualizacao.produto.id);
                        erros++;
                        return;
                    }
                    
                    // Preparar dados para atualiza√ß√£o
                    if (atualizacao.novoCustoBase !== null) {
                        dadosAtualizacao.custoBase = atualizacao.novoCustoBase;
                        console.log('  ‚Üí Novo Custo Base:', atualizacao.novoCustoBase);
                    }
                    
                    if (atualizacao.novoPrecoMercado !== null) {
                        dadosAtualizacao.precoMercado = atualizacao.novoPrecoMercado;
                        console.log('  ‚Üí Novo Pre√ßo Mercado:', atualizacao.novoPrecoMercado);
                    }
                    
                    // Atualizar produto via CRUD
                    console.log('  ‚Üí Chamando atualizarProduto com:', dadosAtualizacao);
                    const resultado = window.produtoCRUD.atualizarProduto(atualizacao.produto.id, dadosAtualizacao);
                    
                    if (resultado && resultado.sucesso) {
                        console.log('  ‚úÖ Produto atualizado com sucesso!');
                        sucessos++;
                        registrarAtualizacaoProduto(atualizacao.produto.id, atualizacao.produto.nome, 'pre√ßos atualizados');
                    } else {
                        console.error('  ‚ùå Erro ao atualizar:', resultado);
                        erros++;
                    }
                } catch (error) {
                    console.error('‚ùå Exce√ß√£o ao atualizar produto:', error);
                    erros++;
                }
            });
            
            // Fechar modal
            fecharResincronizadorPrecos();
            
            // Log final
            console.log('üìä Resultado final:');
            console.log(`  ‚úÖ Sucessos: ${sucessos}`);
            console.log(`  ‚ùå Erros: ${erros}`);
            
            // Atualizar interface completa
            console.log('üîÑ Atualizando interface completa...');
            atualizarInterfaceCompleta();
            
            // Tentar salvar no GitHub se auto-sync estiver ativo
            if (window.autoSyncAtivo) {
                console.log('üíæ Tentando salvar no GitHub...');
                try {
                    window.salvarProdutosNoGitHub();
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erro ao salvar no GitHub:', e);
                }
            }
            
            // Notificar resultado
            if (erros === 0) {
                mostrarNotificacao(`‚úÖ ${sucessos} produto(s) atualizado(s) com sucesso!`, 'success');
            } else {
                mostrarNotificacao(`‚ö†Ô∏è ${sucessos} produto(s) atualizado(s), ${erros} erro(s)`, 'warning');
            }
        }
        
        // Expor novas fun√ß√µes globalmente
        window.registrarAtualizacaoProduto = registrarAtualizacaoProduto;
        window.carregarHistoricoAtualizacoes = carregarHistoricoAtualizacoes;
        window.toggleUpdateHistory = toggleUpdateHistory;
        window.clearUpdateHistory = clearUpdateHistory;
        window.carregarUltimoCommit = carregarUltimoCommit;
        window.abrirResincronizadorPrecos = abrirResincronizadorPrecos;
        window.fecharResincronizadorPrecos = fecharResincronizadorPrecos;
        window.selecionarTodosProdutosPrecos = selecionarTodosProdutosPrecos;
        window.atualizarContadorSelecionados = atualizarContadorSelecionados;
        window.aplicarAtualizacoesPrecos = aplicarAtualizacoesPrecos;

    </script>
</body>
</html>
