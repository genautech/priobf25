<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Black Friday PRIO v6.0 - Sistema Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .badge-novo {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-inactive {
            background: white;
            color: #4a5568;
        }
        .tab-inactive:hover {
            background: #f7fafc;
        }
        .product-card {
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 2rem;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="glass-card rounded-2xl shadow-2xl p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                        <i class="fas fa-shopping-cart mr-2"></i>Admin Black Friday PRIO
                    </h1>
                    <p class="text-gray-600 mt-2">Sistema Completo v6.0 - Gest√£o Total de Produtos</p>
                </div>
                <div class="mt-4 md:mt-0 text-center md:text-right">
                    <div class="text-sm text-gray-500">Or√ßamento Total</div>
                    <div id="totalBudget" class="text-3xl font-bold text-purple-600">R$ 0</div>
                    <div class="text-sm text-gray-500 mt-1"><span id="totalProducts">0</span> produtos</div>
                </div>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="glass-card rounded-2xl shadow-2xl mb-6 p-2">
            <div class="flex flex-wrap gap-2">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button onclick="switchTab('sugestoes')" id="tab-sugestoes" class="tab-inactive flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-lightbulb mr-2"></i>Sugest√µes & Inova√ß√µes
                </button>
                <button onclick="switchTab('catalogo')" id="tab-catalogo" class="tab-inactive flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-book mr-2"></i>Cat√°logo Cliente
                </button>
                <button onclick="switchTab('analise')" id="tab-analise" class="tab-inactive flex-1 min-w-[150px] px-4 py-3 rounded-xl font-semibold transition-all">
                    <i class="fas fa-chart-pie mr-2"></i>An√°lise Avan√ßada
                </button>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="content-dashboard" class="tab-content">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="stat-card rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">Total Produtos</p>
                            <p id="stat-total" class="text-3xl font-bold mt-2">122</p>
                        </div>
                        <i class="fas fa-boxes text-4xl text-white text-opacity-50"></i>
                    </div>
                </div>
                <div class="stat-card rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">Planilha</p>
                            <p id="stat-planilha" class="text-3xl font-bold mt-2">12</p>
                        </div>
                        <i class="fas fa-file-excel text-4xl text-white text-opacity-50"></i>
                    </div>
                </div>
                <div class="stat-card rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">Sugest√µes</p>
                            <p id="stat-sugestoes" class="text-3xl font-bold mt-2">110</p>
                        </div>
                        <i class="fas fa-lightbulb text-4xl text-white text-opacity-50"></i>
                    </div>
                </div>
                <div class="stat-card rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white text-opacity-80 text-sm">Categorias</p>
                            <p id="stat-categorias" class="text-3xl font-bold mt-2">10</p>
                        </div>
                        <i class="fas fa-tags text-4xl text-white text-opacity-50"></i>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Produtos por Categoria</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Distribui√ß√£o de Pre√ßos</h3>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Products Table Dashboard -->
            <div class="glass-card rounded-xl shadow-lg p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Todos os Produtos</h3>
                    <div class="flex gap-2 mt-4 md:mt-0">
                        <input type="text" id="searchDashboard" placeholder="üîç Buscar produto..." 
                               class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        <select id="filterCategory" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">Todas Categorias</option>
                        </select>
                    </div>
                </div>
                <div id="dashboardProductsList" class="overflow-x-auto">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Sugest√µes & Inova√ß√µes Tab -->
        <div id="content-sugestoes" class="tab-content hidden">
            <div class="glass-card rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Sugest√µes & Inova√ß√µes 2025
                        </h2>
                        <p class="text-gray-600 mt-2">110 produtos selecionados nas melhores categorias de eletr√¥nicos</p>
                    </div>
                    <button onclick="openCrudModal('create')" 
                            class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-lg hover:shadow-xl transition">
                        <i class="fas fa-plus mr-2"></i>Adicionar Produto
                    </button>
                </div>
                
                <!-- Filters -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="text" id="searchSugestoes" placeholder="üîç Buscar produto..." 
                           class="flex-1 min-w-[200px] px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                    <select id="filterSubcategory" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">Todas Subcategorias</option>
                    </select>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="filterNovos" class="w-5 h-5 text-purple-600 rounded">
                        <span class="font-semibold">üî• Apenas Novos</span>
                    </label>
                </div>
            </div>

            <!-- Products Grid -->
            <div id="sugestoesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Cat√°logo Cliente Tab -->
        <div id="content-catalogo" class="tab-content hidden">
            <div class="glass-card rounded-xl shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-book text-blue-500 mr-2"></i>Cat√°logo para Cliente
                </h2>
                <p class="text-gray-600 mb-4">Visualiza√ß√£o do cat√°logo conforme o cliente ver√° - Produtos da planilha + sugest√µes selecionadas</p>
                
                <!-- Catalog Filters -->
                <div class="flex flex-wrap gap-4 mb-6">
                    <input type="text" id="searchCatalogo" placeholder="üîç Buscar produto..." 
                           class="flex-1 min-w-[200px] px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <select id="filterCatalogoCategory" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas Categorias</option>
                    </select>
                    <select id="sortCatalogo" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="nome">Nome A-Z</option>
                        <option value="preco-asc">Menor Pre√ßo</option>
                        <option value="preco-desc">Maior Pre√ßo</option>
                        <option value="margem-desc">Maior Margem</option>
                    </select>
                </div>
            </div>

            <!-- Catalog Grid -->
            <div id="catalogoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- An√°lise Avan√ßada Tab -->
        <div id="content-analise" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Top Products -->
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-trophy text-yellow-500 mr-2"></i>Top 10 Produtos por Margem
                    </h3>
                    <div id="topMargemList" class="space-y-3">
                        <!-- Will be populated -->
                    </div>
                </div>

                <!-- Stock Analysis -->
                <div class="glass-card rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-boxes text-green-500 mr-2"></i>An√°lise de Estoque
                    </h3>
                    <div id="stockAnalysis">
                        <!-- Will be populated -->
                    </div>
                </div>
            </div>

            <!-- Margem Analysis Chart -->
            <div class="glass-card rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Distribui√ß√£o de Margens</h3>
                <div class="chart-container">
                    <canvas id="margemChart"></canvas>
                </div>
            </div>

            <!-- Category Performance -->
            <div class="glass-card rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Performance por Subcategoria</h3>
                <div id="categoryPerformance" class="overflow-x-auto">
                    <!-- Will be populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Product Details -->
    <div id="productModal" class="modal">
        <div class="modal-content w-full">
            <div id="modalProductContent" class="p-8">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Modal for Margin Editor -->
    <div id="margemModal" class="modal">
        <div class="modal-content max-w-2xl mx-4">
            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-percentage text-purple-600 mr-2"></i>
                        Editor de Margem
                    </h2>
                    <button onclick="closeMargemModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div id="margemEditorContent">
                    <!-- Content will be inserted by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for CRUD (Create/Update/Delete Product) -->
    <div id="crudModal" class="modal">
        <div class="modal-content max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <h2 id="crudModalTitle" class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-box text-blue-600 mr-2"></i>
                        Adicionar Produto
                    </h2>
                    <button onclick="closeCrudModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="crudForm" class="space-y-6">
                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="bg-blue-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-info-circle mr-2"></i>Informa√ß√µes B√°sicas
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">SKU *</label>
                                <input type="text" id="crud_sku" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: ECH-DOT5">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Nome do Produto *</label>
                                <input type="text" id="crud_nome" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: Echo Dot 5¬™ Gera√ß√£o">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Categoria *</label>
                                <select id="crud_categoria" required
                                        class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Selecione...</option>
                                    <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                                    <option value="Inform√°tica">Inform√°tica</option>
                                    <option value="Casa e Cozinha">Casa e Cozinha</option>
                                    <option value="Esporte e Lazer">Esporte e Lazer</option>
                                    <option value="Moda e Acess√≥rios">Moda e Acess√≥rios</option>
                                    <option value="√Åudio">√Åudio</option>
                                    <option value="Games">Games</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Subcategoria *</label>
                                <input type="text" id="crud_subcategoria" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: Smart Home">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Fornecedor *</label>
                                <input type="text" id="crud_fornecedor" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: Amazon.com.br">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Quantidade *</label>
                                <input type="number" id="crud_quantidade" required min="0"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       placeholder="Ex: 10">
                            </div>
                        </div>
                    </div>

                    <!-- Precifica√ß√£o -->
                    <div class="bg-green-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-dollar-sign mr-2"></i>Precifica√ß√£o
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Custo Base (R$) *</label>
                                <input type="number" id="crud_custoBase" required min="0" step="0.01"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                       placeholder="Ex: 420.00"
                                       oninput="calcularPrecoVenda()">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Pre√ßo Mercado (R$) *</label>
                                <input type="number" id="crud_precoMercado" required min="0" step="0.01"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                       placeholder="Ex: 599.00">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Margem (%) *</label>
                                <input type="number" id="crud_margem" required min="0" max="100" step="0.1"
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                       placeholder="Ex: 30"
                                       oninput="calcularPrecoVenda()">
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-white rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-800">Pre√ßo de Venda Calculado:</span>
                                <span id="crud_precoVendaDisplay" class="text-2xl font-bold text-green-600">R$ 0,00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Imagem e Descri√ß√£o -->
                    <div class="bg-purple-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-image mr-2"></i>Imagem e Descri√ß√£o
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">URL da Imagem *</label>
                                <input type="url" id="crud_imagem" required
                                       class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                       placeholder="https://m.media-amazon.com/images/I/..."
                                       oninput="previewImage()">
                                <p class="text-xs text-gray-500 mt-1">Cole a URL completa da imagem do produto (preferencialmente Amazon CDN)</p>
                            </div>
                            <div id="imagePreview" class="hidden">
                                <img id="previewImg" src="" alt="Preview" class="w-32 h-32 object-contain border-2 border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Descri√ß√£o *</label>
                                <textarea id="crud_descricao" required rows="3"
                                          class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                          placeholder="Descreva o produto com seus principais recursos..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Especifica√ß√µes (Opcional) -->
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-list mr-2"></i>Especifica√ß√µes T√©cnicas (Opcional)
                        </h3>
                        <div id="especificacoesContainer" class="space-y-2">
                            <!-- Campos din√¢micos ser√£o adicionados aqui -->
                        </div>
                        <button type="button" onclick="addEspecificacao()" 
                                class="mt-3 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-plus mr-2"></i>Adicionar Especifica√ß√£o
                        </button>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div class="flex gap-4 pt-4 border-t-2">
                        <button type="submit" 
                                class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-lg hover:shadow-xl transition">
                            <i class="fas fa-save mr-2"></i><span id="crudSubmitText">Salvar Produto</span>
                        </button>
                        <button type="button" onclick="closeCrudModal()" 
                                class="px-6 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Load Products Data -->
    <script src="produtos-v6.0.js"></script>

    <!-- Main Application Script -->
    <script>
        // Global State
        let currentTab = 'dashboard';
        let allProducts = [];
        let charts = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            initializeFilters();
            renderDashboard();
            renderSugestoes();
            renderCatalogo();
            renderAnalise();
            updateStats();
        });

        // Load Products
        function loadProducts() {
            allProducts = [...produtosPlanilha, ...produtosSugeridos];
            console.log('Produtos carregados:', allProducts.length);
        }

        // ============================================
        // FORMATA√á√ÉO DE PRE√áOS (Padr√£o BR: R$ 1.000,33)
        // ============================================
        function formatarPreco(valor) {
            if (typeof valor !== 'number') valor = parseFloat(valor);
            return valor.toLocaleString('pt-BR', { 
                style: 'currency', 
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // ============================================
        // CRUD - GERENCIAMENTO DE PRODUTOS
        // ============================================
        let currentCrudMode = 'create'; // 'create' or 'edit'
        let currentEditingProductId = null;

        // Abrir modal CRUD
        function openCrudModal(mode, productId = null) {
            currentCrudMode = mode;
            currentEditingProductId = productId;
            
            const modal = document.getElementById('crudModal');
            const title = document.getElementById('crudModalTitle');
            const submitText = document.getElementById('crudSubmitText');
            
            if (mode === 'create') {
                title.innerHTML = '<i class="fas fa-plus text-green-600 mr-2"></i>Adicionar Novo Produto';
                submitText.textContent = 'Salvar Produto';
                limparFormularioCrud();
            } else if (mode === 'edit') {
                title.innerHTML = '<i class="fas fa-edit text-blue-600 mr-2"></i>Editar Produto';
                submitText.textContent = 'Atualizar Produto';
                preencherFormularioCrud(productId);
            }
            
            modal.classList.add('active');
        }

        // Fechar modal CRUD
        function closeCrudModal() {
            document.getElementById('crudModal').classList.remove('active');
            limparFormularioCrud();
            currentEditingProductId = null;
        }

        // Limpar formul√°rio
        function limparFormularioCrud() {
            document.getElementById('crudForm').reset();
            document.getElementById('especificacoesContainer').innerHTML = '';
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('crud_precoVendaDisplay').textContent = 'R$ 0,00';
        }

        // Preencher formul√°rio para edi√ß√£o
        function preencherFormularioCrud(productId) {
            const produto = allProducts.find(p => p.id === productId);
            if (!produto) return;

            document.getElementById('crud_sku').value = produto.sku || '';
            document.getElementById('crud_nome').value = produto.nome || '';
            document.getElementById('crud_categoria').value = produto.categoria || '';
            document.getElementById('crud_subcategoria').value = produto.subcategoria || '';
            document.getElementById('crud_fornecedor').value = produto.fornecedor || '';
            document.getElementById('crud_quantidade').value = produto.quantidade || 0;
            document.getElementById('crud_custoBase').value = produto.custoBase || 0;
            document.getElementById('crud_precoMercado').value = produto.precoMercado || 0;
            document.getElementById('crud_margem').value = produto.margem || 0;
            document.getElementById('crud_imagem').value = produto.imagem || '';
            document.getElementById('crud_descricao').value = produto.descricao || '';

            // Preview imagem
            if (produto.imagem) {
                document.getElementById('previewImg').src = produto.imagem;
                document.getElementById('imagePreview').classList.remove('hidden');
            }

            // Carregar especifica√ß√µes
            const container = document.getElementById('especificacoesContainer');
            container.innerHTML = '';
            if (produto.especificacoes) {
                Object.entries(produto.especificacoes).forEach(([key, value]) => {
                    addEspecificacao(key, value);
                });
            }

            calcularPrecoVenda();
        }

        // Calcular pre√ßo de venda
        function calcularPrecoVenda() {
            const custoBase = parseFloat(document.getElementById('crud_custoBase').value) || 0;
            const margem = parseFloat(document.getElementById('crud_margem').value) || 0;
            const precoVenda = custoBase * (1 + margem / 100);
            document.getElementById('crud_precoVendaDisplay').textContent = formatarPreco(precoVenda);
        }

        // Preview de imagem
        function previewImage() {
            const url = document.getElementById('crud_imagem').value;
            if (url) {
                document.getElementById('previewImg').src = url;
                document.getElementById('imagePreview').classList.remove('hidden');
            } else {
                document.getElementById('imagePreview').classList.add('hidden');
            }
        }

        // Adicionar campo de especifica√ß√£o
        function addEspecificacao(key = '', value = '') {
            const container = document.getElementById('especificacoesContainer');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'flex gap-2';
            div.innerHTML = `
                <input type="text" placeholder="Nome (ex: marca)" value="${key}"
                       class="flex-1 px-3 py-2 border rounded-lg spec-key" />
                <input type="text" placeholder="Valor (ex: Samsung)" value="${value}"
                       class="flex-1 px-3 py-2 border rounded-lg spec-value" />
                <button type="button" onclick="this.parentElement.remove()" 
                        class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
        }

        // Submeter formul√°rio CRUD
        document.getElementById('crudForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const custoBase = parseFloat(document.getElementById('crud_custoBase').value);
            const margem = parseFloat(document.getElementById('crud_margem').value);
            const precoVenda = custoBase * (1 + margem / 100);

            // Coletar especifica√ß√µes
            const especificacoes = {};
            document.querySelectorAll('#especificacoesContainer > div').forEach(div => {
                const key = div.querySelector('.spec-key').value.trim();
                const value = div.querySelector('.spec-value').value.trim();
                if (key && value) {
                    especificacoes[key] = value;
                }
            });

            const produtoData = {
                sku: document.getElementById('crud_sku').value,
                nome: document.getElementById('crud_nome').value,
                categoria: document.getElementById('crud_categoria').value,
                subcategoria: document.getElementById('crud_subcategoria').value,
                fornecedor: document.getElementById('crud_fornecedor').value,
                quantidade: parseInt(document.getElementById('crud_quantidade').value),
                custoBase: custoBase,
                precoMercado: parseFloat(document.getElementById('crud_precoMercado').value),
                margem: margem,
                precoVenda: precoVenda,
                imagem: document.getElementById('crud_imagem').value,
                descricao: document.getElementById('crud_descricao').value,
                especificacoes: Object.keys(especificacoes).length > 0 ? especificacoes : null,
                estoque: "Para Compra"
            };

            if (currentCrudMode === 'create') {
                // Criar novo produto
                const newId = Math.max(...allProducts.map(p => p.id)) + 1;
                produtoData.id = newId;
                produtoData.badge = "NOVO 2025";
                
                produtosSugeridos.push(produtoData);
                allProducts.push(produtoData);
                
                showNotification('‚úÖ Produto adicionado com sucesso!', 'success');
            } else if (currentCrudMode === 'edit') {
                // Atualizar produto existente
                const index = allProducts.findIndex(p => p.id === currentEditingProductId);
                if (index !== -1) {
                    produtoData.id = currentEditingProductId;
                    produtoData.badge = allProducts[index].badge; // Manter badge original
                    allProducts[index] = { ...allProducts[index], ...produtoData };
                    
                    // Atualizar tamb√©m no array original
                    const sugIndex = produtosSugeridos.findIndex(p => p.id === currentEditingProductId);
                    if (sugIndex !== -1) {
                        produtosSugeridos[sugIndex] = allProducts[index];
                    } else {
                        const planIndex = produtosPlanilha.findIndex(p => p.id === currentEditingProductId);
                        if (planIndex !== -1) {
                            produtosPlanilha[planIndex] = allProducts[index];
                        }
                    }
                    
                    showNotification('‚úÖ Produto atualizado com sucesso!', 'success');
                }
            }

            // Atualizar displays
            renderDashboard();
            renderSugestoes();
            renderCatalogo();
            renderAnalise();
            updateStats();

            closeCrudModal();
        });

        // Deletar produto
        function deletarProduto(productId) {
            const produto = allProducts.find(p => p.id === productId);
            if (!produto) return;

            if (confirm(`‚ö†Ô∏è Tem certeza que deseja deletar o produto:\n\n"${produto.nome}"\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                // Remover de allProducts
                const indexAll = allProducts.findIndex(p => p.id === productId);
                if (indexAll !== -1) {
                    allProducts.splice(indexAll, 1);
                }

                // Remover do array original
                const sugIndex = produtosSugeridos.findIndex(p => p.id === productId);
                if (sugIndex !== -1) {
                    produtosSugeridos.splice(sugIndex, 1);
                } else {
                    const planIndex = produtosPlanilha.findIndex(p => p.id === productId);
                    if (planIndex !== -1) {
                        produtosPlanilha.splice(planIndex, 1);
                    }
                }

                showNotification('üóëÔ∏è Produto deletado com sucesso!', 'success');

                // Atualizar displays
                renderDashboard();
                renderSugestoes();
                renderCatalogo();
                renderAnalise();
                updateStats();

                // Fechar modal se estiver aberto
                closeModal();
            }
        }

        // Click fora do modal CRUD para fechar
        document.getElementById('crudModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCrudModal();
            }
        });

        // Tab Switching
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            document.getElementById('tab-' + tabName).classList.remove('tab-inactive');
            document.getElementById('tab-' + tabName).classList.add('tab-active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById('content-' + tabName).classList.remove('hidden');
        }

        // Initialize Filters
        function initializeFilters() {
            // Get unique categories
            const categories = [...new Set(allProducts.map(p => p.categoria))];
            const subcategories = [...new Set(allProducts.map(p => p.subcategoria))];
            
            // Populate category filters
            const categorySelects = ['filterCategory', 'filterCatalogoCategory'];
            categorySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            });
            
            // Populate subcategory filter
            const subcategorySelect = document.getElementById('filterSubcategory');
            subcategories.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subcategorySelect.appendChild(option);
            });

            // Add event listeners
            document.getElementById('searchDashboard').addEventListener('input', renderDashboard);
            document.getElementById('filterCategory').addEventListener('change', renderDashboard);
            document.getElementById('searchSugestoes').addEventListener('input', renderSugestoes);
            document.getElementById('filterSubcategory').addEventListener('change', renderSugestoes);
            document.getElementById('filterNovos').addEventListener('change', renderSugestoes);
            document.getElementById('searchCatalogo').addEventListener('input', renderCatalogo);
            document.getElementById('filterCatalogoCategory').addEventListener('change', renderCatalogo);
            document.getElementById('sortCatalogo').addEventListener('change', renderCatalogo);
        }

        // Update Stats
        function updateStats() {
            const totalBudget = allProducts.reduce((sum, p) => sum + (p.custoBase * p.quantidade), 0);
            document.getElementById('totalBudget').textContent = formatarPreco(totalBudget);
            document.getElementById('totalProducts').textContent = allProducts.length;
            
            document.getElementById('stat-total').textContent = allProducts.length;
            document.getElementById('stat-planilha').textContent = produtosPlanilha.length;
            document.getElementById('stat-sugestoes').textContent = produtosSugeridos.length;
            
            const uniqueSubcategories = [...new Set(allProducts.map(p => p.subcategoria))];
            document.getElementById('stat-categorias').textContent = uniqueSubcategories.length;
        }

        // Render Dashboard
        function renderDashboard() {
            const search = document.getElementById('searchDashboard').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;
            
            let filtered = allProducts.filter(p => {
                const matchSearch = p.nome.toLowerCase().includes(search) || 
                                   p.sku.toLowerCase().includes(search);
                const matchCategory = !categoryFilter || p.categoria === categoryFilter;
                return matchSearch && matchCategory;
            });

            const container = document.getElementById('dashboardProductsList');
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">Nenhum produto encontrado</p>';
                return;
            }

            let html = `
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">SKU</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Produto</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Categoria</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Qtd</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Custo</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Venda</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Margem</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
            `;

            filtered.forEach(produto => {
                const badge = produto.badge ? `<span class="ml-2 text-xs px-2 py-1 bg-red-100 text-red-600 rounded-full">${produto.badge}</span>` : '';
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-mono">${produto.sku}</td>
                        <td class="px-4 py-3 text-sm font-medium">${produto.nome}${badge}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${produto.subcategoria}</td>
                        <td class="px-4 py-3 text-sm text-right">${produto.quantidade}</td>
                        <td class="px-4 py-3 text-sm text-right">${formatarPreco(produto.custoBase)}</td>
                        <td class="px-4 py-3 text-sm text-right font-semibold">${formatarPreco(produto.precoVenda)}</td>
                        <td class="px-4 py-3 text-sm text-right">
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                                ${produto.margem}%
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="showProductModal(${produto.id})" 
                                    class="text-purple-600 hover:text-purple-800 font-semibold text-sm">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            
            // Update charts
            updateCategoryChart();
            updatePriceChart();
        }

        // Render Sugest√µes
        function renderSugestoes() {
            const search = document.getElementById('searchSugestoes').value.toLowerCase();
            const subcategoryFilter = document.getElementById('filterSubcategory').value;
            const novosOnly = document.getElementById('filterNovos').checked;
            
            let filtered = produtosSugeridos.filter(p => {
                const matchSearch = p.nome.toLowerCase().includes(search) || 
                                   p.sku.toLowerCase().includes(search);
                const matchSubcategory = !subcategoryFilter || p.subcategoria === subcategoryFilter;
                const matchNovos = !novosOnly || (p.badge && p.badge.includes('NOVO'));
                return matchSearch && matchSubcategory && matchNovos;
            });

            const container = document.getElementById('sugestoesGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Nenhum produto encontrado</div>';
                return;
            }

            container.innerHTML = filtered.map(produto => `
                <div class="product-card glass-card rounded-xl shadow-lg overflow-hidden cursor-pointer" 
                     onclick="showProductModal(${produto.id})">
                    <div class="relative">
                        <img src="${produto.imagem}" alt="${produto.nome}" 
                             class="w-full h-48 object-contain bg-gray-50 p-4"
                             onerror="this.src='https://via.placeholder.com/300x300?text=Sem+Imagem'">
                        ${produto.badge ? `
                            <span class="absolute top-2 right-2 badge-novo px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">
                                ${produto.badge}
                            </span>
                        ` : ''}
                    </div>
                    <div class="p-4">
                        <div class="text-xs text-gray-500 mb-1">${produto.subcategoria}</div>
                        <h3 class="font-bold text-gray-800 mb-2 line-clamp-2 min-h-[3rem]">${produto.nome}</h3>
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">${produto.descricao}</p>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">Custo Base:</span>
                            <span class="font-semibold text-gray-700">R$ ${produto.custoBase.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-500">Pre√ßo Venda:</span>
                            <span class="font-bold text-purple-600 text-lg">R$ ${produto.precoVenda.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t">
                            <span class="text-sm">Margem: <span class="font-bold text-green-600">${produto.margem}%</span></span>
                            <span class="text-sm text-gray-500">Qtd: ${produto.quantidade}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render Cat√°logo
        function renderCatalogo() {
            const search = document.getElementById('searchCatalogo').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCatalogoCategory').value;
            const sortBy = document.getElementById('sortCatalogo').value;
            
            let filtered = allProducts.filter(p => {
                const matchSearch = p.nome.toLowerCase().includes(search);
                const matchCategory = !categoryFilter || p.categoria === categoryFilter;
                return matchSearch && matchCategory;
            });

            // Sort
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'nome':
                        return a.nome.localeCompare(b.nome);
                    case 'preco-asc':
                        return a.precoVenda - b.precoVenda;
                    case 'preco-desc':
                        return b.precoVenda - a.precoVenda;
                    case 'margem-desc':
                        return b.margem - a.margem;
                    default:
                        return 0;
                }
            });

            const container = document.getElementById('catalogoGrid');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Nenhum produto encontrado</div>';
                return;
            }

            container.innerHTML = filtered.map(produto => `
                <div class="product-card glass-card rounded-xl shadow-lg overflow-hidden cursor-pointer" 
                     onclick="showProductModal(${produto.id})">
                    <div class="relative">
                        <img src="${produto.imagem}" alt="${produto.nome}" 
                             class="w-full h-40 object-contain bg-gray-50 p-3"
                             onerror="this.src='https://via.placeholder.com/300x300?text=Sem+Imagem'">
                        ${produto.badge ? `
                            <span class="absolute top-2 right-2 px-2 py-1 bg-red-500 text-white text-xs font-bold rounded-full">
                                ${produto.badge}
                            </span>
                        ` : ''}
                    </div>
                    <div class="p-3">
                        <div class="text-xs text-gray-500 mb-1">${produto.subcategoria}</div>
                        <h3 class="font-bold text-sm text-gray-800 mb-2 line-clamp-2 min-h-[2.5rem]">${produto.nome}</h3>
                        <div class="text-center pt-2 border-t">
                            <div class="text-xl font-bold text-blue-600">${formatarPreco(produto.precoVenda)}</div>
                            <div class="text-xs text-gray-500 mt-1">Margem ${produto.margem}%</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render An√°lise
        function renderAnalise() {
            // Top 10 por Margem
            const topMargem = [...allProducts]
                .sort((a, b) => b.margem - a.margem)
                .slice(0, 10);
            
            document.getElementById('topMargemList').innerHTML = topMargem.map((p, i) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl font-bold text-purple-600">${i + 1}</span>
                        <div>
                            <div class="font-semibold text-sm">${p.nome.substring(0, 40)}...</div>
                            <div class="text-xs text-gray-500">${p.subcategoria}</div>
                        </div>
                    </div>
                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold">
                        ${p.margem}%
                    </span>
                </div>
            `).join('');

            // Stock Analysis
            const totalEstoque = allProducts.reduce((sum, p) => sum + p.quantidade, 0);
            const estoqueValor = allProducts.reduce((sum, p) => sum + (p.custoBase * p.quantidade), 0);
            const baixoEstoque = allProducts.filter(p => p.quantidade < 10).length;
            
            document.getElementById('stockAnalysis').innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="text-sm text-gray-600">Total em Estoque</div>
                        <div class="text-2xl font-bold text-blue-600">${totalEstoque} unidades</div>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <div class="text-sm text-gray-600">Valor do Estoque</div>
                        <div class="text-2xl font-bold text-green-600">R$ ${estoqueValor.toLocaleString('pt-BR')}</div>
                    </div>
                    <div class="p-4 bg-orange-50 rounded-lg">
                        <div class="text-sm text-gray-600">Baixo Estoque (< 10)</div>
                        <div class="text-2xl font-bold text-orange-600">${baixoEstoque} produtos</div>
                    </div>
                </div>
            `;

            // Update charts
            updateMargemChart();
            updateCategoryPerformance();
        }

        // Show Product Modal
        function showProductModal(productId) {
            const produto = allProducts.find(p => p.id === productId);
            if (!produto) return;

            const modal = document.getElementById('productModal');
            const content = document.getElementById('modalProductContent');
            
            const lucro = produto.precoVenda - produto.custoBase;
            const lucroPercentual = ((lucro / produto.custoBase) * 100).toFixed(1);
            
            content.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">${produto.nome}</h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img src="${produto.imagem}" alt="${produto.nome}" 
                             class="w-full rounded-lg shadow-lg"
                             onerror="this.src='https://via.placeholder.com/400x400?text=Sem+Imagem'">
                        ${produto.badge ? `
                            <div class="mt-4 text-center">
                                <span class="inline-block px-4 py-2 bg-red-500 text-white font-bold rounded-full">
                                    ${produto.badge}
                                </span>
                            </div>
                        ` : ''}
                    </div>

                    <div>
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Informa√ß√µes Gerais</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">SKU:</span>
                                    <span class="font-mono font-semibold">${produto.sku}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Categoria:</span>
                                    <span class="font-semibold">${produto.categoria}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Subcategoria:</span>
                                    <span class="font-semibold">${produto.subcategoria}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Fornecedor:</span>
                                    <span class="font-semibold">${produto.fornecedor}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Quantidade:</span>
                                    <span class="font-semibold text-blue-600">${produto.quantidade} unidades</span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">Precifica√ß√£o</h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Custo Base:</span>
                                    <span class="font-semibold">${formatarPreco(produto.custoBase)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Pre√ßo Mercado:</span>
                                    <span class="font-semibold">${formatarPreco(produto.precoMercado)}</span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-gray-800 font-bold">Pre√ßo Venda:</span>
                                    <span class="text-xl font-bold text-purple-600">${formatarPreco(produto.precoVenda)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Lucro Unit√°rio:</span>
                                    <span class="font-bold text-green-600">${formatarPreco(lucro)} (${lucroPercentual}%)</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Margem:</span>
                                    <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full font-bold">
                                        ${produto.margem}%
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Bot√£o Editar Margem -->
                            <div class="mt-4">
                                <button onclick="openMargemEditor(${produto.id})" 
                                        class="w-full px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold rounded-lg hover:shadow-lg transition">
                                    <i class="fas fa-edit mr-2"></i>Editar Margem
                                </button>
                            </div>
                        </div>

                        ${produto.especificacoes ? `
                            <div class="mb-6">
                                <h3 class="text-lg font-bold text-gray-800 mb-2">Especifica√ß√µes</h3>
                                <div class="space-y-1 text-sm">
                                    ${Object.entries(produto.especificacoes).map(([key, value]) => `
                                        <div class="flex justify-between">
                                            <span class="text-gray-600 capitalize">${key}:</span>
                                            <span class="font-semibold">${value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Descri√ß√£o</h3>
                            <p class="text-gray-600 text-sm leading-relaxed">${produto.descricao}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-bold text-gray-800 mb-2">Proje√ß√£o de Vendas</h3>
                    <div class="grid grid-cols-3 gap-4 text-center text-sm">
                        <div>
                            <div class="text-gray-600">Investimento Total</div>
                            <div class="text-xl font-bold text-gray-800">${formatarPreco(produto.custoBase * produto.quantidade)}</div>
                        </div>
                        <div>
                            <div class="text-gray-600">Receita Potencial</div>
                            <div class="text-xl font-bold text-blue-600">${formatarPreco(produto.precoVenda * produto.quantidade)}</div>
                        </div>
                        <div>
                            <div class="text-gray-600">Lucro Total</div>
                            <div class="text-xl font-bold text-green-600">${formatarPreco(lucro * produto.quantidade)}</div>
                        </div>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o CRUD -->
                <div class="mt-6 flex gap-4">
                    <button onclick="closeModal(); openCrudModal('edit', ${produto.id});" 
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold rounded-lg hover:shadow-xl transition">
                        <i class="fas fa-edit mr-2"></i>Editar Produto
                    </button>
                    <button onclick="deletarProduto(${produto.id})" 
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white font-bold rounded-lg hover:shadow-xl transition">
                        <i class="fas fa-trash mr-2"></i>Deletar Produto
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        // Click outside modal to close
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ===== EDITOR DE MARGEM =====
        
        let currentEditingProduct = null;

        function openMargemEditor(productId) {
            currentEditingProduct = allProducts.find(p => p.id === productId);
            if (!currentEditingProduct) return;

            const modal = document.getElementById('margemModal');
            const content = document.getElementById('margemEditorContent');
            
            const margemAtual = currentEditingProduct.margem || 30;
            const custoBase = currentEditingProduct.custoBase;
            const precoMercado = currentEditingProduct.precoMercado;
            
            content.innerHTML = `
                <div class="mb-6">
                    <h3 class="font-bold text-lg text-gray-800 mb-2">${currentEditingProduct.nome}</h3>
                    <p class="text-sm text-gray-600">SKU: ${currentEditingProduct.sku}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Custo Base</div>
                        <div class="text-2xl font-bold text-gray-800">R$ ${custoBase.toFixed(2)}</div>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Pre√ßo Mercado</div>
                        <div class="text-2xl font-bold text-gray-800">R$ ${precoMercado.toFixed(2)}</div>
                    </div>
                </div>

                <div class="mb-6 p-6 bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg border-2 border-purple-200">
                    <label class="block text-sm font-bold text-gray-700 mb-3">
                        <i class="fas fa-sliders-h mr-2"></i>Margem de Lucro (%)
                    </label>
                    
                    <div class="flex items-center gap-4 mb-4">
                        <input type="range" id="margemSlider" 
                               min="0" max="100" step="0.5" value="${margemAtual}"
                               class="flex-1 h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                               oninput="updateMargemPreview(this.value)">
                        
                        <input type="number" id="margemInput" 
                               value="${margemAtual}" 
                               min="0" max="100" step="0.5"
                               class="w-24 px-3 py-2 border-2 border-purple-300 rounded-lg text-center font-bold text-lg focus:ring-2 focus:ring-purple-500"
                               oninput="updateMargemFromInput(this.value)">
                        <span class="text-xl font-bold text-purple-600">%</span>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <button onclick="setMargem(20)" class="px-3 py-1 bg-white border border-purple-300 rounded text-sm hover:bg-purple-100">20%</button>
                        <button onclick="setMargem(25)" class="px-3 py-1 bg-white border border-purple-300 rounded text-sm hover:bg-purple-100">25%</button>
                        <button onclick="setMargem(30)" class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">30% (Padr√£o)</button>
                        <button onclick="setMargem(35)" class="px-3 py-1 bg-white border border-purple-300 rounded text-sm hover:bg-purple-100">35%</button>
                        <button onclick="setMargem(40)" class="px-3 py-1 bg-white border border-purple-300 rounded text-sm hover:bg-purple-100">40%</button>
                    </div>
                </div>

                <div class="mb-6 p-6 bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg border-2 border-green-300">
                    <h4 class="font-bold text-lg text-gray-800 mb-4">
                        <i class="fas fa-calculator mr-2 text-green-600"></i>
                        C√°lculo Autom√°tico
                    </h4>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Custo Base:</span>
                            <span class="font-bold text-gray-800">${formatarPreco(custoBase)}</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Margem Aplicada:</span>
                            <span id="margemDisplay" class="font-bold text-purple-600">${margemAtual}%</span>
                        </div>
                        
                        <div class="flex justify-between items-center pt-3 border-t-2 border-green-200">
                            <span class="text-lg font-bold text-gray-800">Pre√ßo de Venda:</span>
                            <span id="precoVendaDisplay" class="text-3xl font-bold text-green-600">
                                ${formatarPreco(custoBase * (1 + margemAtual/100))}
                            </span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Lucro Unit√°rio:</span>
                            <span id="lucroDisplay" class="font-bold text-green-700">
                                ${formatarPreco(custoBase * (margemAtual/100))}
                            </span>
                        </div>

                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Lucro Total (${currentEditingProduct.quantidade} un):</span>
                            <span id="lucroTotalDisplay" class="font-bold text-green-700">
                                ${formatarPreco(custoBase * (margemAtual/100) * currentEditingProduct.quantidade)}
                            </span>
                        </div>

                        <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                            <div class="text-xs text-gray-600 mb-1">Economia vs Mercado:</div>
                            <div id="economiaDisplay" class="text-sm font-bold">
                                ${calcularEconomia(custoBase, margemAtual, precoMercado)}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="salvarMargem()" 
                            class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-lg hover:shadow-xl transition">
                        <i class="fas fa-save mr-2"></i>Salvar Margem
                    </button>
                    <button onclick="closeMargemModal()" 
                            class="px-6 py-3 bg-gray-200 text-gray-700 font-bold rounded-lg hover:bg-gray-300 transition">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                </div>

                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <p class="text-xs text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>Nota:</strong> A altera√ß√£o da margem ser√° salva localmente e aplicada a todos os sistemas (Admin e Cliente).
                        O cliente ver√° apenas o pre√ßo final com a margem aplicada, sem visualizar o percentual de lucro.
                    </p>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function updateMargemPreview(valor) {
            const margem = parseFloat(valor);
            document.getElementById('margemInput').value = margem.toFixed(1);
            recalcularPrecos(margem);
        }

        function updateMargemFromInput(valor) {
            const margem = parseFloat(valor);
            if (margem >= 0 && margem <= 100) {
                document.getElementById('margemSlider').value = margem;
                recalcularPrecos(margem);
            }
        }

        function setMargem(valor) {
            document.getElementById('margemSlider').value = valor;
            document.getElementById('margemInput').value = valor;
            recalcularPrecos(valor);
        }

        function recalcularPrecos(margem) {
            if (!currentEditingProduct) return;
            
            const custoBase = currentEditingProduct.custoBase;
            const quantidade = currentEditingProduct.quantidade;
            const precoMercado = currentEditingProduct.precoMercado;
            
            const precoVenda = custoBase * (1 + margem/100);
            const lucro = custoBase * (margem/100);
            const lucroTotal = lucro * quantidade;
            
            document.getElementById('margemDisplay').textContent = margem.toFixed(1) + '%';
            document.getElementById('precoVendaDisplay').textContent = formatarPreco(precoVenda);
            document.getElementById('lucroDisplay').textContent = formatarPreco(lucro);
            document.getElementById('lucroTotalDisplay').textContent = formatarPreco(lucroTotal);
            document.getElementById('economiaDisplay').innerHTML = calcularEconomia(custoBase, margem, precoMercado);
        }

        function calcularEconomia(custoBase, margem, precoMercado) {
            const precoVenda = custoBase * (1 + margem/100);
            const economia = precoMercado - precoVenda;
            const economiaPercent = ((economia / precoMercado) * 100).toFixed(1);
            
            if (economia > 0) {
                return `<span class="text-green-600">Cliente economiza ${formatarPreco(economia)} (${economiaPercent}%)</span>`;
            } else if (economia < 0) {
                return `<span class="text-red-600">‚ö†Ô∏è Pre√ßo acima do mercado em ${formatarPreco(Math.abs(economia))}</span>`;
            } else {
                return `<span class="text-gray-600">Mesmo pre√ßo do mercado</span>`;
            }
        }

        function salvarMargem() {
            if (!currentEditingProduct) return;
            
            const novaMargem = parseFloat(document.getElementById('margemInput').value);
            
            if (novaMargem < 0 || novaMargem > 100) {
                alert('Margem deve estar entre 0% e 100%');
                return;
            }
            
            // Atualizar o produto no array
            const produto = allProducts.find(p => p.id === currentEditingProduct.id);
            if (produto) {
                produto.margem = novaMargem;
                produto.precoVenda = produto.custoBase * (1 + novaMargem/100);
                
                // Salvar no localStorage
                salvarMargemNoStorage(produto.id, novaMargem, produto.precoVenda);
                
                // Feedback visual
                showNotification('Margem atualizada com sucesso!', 'success');
                
                // Atualizar displays
                updateStats();
                
                // Fechar modals e reabrir o modal do produto atualizado
                closeMargemModal();
                setTimeout(() => {
                    showProductModal(produto.id);
                }, 300);
            }
        }

        function salvarMargemNoStorage(productId, margem, precoVenda) {
            let margens = JSON.parse(localStorage.getItem('margensProdutos') || '{}');
            margens[productId] = {
                margem: margem,
                precoVenda: precoVenda,
                dataAtualizacao: new Date().toISOString()
            };
            localStorage.setItem('margensProdutos', JSON.stringify(margens));
        }

        function carregarMargensDoStorage() {
            const margens = JSON.parse(localStorage.getItem('margensProdutos') || '{}');
            
            Object.keys(margens).forEach(productId => {
                const produto = allProducts.find(p => p.id === parseInt(productId));
                if (produto) {
                    produto.margem = margens[productId].margem;
                    produto.precoVenda = margens[productId].precoVenda;
                }
            });
        }

        function closeMargemModal() {
            document.getElementById('margemModal').classList.remove('active');
            currentEditingProduct = null;
        }

        // Click outside to close margem modal
        document.getElementById('margemModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMargemModal();
            }
        });

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-xl text-white font-semibold transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Carregar margens salvas ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                carregarMargensDoStorage();
                updateStats();
            }, 100);
        });

        // Charts
        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;

            const subcategories = {};
            allProducts.forEach(p => {
                subcategories[p.subcategoria] = (subcategories[p.subcategoria] || 0) + 1;
            });

            const data = {
                labels: Object.keys(subcategories),
                datasets: [{
                    label: 'Quantidade de Produtos',
                    data: Object.values(subcategories),
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#4facfe',
                        '#43e97b', '#fa709a', '#fee140', '#30cfd0',
                        '#a8edea', '#fed6e3'
                    ]
                }]
            };

            if (charts.category) {
                charts.category.destroy();
            }

            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function updatePriceChart() {
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;

            const ranges = {
                '< R$ 500': 0,
                'R$ 500-1000': 0,
                'R$ 1000-2000': 0,
                'R$ 2000-5000': 0,
                '> R$ 5000': 0
            };

            allProducts.forEach(p => {
                if (p.precoVenda < 500) ranges['< R$ 500']++;
                else if (p.precoVenda < 1000) ranges['R$ 500-1000']++;
                else if (p.precoVenda < 2000) ranges['R$ 1000-2000']++;
                else if (p.precoVenda < 5000) ranges['R$ 2000-5000']++;
                else ranges['> R$ 5000']++;
            });

            if (charts.price) {
                charts.price.destroy();
            }

            charts.price = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'N√∫mero de Produtos',
                        data: Object.values(ranges),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 5
                            }
                        }
                    }
                }
            });
        }

        function updateMargemChart() {
            const ctx = document.getElementById('margemChart');
            if (!ctx) return;

            const ranges = {
                '< 20%': 0,
                '20-25%': 0,
                '25-30%': 0,
                '> 30%': 0
            };

            allProducts.forEach(p => {
                if (p.margem < 20) ranges['< 20%']++;
                else if (p.margem < 25) ranges['20-25%']++;
                else if (p.margem < 30) ranges['25-30%']++;
                else ranges['> 30%']++;
            });

            if (charts.margem) {
                charts.margem.destroy();
            }

            charts.margem = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(ranges),
                    datasets: [{
                        label: 'N√∫mero de Produtos',
                        data: Object.values(ranges),
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCategoryPerformance() {
            const subcategoryStats = {};
            
            allProducts.forEach(p => {
                if (!subcategoryStats[p.subcategoria]) {
                    subcategoryStats[p.subcategoria] = {
                        count: 0,
                        totalCusto: 0,
                        totalVenda: 0,
                        avgMargem: 0
                    };
                }
                
                const stats = subcategoryStats[p.subcategoria];
                stats.count++;
                stats.totalCusto += p.custoBase * p.quantidade;
                stats.totalVenda += p.precoVenda * p.quantidade;
                stats.avgMargem += p.margem;
            });

            // Calculate averages
            Object.keys(subcategoryStats).forEach(sub => {
                subcategoryStats[sub].avgMargem = (subcategoryStats[sub].avgMargem / subcategoryStats[sub].count).toFixed(1);
                subcategoryStats[sub].lucro = subcategoryStats[sub].totalVenda - subcategoryStats[sub].totalCusto;
            });

            // Sort by lucro
            const sorted = Object.entries(subcategoryStats)
                .sort((a, b) => b[1].lucro - a[1].lucro);

            const container = document.getElementById('categoryPerformance');
            container.innerHTML = `
                <table class="min-w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Subcategoria</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Produtos</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Investimento</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Receita</th>
                            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase">Lucro</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase">Margem M√©dia</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${sorted.map(([sub, stats]) => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm font-medium">${sub}</td>
                                <td class="px-4 py-3 text-sm text-center">${stats.count}</td>
                                <td class="px-4 py-3 text-sm text-right">R$ ${stats.totalCusto.toFixed(2)}</td>
                                <td class="px-4 py-3 text-sm text-right font-semibold text-blue-600">R$ ${stats.totalVenda.toFixed(2)}</td>
                                <td class="px-4 py-3 text-sm text-right font-bold text-green-600">R$ ${stats.lucro.toFixed(2)}</td>
                                <td class="px-4 py-3 text-center">
                                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                                        ${stats.avgMargem}%
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
    </script>
</body>
</html>
